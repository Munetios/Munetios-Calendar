<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Munetios Calendar</title>
    <meta
      name="description"
      content="A modern calendar application built with Munetios."
    />
    <meta
      name="keywords"
      content="Munetios, Calendar, Web Application, Modern UI"
    />
    <meta name="author" content="Munetios" />
    <meta property="og:title" content="Munetios Calendar" />
    <meta
      property="og:description"
      content="A modern calendar application built with Munetios."
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://calendar.munetios.com/new" />
    <meta property="og:image" content="android-chrome-512x512.png" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Munetios Calendar" />
    <meta
      name="twitter:description"
      content="A modern calendar application built with Munetios."
    />
    <meta name="twitter:image" content="android-chrome-512x512.png" />
    <link rel="canonical" href="https://calendar.munetios.com/new" />
    <link
      rel="stylesheet"
      href="https://api.munetios.com/beautiful-css/beautiful.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex:opsz,wght,ROND@6..144,1..1000,90&family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/new/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/new/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/new/favicon-16x16.png"
    />
    <link rel="manifest" href="/new/site.webmanifest" />
    <meta
      http-equiv="Content-Security-Policy"
      content="
        default-src 'self' https://calendar.munetios.com https://api.munetios.com;
        script-src 'self' https://calendar.munetios.com https://api.munetios.com 'nonce-IijhdEUFuhf43UF43hF';
        style-src 'self' https://fonts.googleapis.com https://api.munetios.com 'unsafe-inline';
        font-src 'self' https://fonts.gstatic.com https://fonts.googleapis.com;
        img-src 'self' data: https://calendar.munetios.com https://api.munetios.com;
        connect-src 'self' https://api.munetios.com;
        manifest-src 'self';
        object-src 'none';
        base-uri 'self';
        frame-src 'self' https://www.munetios.com https://tasks.munetios.com;
        frame-ancestors 'self';
    "
    />
    <script nonce="IijhdEUFuhf43UF43hF">
      document.addEventListener("DOMContentLoaded", function () {
        if (window.top !== window.self) {
          // Hide everything (html + body)
          document.documentElement.style.display = "none";
          // Optional: redirect out of iframe
          try {
            window.top.location = window.location;
          } catch (e) {}
        }
      });
    </script>
    <script nonce="IijhdEUFuhf43UF43hF">
      // Register sw.js
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function () {
          navigator.serviceWorker.register("/new/sw.js").then(
            function (registration) {
              console.log(
                "ServiceWorker registration successful with scope: ",
                registration.scope,
              );
            },
            function (err) {
              console.log("ServiceWorker registration failed: ", err);
            },
          );
        });
      }
    </script>
    <style>
      * {
        box-sizing: border-box;
      }
      body,
      button,
      input,
      select,
      textarea {
        font-family: "Google Sans Flex", "Google Sans", sans-serif;
        font-variation-settings:
          "wght" 480,
          "GRAD" 30,
          "ROND" 80,
          "opsz" 18;
      }
      ::-webkit-scrollbar {
        width: 20px;
        height: 12px;
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        border-radius: 10px;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.08),
          rgba(99, 0, 238, 0.18)
        );
        box-shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.18);
        backdrop-filter: blur(1.5px) saturate(180%) brightness(110%)
          contrast(105%);
        -webkit-backdrop-filter: blur(1.5px) saturate(180%) brightness(110%)
          contrast(105%);
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(
          to bottom,
          rgba(132, 0, 255, 0.25),
          rgba(99, 0, 238, 0.28)
        );
      }
      ::-webkit-scrollbar-corner {
        background: transparent;
      }

      /* Firefox */
      * {
        scrollbar-width: thin;
        scrollbar-color: rgba(99, 0, 238, 0.25) rgba(255, 255, 255, 0.05);
      }
      *::-webkit-scrollbar-track {
        background: transparent;
      }

      /* Edge/IE (fallback, limited support) */
      body,
      .sidebar,
      .calendar__content,
      .mini__calendar,
      .content {
        -ms-overflow-style: -ms-autohiding-scrollbar;
      }

      /* Liquid glass for scrollbars (for elements with .liquid-glass) */
      .liquid-glass::-webkit-scrollbar-thumb {
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.12),
          rgba(99, 0, 238, 0.22)
        );
        box-shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.22);
        backdrop-filter: blur(2px) saturate(180%) brightness(115%)
          contrast(110%);
        -webkit-backdrop-filter: blur(2px) saturate(180%) brightness(115%)
          contrast(110%);
        border: 1px solid rgba(255, 255, 255, 0.22);
      }
      .liquid-glass::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(
          to bottom,
          rgba(132, 0, 255, 0.32),
          rgba(99, 0, 238, 0.38)
        );
      }
      .app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        background-color: #160033 !important;
        color: white;
      }
      html,
      body {
        height: 100%;
        background-color: #160033 !important;
      }
      body {
        margin: 0;
      }
      munetios {
        /* Means DIV */
        display: block;
      }
      munetios-button {
        padding: 10px 20px;
        font-size: 16px;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.05),
          rgba(255, 255, 255, 0.1)
        );
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        backdrop-filter: blur(1.75px) saturate(180%) brightness(105%)
          contrast(100%);
        -webkit-backdrop-filter: blur(1.75px) saturate(200%) brightness(125%)
          contrast(100%);
        border-radius: 50px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        color: #ffffff;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
      munetios-button:hover {
        background-color: #3600b371 !important;
      }
      munetios-button .btn-primary {
        background-color: #6300eeaf !important;
        color: #ffffff;
      }
      munetios-button .btn-primary:hover {
        background: #8400ffd8 !important;
      }
      munetios-button .btn-secondary {
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.05),
          rgba(255, 255, 255, 0.1)
        );
        border: 1px solid rgba(131, 27, 216, 0.493) !important;
        color: #000000;
      }
      munetios-button .btn-secondary:hover {
        background: #d3b8ffb3 !important;
      }
      munetios-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
      }
      .disabled {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
      }
      [hidden] {
        display: none !important;
      }
      .topbar__header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        z-index: 1000;
        background-color: transparent;
        box-shadow: none;
        padding: 5px 10px;
        display: flex;
        align-items: center;
        height: 60px;
        justify-content: space-between;
      }
      .menu-knCjenC {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .menu-knCjenC:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .icon {
        font-size: 28px;
        font-family: "Material Symbols Rounded";
        color: #ffffff;
        cursor: pointer;
      }
      .today__date__topbar__left {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 0 15px;
        height: 50px;
        white-space: nowrap;
        font-size: 18px;
        color: #ffffff;
      }
      .topbar__header .topbar__left {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .calendar__arrows__switcher__buttons {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 0 10px;
        height: 50px;
      }
      .search__bar {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 0 15px;
        height: 50px;
        margin-left: 20px;
        margin-right: 20px;
        max-width: 800px;
        width: 100%;
        color: #ffffff;
        transition: width 0.3s ease;
      }
      .search__bar input {
        width: 100%;
        height: 30px;
        border: none;
        outline: none;
        background: transparent;
        color: #ffffff;
        font-size: 16px;
      }
      .topbar__centered {
        width: 100%;
        display: flex;
        justify-content: center;
      }
      .topbar__right {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 0 10px;
        height: 50px;
      }
      .view__text__calendar {
        font-size: 16px;
        color: #ffffff;
      }
      .topbar__right .icon {
        cursor: pointer;
      }
      .sidebar {
        position: fixed;
        top: 60px;
        left: 0;
        width: 280px;
        height: calc(100% - 60px);
        background-color: transparent;
        box-shadow: none;
        overflow-y: auto;
        padding: 10px;
        scrollbar-width: none; /* Chrome, Firefox and Edge and Opera */
        -ms-overflow-style: none; /* Internet Explorer 10+ */
        display: flex;
        flex-direction: column;
        gap: 15px;
        transition: left 0.3s ease;
      }
      .sidebar::-webkit-scrollbar {
        display: none; /* Safari */
      }
      .mini__calendar {
        width: 100%;
        margin: 7px auto;
        padding: 4px;
        height: auto;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.05),
          rgba(255, 255, 255, 0.1)
        );
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        backdrop-filter: blur(1.75px) saturate(180%) brightness(105%)
          contrast(100%);
        -webkit-backdrop-filter: blur(1.75px) saturate(200%) brightness(125%)
          contrast(100%);
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 17px;
      }
      .mini__calendar:hover {
        box-shadow: 0 12px 48px 0 rgba(31, 38, 135, 0.37);
      }
      .mini__calendar__arrows {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-left: auto;
        padding: 0 10px;
        height: 40px;
        white-space: nowrap;
        flex-wrap: nowrap;
        font-size: 20px;
        color: #ffffff;
        width: 100%;
      }
      .mini__calendar__arrows .icon {
        cursor: pointer;
        border-radius: 50%;
        width: 30px;
        height: 30px;
      }
      .mini__calendar__arrows .icon:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .mini__calendar__month-year {
        font-size: 18px;
        color: #ffffff;
        text-align: left;
      }
      .mini__calendar__days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        padding: 10px;
      }
      .mini__calendar__day {
        width: 100%;
        padding: 8px 0;
        text-align: center;
        border-radius: 10px;
        cursor: pointer;
        color: #ffffff;
      }
      .mini__calendar__day:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .mini__calendar__today {
        background: rgba(99, 0, 238, 0.548);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(2px) saturate(180%) brightness(105%)
          contrast(100%); /* Liquid Glass Effect. Blur 2px is good for performance */
        -webkit-backdrop-filter: blur(2px) saturate(200%) brightness(125%)
          contrast(100%);
        width: 100%;
        padding: 8px 0;
        text-align: center;
        border-radius: 10px;
        cursor: pointer;
        color: #ffffff;
      }
      #mini__calendar__today:hover {
        background: rgba(132, 0, 255, 0.7);
      }
      #mobileSearchIcon {
        display: none;
      }
      @media (max-width: 1220px) {
        .search__bar {
          margin-left: 5px;
          margin-right: 5px;
        }
      }
      @media (max-width: 1025px) {
        .sidebar {
          left: -300px;
          z-index: 1000;
        }
        .content {
          margin-left: 0 !important;
          width: 100% !important;
        }
      }
      @media (max-width: 1074px) {
        .search__bar {
          display: none;
        }
        #mobileSearchIcon {
          display: block;
        }
      }
      @media (max-width: 940px) {
        #todayBtn {
          display: none;
        }
      }
      @media (max-width: 850px) {
        .today__date__topbar__left .icon {
          display: none;
        }
      }
      @media (max-width: 768px) {
        .calendar__arrows__switcher__buttons {
          display: none;
        }
      }
      @media (max-width: 668px) {
        #appsBtn,
        #helpBtn {
          display: none;
        }
        #moreBtn {
          display: block !important;
        }
      }
      @media (max-width: 622px) {
        #settingsBtn,
        #helpBtn {
          display: block;
        }
        .today__date__topbar__left {
          display: none;
        }
      }
      @media (max-width: 380px) {
        #helpBtn,
        #settingsBtn {
          display: none;
        }
      }
      #moreBtn {
        display: none;
      }
      munetios-dropdown-menu {
        position: fixed;
        top: 60px;
        right: 10px;
        width: 200px;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.05),
          rgba(255, 255, 255, 0.1)
        );
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        backdrop-filter: blur(1.75px) saturate(180%) brightness(105%)
          contrast(100%);
        -webkit-backdrop-filter: blur(1.75px) saturate(200%) brightness(125%)
          contrast(100%);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        display: none;
        flex-direction: column;
        padding: 10px 0;
        z-index: 99999999;
      }
      munetios-dropdown-menu .dropdown-item {
        padding: 10px 20px;
        color: #ffffff;
        cursor: pointer;
      }
      munetios-dropdown-menu .dropdown-item:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      /* Custom Checkbox Styles */
      input[type="checkbox"] {
        appearance: none; /* Chrome, Edge and Opera */
        -webkit-appearance: none; /* For Safari */
        -moz-appearance: none; /* For Firefox */
        -ms-appearance: none; /* For IE and Edge legacy */
        width: 20px;
        height: 20px;
        border-radius: 64px;
        backdrop-filter: blur(2px) saturate(180%) brightness(105%)
          contrast(100%); /* Liquid Glass Effect. Blur 2px is good for performance */
        -webkit-backdrop-filter: blur(2px) saturate(200%) brightness(125%)
          contrast(100%);
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.1),
          rgba(255, 255, 255, 0.05)
        );
        border: 1px solid rgba(255, 255, 255, 0.3);
        outline: none;
        cursor: pointer;
        transition:
          border-color 0.2s,
          background 0.2s;
        vertical-align: middle;
        position: relative;
      }
      input[type="checkbox"]:checked {
        border-radius: 64px;
        backdrop-filter: blur(2px) saturate(180%) brightness(105%)
          contrast(100%); /* Liquid Glass Effect. Blur 2px is good for performance */
        -webkit-backdrop-filter: blur(2px) saturate(200%) brightness(125%)
          contrast(100%);
        background: rgba(99, 9, 216, 0.664);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      input[type="checkbox"]:checked::after {
        content: "";
        position: absolute;
        left: 5px;
        top: 2px;
        width: 6px;
        height: 12px;
        border: solid #fff;
        border-width: 0 3px 3px 0;
        transform: rotate(45deg);
        pointer-events: none;
      }
      input[type="checkbox"]:focus {
        box-shadow: 0 0 0 2px #a47cff55;
      }
      /* Optional: label spacing */
      .calendar__options__other__calendar label {
        margin-left: 8px;
        cursor: pointer;
        user-select: none;
      }
      .calendar__options__other__calendar {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .calendar__button__my__calendar {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 15px;
        cursor: pointer;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.05),
          rgba(255, 255, 255, 0.1)
        );
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        backdrop-filter: blur(1.75px) saturate(180%) brightness(105%)
          contrast(100%);
        -webkit-backdrop-filter: blur(1.75px) saturate(200%) brightness(125%)
          contrast(100%);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      .calendar__button__my__calendar:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .content {
        margin-top: 50px;
        padding: 20px;
        margin-left: 280px;
        flex: 1;
        width: calc(100% - 280px);
        transition:
          margin-left 0.3s ease,
          width 0.3s ease;
      }
      .page {
        display: none;
      }
      #calendarContent {
        display: block;
      }
      .tabs__bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        overflow-x: auto;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 20px;
        container-type: inline-size;
        container-name: tabs-bar;
      }
      .tabs__left {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .tab {
        padding: 10px 15px;
        cursor: pointer;
        border-radius: 670px;
        font-size: 16px;
        color: #ffffff;
      }
      .tab:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .tabs__right {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .tabs__right munetios-button {
        padding: 8px 12px;
        font-size: 14px;
      }
      .calendar__content {
        width: 100%;
        height: calc(100vh - 260px);
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.05),
          rgba(255, 255, 255, 0.1)
        );
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        backdrop-filter: blur(1.75px) saturate(180%) brightness(105%)
          contrast(100%);
        -webkit-backdrop-filter: blur(1.75px) saturate(200%) brightness(125%)
          contrast(100%);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        padding: 20px;
        overflow-y: auto;
      }
      @container tabs-bar (max-width: 860px) {
        .tabs__right .btn__right__text {
          display: none;
        }
      }
      .calendar__content__header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .calendar__dates__grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        vertical-align: middle;
        align-items: center;
        height: calc(100% - 60px);
        text-align: center;
      }
      .calendar__dates_button {
        width: 100%;
        padding: 10px 0;
        text-align: center;
        vertical-align: middle;
        border-radius: 10px;
        cursor: pointer;
        height: 100%;
        justify-content: center;
        align-items: center;
        color: #ffffff;
      }
      .calendar__dates_button:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      .calendar__dates__today {
        background: rgba(99, 0, 238, 0.548);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(2px) saturate(180%) brightness(105%)
          contrast(100%); /* Liquid Glass Effect. Blur 2px is good for performance */
        -webkit-backdrop-filter: blur(2px) saturate(200%) brightness(125%)
          contrast(100%);
        width: 100%;
        height: 100%;
        padding: 10px 0;
        text-align: center;
        border-radius: 10px;
        cursor: pointer;
        color: #ffffff;
      }
      .calendar__dates__today:hover {
        background: rgba(132, 0, 255, 0.7);
      }
      .search__wrapper {
        position: fixed;
        top: 60px;
        left: 0;
        width: 100%;
        padding: 10px 20px;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.05),
          rgba(255, 255, 255, 0.1)
        );
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        backdrop-filter: blur(1.75px) saturate(180%) brightness(105%)
          contrast(100%);
        -webkit-backdrop-filter: blur(1.75px) saturate(200%) brightness(125%)
          contrast(100%);
        border-bottom: 1px solid rgba(255, 255, 255, 0.18);
        display: none;
        z-index: 2500;
      }
      /* Custom Color Picker Styles */
      input[type="color"] {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.3);
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.08),
          rgba(99, 0, 238, 0.18)
        );
        box-shadow: 0 2px 8px 0 rgba(31, 38, 135, 0.18);
        cursor: pointer;
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
        padding: 0;
        outline: none;
        margin: 0 8px 0 0;
        vertical-align: middle;
        display: inline-block;
      }
      input[type="color"]:focus {
        border-color: #a47cff;
        box-shadow: 0 0 0 2px #a47cff55;
      }
      input[type="color"]::-webkit-color-swatch-wrapper {
        padding: 0;
        border-radius: 50%;
      }
      input[type="color"]::-webkit-color-swatch {
        border: none;
        border-radius: 50%;
      }
      input[type="color"]::-moz-color-swatch {
        border: none;
        border-radius: 50%;
      }
      input[type="color"]::-ms-color-swatch {
        border: none;
        border-radius: 50%;
      }
      /* Modal Styles */
      .modal {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 3000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        overflow: auto;
        background: rgba(22, 0, 51, 0.55);
        backdrop-filter: blur(2.5px) saturate(180%) brightness(110%)
          contrast(105%);
        -webkit-backdrop-filter: blur(2.5px) saturate(180%) brightness(110%)
          contrast(105%);
        align-items: center;
        justify-content: center;
        transition: opacity 0.2s;
      }
      .modal[style*="display: block"] {
        display: flex !important;
      }
      .modal__content {
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.08),
          rgba(99, 0, 238, 0.18)
        );
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        backdrop-filter: blur(2.5px) saturate(180%) brightness(110%)
          contrast(105%);
        -webkit-backdrop-filter: blur(2.5px) saturate(180%) brightness(110%)
          contrast(105%);
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        padding: 32px 28px 24px 28px;
        min-width: 320px;
        max-width: 95vw;
        width: 400px;
        color: #fff;
        position: relative;
        animation: modal-pop-in 0.18s cubic-bezier(0.4, 2, 0.6, 1) 1;
      }
      @keyframes modal-pop-in {
        0% {
          transform: scale(0.96) translateY(24px);
          opacity: 0;
        }
        100% {
          transform: scale(1) translateY(0);
          opacity: 1;
        }
      }
      .modal__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 18px;
      }
      .modal__header h2 {
        margin: 0;
        font-size: 1.35em;
        font-weight: 600;
        letter-spacing: 0.01em;
      }
      .modal__header .icon {
        font-size: 26px;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
      }
      .modal__header .icon:hover {
        opacity: 1;
        background: rgba(255, 255, 255, 0.13);
        border-radius: 50%;
      }
      .modal__body label {
        display: block;
        margin-top: 12px;
        margin-bottom: 4px;
        font-size: 1em;
        font-weight: 500;
        color: #ffe066;
      }
      .modal__body input[type="text"],
      .modal__body input[type="date"],
      .modal__body input[type="time"],
      .modal__body textarea {
        width: 100%;
        padding: 9px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.09);
        color: #fff;
        font-size: 1em;
        margin-bottom: 8px;
        outline: none;
        transition:
          border-color 0.2s,
          background 0.2s;
        box-sizing: border-box;
        resize: none;
      }
      .modal__body input[type="text"]:focus,
      .modal__body input[type="date"]:focus,
      .modal__body input[type="time"]:focus,
      .modal__body textarea:focus {
        border-color: #a47cff;
        background: rgba(99, 0, 238, 0.13);
      }
      .modal__body textarea {
        min-height: 60px;
        max-height: 180px;
      }
      .modal__body input[type="color"] {
        margin-top: 6px;
        margin-bottom: 10px;
      }
      .modal__footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 18px;
      }
      @media (max-width: 768px) {
        .modal__content {
          width: 100% !important;
          max-width: 100% !important;
          height: 100%;
          border-radius: 0;
          box-sizing: border-box;
        }
      }
      /* Animations */
      @keyframes fade-in {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes fade-out {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }
      @keyframes slide-down {
        from {
          transform: translateY(-24px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      @keyframes slide-up {
        from {
          transform: translateY(24px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      @keyframes pop-in {
        0% {
          transform: scale(0.96);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      @keyframes pop-out {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        100% {
          transform: scale(0.96);
          opacity: 0;
        }
      }
      .munetios-toast {
        animation: fade-in 0.3s cubic-bezier(0.4, 2, 0.6, 1);
      }
      .modal__content {
        animation: pop-in 0.18s cubic-bezier(0.4, 2, 0.6, 1);
      }
      .dropdown-item {
        transition:
          background 0.18s,
          color 0.18s;
      }
      .dropdown-item:active {
        animation: fade-in 0.12s;
      }
      .calendar__dates_button,
      .calendar__dates__today,
      .mini__calendar__day,
      .mini__calendar__today {
        transition:
          background 0.18s,
          color 0.18s,
          box-shadow 0.18s;
      }
      .selected-date {
        animation: fade-in 0.18s;
      }
      .sidebar,
      .content {
        transition:
          margin-left 0.3s,
          width 0.3s,
          left 0.3s;
      }
      liquid-glass,
      .liquid-glass {
        transition:
          box-shadow 0.18s,
          background 0.18s;
      }
    </style>
  </head>
  <body>
    <munetios-dropdown-menu
      id="dropdownMenu"
      _ng-random
    ></munetios-dropdown-menu>
    <munetios class="app" _ng-random version="1.0">
      <div class="topbar__header" id="topbar" _ng-dcmeaicDn3>
        <div class="topbar__left" _ng-kdEkDkAklF>
          <munetios-menu-btn
            title="Hamburger"
            aria-label="Hamburger"
            class="menu-knCjenC liquid-glass"
            _ng-HFmwXkwnDke
            id="menu___btn"
          >
            <div class="icon">menu</div>
          </munetios-menu-btn>
          <div class="today__date__topbar__left liquid-glass" _ng-random>
            <div class="icon">calendar_today</div>
            <span id="todayDate" _ng-random></span>
          </div>
          <munetios-button
            title="Today"
            aria-label="Today"
            id="todayBtn"
            _ng-random
            >Today</munetios-button
          >
          <div class="calendar__arrows__switcher__buttons liquid-glass">
            <div
              id="previousMonth"
              title="Previous Month"
              aria-label="Previous Month"
              class="icon"
            >
              chevron_left
            </div>
            <div
              id="nextMonth"
              title="Next Month"
              aria-label="Next Month"
              class="icon"
            >
              chevron_right
            </div>
          </div>
        </div>
        <div class="topbar__centered" _ng-random>
          <div class="search__bar liquid-glass" _ng-random id="searchBar">
            <div class="icon" _ng-random>search</div>
            <input
              type="text"
              placeholder="Search"
              id="searchInput"
              _ng-random
            />
            <div
              title="Filter"
              id="filterBtn"
              aria-label="Filter"
              class="icon"
              _ng-random
            >
              tune
            </div>
          </div>
        </div>
        <div class="topbar__right liquid-glass" _ng-random>
          <div
            title="Mobile Search"
            aria-label="Mobile Search"
            class="icon"
            id="mobileSearchIcon"
          >
            search
          </div>
          <div title="Create" aria-label="Create" class="icon" id="createBtn">
            add
          </div>

          <div
            title="Events"
            aria-label="Events"
            class="icon"
            _ng-random
            id="eventsBtn"
          >
            event
          </div>
          <div
            class="icon"
            aria-label="Favorites"
            title="Favorites"
            _ng-random
            id="favoritesBtn"
          >
            favorite
          </div>
          <div
            title="Help"
            aria-label="Help"
            class="icon"
            _ng-random
            id="helpBtn"
          >
            help
          </div>
          <div
            title="Settings"
            aria-label="Settings"
            class="icon"
            _ng-random
            id="settingsBtn"
          >
            settings
          </div>
          <div
            title="Apps"
            aria-label="Apps"
            class="icon"
            _ng-random
            id="appsBtn"
          >
            apps
          </div>
          <div
            title="More"
            aria-label="More"
            class="icon"
            _ng-random
            id="moreBtn"
          >
            more_vert
          </div>
        </div>
      </div>
      <div class="sidebar liquid-glass" _ng-random>
        <div class="mini__calendar" id="miniCalendar" _ng-random></div>
        <div id="addBirthdayBtn" class="calendar__button__my__calendar">
          <div class="icon">cake</div>
          <span _ng-random>Add Birthday</span>
        </div>
        <h3>My Calendars:</h3>
        <div class="calendar__picker__my__calendar" _ng-random>
          <div
            title="My Calendar"
            aria-label="My Calendar"
            class="calendar__button__my__calendar"
          >
            <div class="icon">calendar_month</div>
            <span _ng-random>My Calendar</span>
          </div>
          <br />
          <div class="calendar__button__my__calendar" _ng-random>
            <div class="icon">add</div>
            <span _ng-random>Add Calendar</span>
          </div>
        </div>
        <h3>Other Calendars:</h3>
        <div class="calendar__options__other__calendar" _ng-random>
          <input type="checkbox" id="showHolidays" checked _ng-random />
          <label for="showHolidays" _ng-random>Show Holidays</label>
        </div>
      </div>
      <div class="content" _ng-random>
        <div id="calendarContent" class="page" _ng-random>
          <h1 id="contentTitle">Calendar</h1>
          <div class="tabs__bar" id="tabsBar" _ng-random>
            <div class="tabs__left liquid-glass" _ng-random>
              <div class="tab" id="calendarTab">Calendar</div>
              <div class="tab" id="tasksTab">Tasks</div>
              <div class="tab" id="mealsTab">Meals</div>
            </div>
            <div class="tabs__right" _ng-random>
              <munetios-button id="viewBtn" title="View" aria-label="View">
                <div class="icon">view_week</div>
                <div class="btn__right__text">View</div>
              </munetios-button>
              <munetios-button
                id="printBtn"
                class="disabled"
                title="Print"
                aria-label="Print"
                disabled
              >
                <div class="icon">print</div>
                <div class="btn__right__text">Print</div>
              </munetios-button>
              <munetios-button
                id="shareBtn"
                class="disabled"
                title="Share"
                aria-label="Share"
                disabled
              >
                <div class="icon">share</div>
                <div class="btn__right__text">Share</div>
              </munetios-button>
              <munetios-button
                id="newEventBtn"
                class="disabled"
                title="New Event"
                aria-label="New Event"
                disabled
              >
                <div class="icon">event</div>
                <div class="btn__right__text">New Event</div>
              </munetios-button>
              <munetios-button
                id="selectBtn"
                title="Select"
                aria-label="Select"
              >
                <div class="icon">check_box</div>
                <div class="btn__right__text">Select</div>
              </munetios-button>
            </div>
          </div>
          <div class="calendar__content" id="calendarMainContent" _ng-random>
            <div class="calendar__content__header">
              <div
                class="icon"
                id="calendarContentPreviousMonthBtn"
                title="Previous Month"
                aria-label="Previous Month"
              >
                chevron_left
              </div>
              <div
                class="calendar__content__header__title"
                id="todayDateCalendar"
                _ng-random
              ></div>
              <div
                class="icon"
                id="calendarContentNextMonthBtn"
                title="Next Month"
                aria-label="Next Month"
              >
                chevron_right
              </div>
            </div>
            <!-- Calendar main content goes here -->
          </div>
        </div>
      </div>
    </munetios>
    <div class="modal" id="createEventModal" _ng-random>
      <div class="modal__content liquid-glass" _ng-random>
        <div class="modal__header" _ng-random>
          <h2 _ng-random>Create Event</h2>
          <div
            class="icon"
            id="closeCreateEventModal"
            title="Close"
            aria-label="Close"
            _ng-random
          >
            close
          </div>
        </div>
        <div class="modal__body" _ng-random>
          <label for="eventTitle" _ng-random>Event Title:</label>
          <input type="text" id="eventTitle" required _ng-random />
          <br />
          <label for="eventDate" _ng-random>Event Date:</label>
          <input type="date" id="eventDate" required _ng-random />
          <br />
          <label for="eventTime" _ng-random>Event Time:</label>
          <input type="time" id="eventTime" required _ng-random />
          <br />
          <label for="eventDescription" _ng-random
            >Event Description (Optional):</label
          >
          <textarea id="eventDescription" rows="4" _ng-random></textarea>
          <br />
          <label for="eventColor" _ng-random>Event Color</label>
          <input type="color" id="eventColor" value="#6300ee" _ng-random />
        </div>
        <div class="modal__footer" _ng-random>
          <munetios-button
            class="btn-primary"
            id="saveEventBtn"
            title="Save Event"
            aria-label="Save Event"
            _ng-random
            >Save</munetios-button
          >
          <munetios-button
            id="cancelEventBtn"
            title="Cancel"
            aria-label="Cancel"
            _ng-random
            >Cancel</munetios-button
          >
        </div>
      </div>
    </div>
    <div class="modal" id="addBirthdayModal" _ng-random>
      <div class="modal__content liquid-glass" _ng-random>
        <div class="modal__header" _ng-random>
          <h2 _ng-random>Add Birthday</h2>
          <div
            class="icon"
            id="closeAddBirthdayModal"
            title="Close"
            aria-label="Close"
            _ng-random
          >
            close
          </div>
        </div>
        <div class="modal__body" _ng-random>
          <label for="birthdayName" _ng-random>Name:</label>
          <input type="text" id="birthdayName" required _ng-random />
          <br />
          <label for="birthdayDate" _ng-random>Birthday Date:</label>
          <input type="date" id="birthdayDate" required _ng-random />
          <br />
          <label for="birthdayColor" _ng-random>Birthday Color</label>
          <input type="color" id="birthdayColor" value="#ff69b4" _ng-random />
        </div>
        <div class="modal__footer" _ng-random>
          <munetios-button
            class="btn-primary"
            id="saveBirthdayBtn"
            title="Save Birthday"
            aria-label="Save Birthday"
            _ng-random
            >Save</munetios-button
          >
          <munetios-button
            id="cancelBirthdayBtn"
            title="Cancel"
            aria-label="Cancel"
            _ng-random
            >Cancel</munetios-button
          >
        </div>
      </div>
    </div>
    <div class="search__wrapper liquid-glass" _ng-random></div>
    <script nonce="IijhdEUFuhf43UF43hF">
      (function () {
        const moreBtn = document.getElementById("moreBtn");
        const dropdownMenu = document.getElementById("dropdownMenu");
        // Build menu items
        function showMoreMenu() {
          dropdownMenu.innerHTML = "";
          const items = [
            { label: "Settings", icon: "settings", id: "moreSettings" },
            { label: "Help", icon: "help", id: "moreHelp" },
            { label: "Apps", icon: "apps", id: "moreApps" },
          ];
          items.forEach((item) => {
            const div = document.createElement("div");
            div.className = "dropdown-item";
            div.innerHTML = `<span class="icon" style="margin-right:8px;">${item.icon}</span>${item.label}`;
            div.id = item.id;
            dropdownMenu.appendChild(div);
          });
          // Position dropdown under the More button
          const rect = moreBtn.getBoundingClientRect();
          dropdownMenu.style.top = rect.bottom + window.scrollY + "px";
          dropdownMenu.style.left = rect.left + window.scrollX - 170 + "px";
          dropdownMenu.style.display = "flex";
          // Hide on click outside
          setTimeout(() => {
            function hide(ev) {
              if (!dropdownMenu.contains(ev.target) && ev.target !== moreBtn) {
                dropdownMenu.style.display = "none";
                document.removeEventListener("mousedown", hide);
              }
            }
            document.addEventListener("mousedown", hide);
          }, 0);
        }
        moreBtn.onclick = function (e) {
          e.stopPropagation();
          if (dropdownMenu.style.display === "flex") {
            dropdownMenu.style.display = "none";
          } else {
            showMoreMenu();
          }
        };
        // Menu actions
        dropdownMenu.addEventListener("click", function (e) {
          const t = e.target.closest(".dropdown-item");
          if (!t) return;
          dropdownMenu.style.display = "none";
          if (t.id === "moreSettings") {
            document.getElementById("settingsBtn").click();
          } else if (t.id === "moreHelp") {
            document.getElementById("helpBtn").click();
          } else if (t.id === "moreApps") {
            document.getElementById("appsBtn").click();
          }
        });
      })();
      (function () {
        // --- Settings Modal ---
        const settingsBtn = document.getElementById("settingsBtn");
        let settingsModal = null;
        // Supported languages and translations
        const translations = {
          en: {
            theme: "Theme",
            system: "System",
            light: "Light",
            dark: "Dark",
            language: "Language",
            notifications: "Enable Desktop Notifications",
            save: "Save",
            cancel: "Cancel",
            settings: "Settings",
            notificationsEnabled: "Desktop notifications enabled.",
            notificationsDenied: "Notifications denied.",
            notificationsUnsupported: "Notifications not supported.",
            today: "Today",
            calendar: "Calendar",
            tasks: "Tasks",
            meals: "Meals",
            addBirthday: "Add Birthday",
            showHolidays: "Show Holidays",
            view: "View",
            print: "Print",
            share: "Share",
            newEvent: "New Event",
            select: "Select",
            favorites: "Favorites",
            help: "Help",
            apps: "Apps",
            more: "More",
            close: "Close",
            search: "Search",
          },
          es: {
            theme: "Tema",
            system: "Sistema",
            light: "Claro",
            dark: "Oscuro",
            language: "Idioma",
            notifications: "Habilitar notificaciones de escritorio",
            save: "Guardar",
            cancel: "Cancelar",
            settings: "Configuración",
            notificationsEnabled: "Notificaciones de escritorio habilitadas.",
            notificationsDenied: "Notificaciones denegadas.",
            notificationsUnsupported: "Notificaciones no soportadas.",
            today: "Hoy",
            calendar: "Calendario",
            tasks: "Tareas",
            meals: "Comidas",
            addBirthday: "Agregar cumpleaños",
            showHolidays: "Mostrar festivos",
            view: "Vista",
            print: "Imprimir",
            share: "Compartir",
            newEvent: "Nuevo evento",
            select: "Seleccionar",
            favorites: "Favoritos",
            help: "Ayuda",
            apps: "Aplicaciones",
            more: "Más",
            close: "Cerrar",
            search: "Buscar",
          },
          fr: {
            theme: "Thème",
            system: "Système",
            light: "Clair",
            dark: "Sombre",
            language: "Langue",
            notifications: "Activer les notifications de bureau",
            save: "Enregistrer",
            cancel: "Annuler",
            settings: "Paramètres",
            notificationsEnabled: "Notifications de bureau activées.",
            notificationsDenied: "Notifications refusées.",
            notificationsUnsupported: "Notifications non prises en charge.",
            today: "Aujourd'hui",
            calendar: "Calendrier",
            tasks: "Tâches",
            meals: "Repas",
            addBirthday: "Ajouter un anniversaire",
            showHolidays: "Afficher les jours fériés",
            view: "Vue",
            print: "Imprimer",
            share: "Partager",
            newEvent: "Nouvel événement",
            select: "Sélectionner",
            favorites: "Favoris",
            help: "Aide",
            apps: "Applications",
            more: "Plus",
            close: "Fermer",
            search: "Rechercher",
          },
          de: {
            theme: "Thema",
            system: "System",
            light: "Hell",
            dark: "Dunkel",
            language: "Sprache",
            notifications: "Desktop-Benachrichtigungen aktivieren",
            save: "Speichern",
            cancel: "Abbrechen",
            settings: "Einstellungen",
            notificationsEnabled: "Desktop-Benachrichtigungen aktiviert.",
            notificationsDenied: "Benachrichtigungen abgelehnt.",
            notificationsUnsupported: "Benachrichtigungen nicht unterstützt.",
            today: "Heute",
            calendar: "Kalender",
            tasks: "Aufgaben",
            meals: "Mahlzeiten",
            addBirthday: "Geburtstag hinzufügen",
            showHolidays: "Feiertage anzeigen",
            view: "Ansicht",
            print: "Drucken",
            share: "Teilen",
            newEvent: "Neues Ereignis",
            select: "Auswählen",
            favorites: "Favoriten",
            help: "Hilfe",
            apps: "Apps",
            more: "Mehr",
            close: "Schließen",
            search: "Suchen",
          },
          it: {
            theme: "Tema",
            system: "Sistema",
            light: "Chiaro",
            dark: "Scuro",
            language: "Lingua",
            notifications: "Abilita notifiche desktop",
            save: "Salva",
            cancel: "Annulla",
            settings: "Impostazioni",
            notificationsEnabled: "Notifiche desktop abilitate.",
            notificationsDenied: "Notifiche negate.",
            notificationsUnsupported: "Notifiche non supportate.",
            today: "Oggi",
            calendar: "Calendario",
            tasks: "Attività",
            meals: "Pasti",
            addBirthday: "Aggiungi compleanno",
            showHolidays: "Mostra festività",
            view: "Vista",
            print: "Stampa",
            share: "Condividi",
            newEvent: "Nuovo evento",
            select: "Seleziona",
            favorites: "Preferiti",
            help: "Aiuto",
            apps: "App",
            more: "Altro",
            close: "Chiudi",
            search: "Cerca",
          },
          pt: {
            theme: "Tema",
            system: "Sistema",
            light: "Claro",
            dark: "Escuro",
            language: "Idioma",
            notifications: "Ativar notificações na área de trabalho",
            save: "Salvar",
            cancel: "Cancelar",
            settings: "Configurações",
            notificationsEnabled: "Notificações de desktop ativadas.",
            notificationsDenied: "Notificações negadas.",
            notificationsUnsupported: "Notificações não suportadas.",
            today: "Hoje",
            calendar: "Calendário",
            tasks: "Tarefas",
            meals: "Refeições",
            addBirthday: "Adicionar aniversário",
            showHolidays: "Mostrar feriados",
            view: "Visualizar",
            print: "Imprimir",
            share: "Compartilhar",
            newEvent: "Novo evento",
            select: "Selecionar",
            favorites: "Favoritos",
            help: "Ajuda",
            apps: "Aplicativos",
            more: "Mais",
            close: "Fechar",
            search: "Pesquisar",
          },
          ru: {
            theme: "Тема",
            system: "Система",
            light: "Светлая",
            dark: "Тёмная",
            language: "Язык",
            notifications: "Включить уведомления на рабочем столе",
            save: "Сохранить",
            cancel: "Отмена",
            settings: "Настройки",
            notificationsEnabled: "Уведомления включены.",
            notificationsDenied: "Уведомления отклонены.",
            notificationsUnsupported: "Уведомления не поддерживаются.",
            today: "Сегодня",
            calendar: "Календарь",
            tasks: "Задачи",
            meals: "Питание",
            addBirthday: "Добавить день рождения",
            showHolidays: "Показать праздники",
            view: "Вид",
            print: "Печать",
            share: "Поделиться",
            newEvent: "Новое событие",
            select: "Выбрать",
            favorites: "Избранное",
            help: "Помощь",
            apps: "Приложения",
            more: "Еще",
            close: "Закрыть",
            search: "Поиск",
          },
          zh: {
            theme: "主题",
            system: "系统",
            light: "浅色",
            dark: "深色",
            language: "语言",
            notifications: "启用桌面通知",
            save: "保存",
            cancel: "取消",
            settings: "设置",
            notificationsEnabled: "桌面通知已启用。",
            notificationsDenied: "通知被拒绝。",
            notificationsUnsupported: "不支持通知。",
            today: "今天",
            calendar: "日历",
            tasks: "任务",
            meals: "餐饮",
            addBirthday: "添加生日",
            showHolidays: "显示节假日",
            view: "视图",
            print: "打印",
            share: "分享",
            newEvent: "新事件",
            select: "选择",
            favorites: "收藏",
            help: "帮助",
            apps: "应用",
            more: "更多",
            close: "关闭",
            search: "搜索",
          },
          ja: {
            theme: "テーマ",
            system: "システム",
            light: "ライト",
            dark: "ダーク",
            language: "言語",
            notifications: "デスクトップ通知を有効にする",
            save: "保存",
            cancel: "キャンセル",
            settings: "設定",
            notificationsEnabled: "デスクトップ通知が有効になりました。",
            notificationsDenied: "通知が拒否されました。",
            notificationsUnsupported: "通知はサポートされていません。",
            today: "今日",
            calendar: "カレンダー",
            tasks: "タスク",
            meals: "食事",
            addBirthday: "誕生日を追加",
            showHolidays: "祝日を表示",
            view: "表示",
            print: "印刷",
            share: "共有",
            newEvent: "新しいイベント",
            select: "選択",
            favorites: "お気に入り",
            help: "ヘルプ",
            apps: "アプリ",
            more: "もっと",
            close: "閉じる",
            search: "検索",
          },
          ko: {
            theme: "테마",
            system: "시스템",
            light: "라이트",
            dark: "다크",
            language: "언어",
            notifications: "데스크톱 알림 활성화",
            save: "저장",
            cancel: "취소",
            settings: "설정",
            notificationsEnabled: "데스크톱 알림이 활성화되었습니다.",
            notificationsDenied: "알림이 거부되었습니다.",
            notificationsUnsupported: "알림이 지원되지 않습니다.",
            today: "오늘",
            calendar: "달력",
            tasks: "작업",
            meals: "식사",
            addBirthday: "생일 추가",
            showHolidays: "공휴일 표시",
            view: "보기",
            print: "인쇄",
            share: "공유",
            newEvent: "새 이벤트",
            select: "선택",
            favorites: "즐겨찾기",
            help: "도움말",
            apps: "앱",
            more: "더보기",
            close: "닫기",
            search: "검색",
          },
          tr: {
            theme: "Tema",
            system: "Sistem",
            light: "Açık",
            dark: "Koyu",
            language: "Dil",
            notifications: "Masaüstü bildirimlerini etkinleştir",
            save: "Kaydet",
            cancel: "İptal",
            settings: "Ayarlar",
            notificationsEnabled: "Masaüstü bildirimleri etkinleştirildi.",
            notificationsDenied: "Bildirimler reddedildi.",
            notificationsUnsupported: "Bildirimler desteklenmiyor.",
            today: "Bugün",
            calendar: "Takvim",
            tasks: "Görevler",
            meals: "Yemekler",
            addBirthday: "Doğum günü ekle",
            showHolidays: "Tatil günlerini göster",
            view: "Görünüm",
            print: "Yazdır",
            share: "Paylaş",
            newEvent: "Yeni etkinlik",
            select: "Seç",
            favorites: "Favoriler",
            help: "Yardım",
            apps: "Uygulamalar",
            more: "Daha fazla",
            close: "Kapat",
            search: "Ara",
          },
          ar: {
            theme: "السمة",
            system: "النظام",
            light: "فاتح",
            dark: "داكن",
            language: "اللغة",
            notifications: "تفعيل إشعارات سطح المكتب",
            save: "حفظ",
            cancel: "إلغاء",
            settings: "الإعدادات",
            notificationsEnabled: "تم تفعيل إشعارات سطح المكتب.",
            notificationsDenied: "تم رفض الإشعارات.",
            notificationsUnsupported: "الإشعارات غير مدعومة.",
            today: "اليوم",
            calendar: "التقويم",
            tasks: "المهام",
            meals: "الوجبات",
            addBirthday: "إضافة عيد ميلاد",
            showHolidays: "عرض العطلات",
            view: "عرض",
            print: "طباعة",
            share: "مشاركة",
            newEvent: "حدث جديد",
            select: "تحديد",
            favorites: "المفضلة",
            help: "مساعدة",
            apps: "تطبيقات",
            more: "المزيد",
            close: "إغلاق",
            search: "بحث",
          },
        };
        let currentLang = localStorage.getItem("munetiosLang") || "en";
        let currentTheme = localStorage.getItem("munetiosTheme") || "system";
        let notificationsEnabled =
          localStorage.getItem("munetiosNotifications") === "on";

        // Helper: translate UI
        function translateUI() {
          function t(key) {
            return (
              (translations[currentLang] && translations[currentLang][key]) ||
              translations["en"][key] ||
              key
            );
          }
          // Topbar
          document.getElementById("todayBtn").textContent = t("today");
          document.getElementById("calendarTab").textContent = t("calendar");
          document.getElementById("tasksTab").textContent = t("tasks");
          document.getElementById("mealsTab").textContent = t("meals");
          document
            .getElementById("addBirthdayBtn")
            .querySelector("span").textContent = t("addBirthday");
          document.querySelector('label[for="showHolidays"]').textContent =
            t("showHolidays");
          document
            .getElementById("viewBtn")
            .querySelector(".btn__right__text").textContent = t("view");
          document
            .getElementById("printBtn")
            .querySelector(".btn__right__text").textContent = t("print");
          document
            .getElementById("shareBtn")
            .querySelector(".btn__right__text").textContent = t("share");
          document
            .getElementById("newEventBtn")
            .querySelector(".btn__right__text").textContent = t("newEvent");
          document
            .getElementById("selectBtn")
            .querySelector(".btn__right__text").textContent = t("select");
          document
            .getElementById("favoritesBtn")
            .setAttribute("title", t("favorites"));
          document.getElementById("helpBtn").setAttribute("title", t("help"));
          document
            .getElementById("settingsBtn")
            .setAttribute("title", t("settings"));
          document.getElementById("appsBtn").setAttribute("title", t("apps"));
          document.getElementById("moreBtn").setAttribute("title", t("more"));
          // Settings modal
          if (settingsModal) {
            settingsModal.querySelector("h2").textContent = t("settings");
            settingsModal.querySelector(".theme-label").textContent =
              t("theme");
            settingsModal.querySelector(".lang-label").textContent =
              t("language");
            settingsModal.querySelector(".notif-label").textContent =
              t("notifications");
            settingsModal.querySelector("#saveSettingsBtn").textContent =
              t("save");
            settingsModal.querySelector("#cancelSettingsBtn").textContent =
              t("cancel");
          }
        }
        // Helper: apply theme (system, light, dark)
        function applyTheme(theme) {
          currentTheme = theme;
          localStorage.setItem("munetiosTheme", theme);

          // Remove previous theme style if exists
          let oldStyle = document.getElementById("munetios-theme-style");
          if (oldStyle) oldStyle.remove();

          // Build CSS for the theme
          let css = "";
          if (theme === "system") {
            if (
              window.matchMedia &&
              window.matchMedia("(prefers-color-scheme: light)").matches
            ) {
              theme = "light";
            } else {
              theme = "dark";
            }
            // Listen for system theme changes and re-apply theme
            if (!window._munetiosSystemThemeListener) {
              const mqLight = window.matchMedia(
                "(prefers-color-scheme: light)",
              );
              const mqDark = window.matchMedia("(prefers-color-scheme: dark)");
              const systemThemeListener = () => {
                if (localStorage.getItem("munetiosTheme") === "system") {
                  applyTheme("system");
                }
              };
              mqLight.addEventListener("change", systemThemeListener);
              mqDark.addEventListener("change", systemThemeListener);
              window._munetiosSystemThemeListener = true;
            }
          }
          if (theme === "light") {
            css = `
                            * { color: #222 !important; }
                                html, body, munetios.app { background-color: #f7f7fa !important; color: #222 !important; }
                                .sidebar { background-color: #fff !important; color: #222 !important; }
                                .icon { color: #222 !important; }
                                .content { background-color: #f7f7fa !important; color: #222 !important; }
                                .modal__content { background: linear-gradient(to bottom, #fff 90%, #f7f7fa 100%) !important; color: #222 !important; border: 1px solid rgba(99,0,238,0.10) !important; box-shadow: 0 8px 32px 0 rgba(31,38,135,0.07) !important; }
                                .liquid-glass { background: linear-gradient(to bottom, rgba(99,0,238,0.03), rgba(99,0,238,0.06)) !important; border: 1px solid rgba(99,0,238,0.10) !important; box-shadow: 0 8px 32px 0 rgba(31,38,135,0.07) !important; color: #222 !important; }
                                .calendar__content { background: linear-gradient(to bottom, rgba(99,0,238,0.03), rgba(99,0,238,0.06)) !important; color: #222 !important; }
                            `;
          } else {
            css = `
                            * { color: #fff !important; }
                                html, body, munetios.app { background-color: #160033 !important; color: #fff !important; }
                                .sidebar { background-color: #160033 !important; color: #fff !important; }
                                .icon { color: #fff !important; }
                                .content { background-color: #160033 !important; color: #fff !important; }
                                .modal__content { background: linear-gradient(to bottom, rgba(255,255,255,0.08), rgba(99,0,238,0.18)) !important; color: #fff !important; border: 1px solid rgba(255,255,255,0.18) !important; box-shadow: 0 8px 32px 0 rgba(31,38,135,0.37) !important; }
                                .liquid-glass { background: linear-gradient(to bottom, rgba(255,255,255,0.05), rgba(255,255,255,0.1)) !important; border: 1px solid rgba(255,255,255,0.18) !important; box-shadow: 0 8px 32px 0 rgba(31,38,135,0.37) !important; color: #fff !important; }
                                .calendar__content { background: linear-gradient(to bottom, rgba(255,255,255,0.05), rgba(255,255,255,0.1)) !important; color: #fff !important; }
                            `;
          }

          // Inject style
          let style = document.createElement("style");
          style.id = "munetios-theme-style";
          style.textContent = css;
          document.head.appendChild(style);
        }
        // Helper: request notifications
        function requestNotifications() {
          if (!("Notification" in window)) {
            showToast(translations[currentLang].notificationsUnsupported, {
              type: "error",
            });
            return;
          }
          Notification.requestPermission().then(function (permission) {
            if (permission === "granted") {
              notificationsEnabled = true;
              localStorage.setItem("munetiosNotifications", "on");
              showToast(translations[currentLang].notificationsEnabled, {
                type: "success",
              });
              scheduleNotifications(); // Schedule notifications after permission granted
            } else {
              notificationsEnabled = false;
              localStorage.setItem("munetiosNotifications", "off");
              showToast(translations[currentLang].notificationsDenied, {
                type: "error",
              });
            }
          });
        }
        // --- Backup, Restore, Delete All Data logic ---
        function backupData() {
          openDB().then((db) => {
            const tx1 = db.transaction("events", "readonly");
            const tx2 = db.transaction("birthdays", "readonly");
            const eventsStore = tx1.objectStore("events");
            const birthdaysStore = tx2.objectStore("birthdays");
            const eventsReq = eventsStore.getAll();
            const birthdaysReq = birthdaysStore.getAll();
            eventsReq.onsuccess = function () {
              birthdaysReq.onsuccess = function () {
                const data = {
                  events: eventsReq.result,
                  birthdays: birthdaysReq.result,
                  exportedAt: new Date().toISOString(),
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {
                  type: "application/json",
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "munetios-calendar-backup.json";
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                  URL.revokeObjectURL(url);
                  a.remove();
                }, 100);
              };
            };
          });
        }

        function restoreData() {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = "application/json";
          input.onchange = function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (ev) {
              try {
                const data = JSON.parse(ev.target.result);
                if (!data.events || !data.birthdays)
                  throw new Error("Invalid backup file");
                openDB().then((db) => {
                  // Clear existing data
                  const tx1 = db.transaction("events", "readwrite");
                  const tx2 = db.transaction("birthdays", "readwrite");
                  tx1.objectStore("events").clear();
                  tx2.objectStore("birthdays").clear();
                  tx1.oncomplete = function () {
                    // Import events
                    const tx = db.transaction("events", "readwrite");
                    const store = tx.objectStore("events");
                    (data.events || []).forEach((ev) => {
                      // Remove id to let autoIncrement work
                      if ("id" in ev) delete ev.id;
                      store.add(ev);
                    });
                    tx.oncomplete = function () {
                      // Import birthdays
                      const txb = db.transaction("birthdays", "readwrite");
                      const storeb = txb.objectStore("birthdays");
                      (data.birthdays || []).forEach((bd) => {
                        if ("id" in bd) delete bd.id;
                        storeb.add(bd);
                      });
                      txb.oncomplete = function () {
                        showToast("Restore complete!", { type: "success" });
                        rerender();
                      };
                    };
                  };
                });
              } catch (err) {
                showToast("Invalid backup file", { type: "error" });
              }
            };
            reader.readAsText(file);
          };
          input.click();
        }

        function showDeleteAllDataModal() {
          // 10-step confirmation modal with code at end
          let modal = document.getElementById("deleteAllDataModal");
          if (!modal) {
            modal = document.createElement("div");
            modal.className = "modal";
            modal.id = "deleteAllDataModal";
            modal.style.zIndex = 4200;
            modal.innerHTML = `
                                <div class="modal__content liquid-glass" style="max-width:420px;">
                                    <div class="modal__header">
                                        <h2>Delete All Data</h2>
                                        <div class="icon" id="closeDeleteAllDataModal" title="Close" aria-label="Close">close</div>
                                    </div>
                                    <div class="modal__body" id="deleteAllDataModalBody" style="padding-bottom:10px;">
                                        <div id="deleteStepText"></div>
                                        <div id="deleteStepInputWrapper" style="margin-top:12px;"></div>
                                    </div>
                                    <div class="modal__footer">
                                        <munetios-button class="btn-primary" id="deleteAllDataNextBtn">Next</munetios-button>
                                        <munetios-button id="deleteAllDataCancelBtn">Cancel</munetios-button>
                                    </div>
                                </div>
                            `;
            document.body.appendChild(modal);
            modal.querySelector("#closeDeleteAllDataModal").onclick = () =>
              (modal.style.display = "none");
            modal.querySelector("#deleteAllDataCancelBtn").onclick = () =>
              (modal.style.display = "none");
            modal.onclick = (e) => {
              if (e.target === modal) modal.style.display = "none";
            };
          }
          let step = 1;
          const totalSteps = 10;
          const code = Math.floor(100000 + Math.random() * 900000).toString();
          const stepText = [
            "Are you sure you want to delete <b>all</b> your calendar data?",
            "This will remove <b>all events</b> and <b>all birthdays</b>.",
            "This cannot be undone.",
            "Your data will be lost from this browser.",
            "You will not be able to recover deleted data.",
            "Back up your data first if you want to keep it.",
            "Are you really, really sure?",
            "This is your last chance to cancel.",
            "To confirm, enter the code below.",
            `Enter this code to confirm: <b>${code}</b>`,
          ];
          function renderStep() {
            modal.querySelector("#deleteStepText").innerHTML =
              stepText[step - 1];
            const inputWrapper = modal.querySelector("#deleteStepInputWrapper");
            inputWrapper.innerHTML = "";
            if (step === totalSteps) {
              inputWrapper.innerHTML = `<input type="text" id="deleteAllDataCodeInput" placeholder="Enter code" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;">`;
            }
            modal.querySelector("#deleteAllDataNextBtn").textContent =
              step === totalSteps ? "Delete" : "Next";
          }
          renderStep();
          modal.querySelector("#deleteAllDataNextBtn").onclick = function () {
            if (step < totalSteps) {
              step++;
              renderStep();
            } else {
              // Check code
              const val = modal
                .querySelector("#deleteAllDataCodeInput")
                .value.trim();
              if (val !== code) {
                showToast("Incorrect code", { type: "error" });
                return;
              }
              // Delete all data
              openDB().then((db) => {
                const tx1 = db.transaction("events", "readwrite");
                const tx2 = db.transaction("birthdays", "readwrite");
                tx1.objectStore("events").clear();
                tx2.objectStore("birthdays").clear();
                tx2.oncomplete = function () {
                  showToast("All data deleted!", { type: "success" });
                  rerender();
                  modal.style.display = "none";
                  location.reload();
                };
              });
            }
          };
          modal.style.display = "block";
        }

        // Attach to settings modal buttons
        document.body.addEventListener("click", function (e) {
          if (e.target && e.target.id === "backupDataBtn") {
            backupData();
          }
          if (e.target && e.target.id === "restoreDataBtn") {
            restoreData();
          }
          if (e.target && e.target.id === "deleteAllDataBtn") {
            showDeleteAllDataModal();
          }
        });
        // Helper: show settings modal
        function showSettingsModal() {
          if (!settingsModal) {
            settingsModal = document.createElement("div");
            settingsModal.className = "modal";
            settingsModal.style.zIndex = 4100;
            settingsModal.innerHTML = `
                                <div class="modal__content liquid-glass" style="max-width:420px;">
                                    <div class="modal__header">
                                        <h2>${translations[currentLang].settings}</h2>
                                        <div class="icon" id="closeSettingsModal" title="${translations[currentLang].close}" aria-label="${translations[currentLang].close}">close</div>
                                    </div>
                                    <div class="modal__body" style="display:flex;flex-direction:column;gap:18px;">
                                        <label class="theme-label">${translations[currentLang].theme}</label>
                                        <div>
                                            <munetios-button id="themeDropdownBtn" style="width:100%;justify-content:space-between;">
                                                <span class="icon">palette</span>
                                                <span id="themeDropdownText">${translations[currentLang][currentTheme]}</span>
                                                <span class="icon">expand_more</span>
                                            </munetios-button>
                                            <munetios-dropdown-menu id="themeDropdownMenu"></munetios-dropdown-menu>
                                        </div>
                                        <label class="lang-label">${translations[currentLang].language}</label>
                                        <div>
                                            <munetios-button id="langDropdownBtn" style="width:100%;justify-content:space-between;">
                                                <span class="icon">language</span>
                                                <span id="langDropdownText">${currentLang.toUpperCase()}</span>
                                                <span class="icon">expand_more</span>
                                            </munetios-button>
                                            <munetios-dropdown-menu id="langDropdownMenu"></munetios-dropdown-menu>
                                        </div>
                                        <label class="notif-label">${translations[currentLang].notifications}</label>
                                        <div>
                                            <input type="checkbox" id="notifCheckbox" ${notificationsEnabled ? "checked" : ""} style="vertical-align:middle;margin-right:8px;">
                                            <span style="font-size:15px;vertical-align:middle;">${translations[currentLang].notifications}</span>
                                        </div>
                                        <div style="display:flex;gap:10px;justify-content:space-between;">
                                            <munetios-button id="backupDataBtn" title="Backup Data" aria-label="Backup Data">Backup</munetios-button>
                                            <munetios-button id="restoreDataBtn" title="Restore Data" aria-label="Restore Data">Restore</munetios-button>
                                            <munetios-button id="deleteAllDataBtn" title="Delete All Data" aria-label="Delete All Data" style=" white-space: nowrap; color:#fff;background:#d5000062;">Delete all data</munetios-button>
                                        </div>
                                        <div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.18);">
                                            <label style="color:#ffe066;display:block;margin-bottom:8px;font-weight:600;">🔒 Security</label>
                                            <p style="font-size:0.85em;opacity:0.8;margin-bottom:12px;line-height:1.4;">Reset your encryption key. Warning: This will make existing encrypted data unreadable. You'll need to re-enter all data.</p>
                                            <munetios-button id="resetEncryptionKeyBtn" style="background:#ff3d00 !important;width:100%;justify-content:center;" title="Reset Encryption Key" disabled aria-label="Reset Encryption Key">🔑 Reset Encryption Key (Under construction)</munetios-button>
                                        </div>
                                    </div>
                                    <div class="modal__footer">
                                        <munetios-button class="btn-primary" id="saveSettingsBtn">${translations[currentLang].save}</munetios-button>
                                        <munetios-button id="cancelSettingsBtn">${translations[currentLang].cancel}</munetios-button>
                                    </div>
                                </div>
                            `;
            document.body.appendChild(settingsModal);
            // Theme dropdown
            const themeBtn = settingsModal.querySelector("#themeDropdownBtn");
            const themeMenu = settingsModal.querySelector("#themeDropdownMenu");
            themeBtn.onclick = function (e) {
              e.stopPropagation();
              themeMenu.innerHTML = "";
              ["system", "light", "dark"].forEach((val) => {
                const item = document.createElement("div");
                item.className = "dropdown-item";
                item.textContent = translations[currentLang][val];
                if (val === currentTheme) item.style.fontWeight = "bold";
                item.onclick = () => {
                  settingsModal.querySelector(
                    "#themeDropdownText",
                  ).textContent = translations[currentLang][val];
                  themeMenu.style.display = "none";
                  themeBtn.setAttribute("data-selected", val);
                };
                themeMenu.appendChild(item);
              });
              const rect = themeBtn.getBoundingClientRect();
              themeMenu.style.top = rect.bottom + window.scrollY + "px";
              themeMenu.style.left = rect.left + window.scrollX + "px";
              themeMenu.style.display = "flex";
              setTimeout(() => {
                function hide(ev) {
                  if (
                    !themeMenu.contains(ev.target) &&
                    ev.target !== themeBtn
                  ) {
                    themeMenu.style.display = "none";
                    document.removeEventListener("mousedown", hide);
                  }
                }
                document.addEventListener("mousedown", hide);
              }, 0);
            };
            // Language dropdown
            const langBtn = settingsModal.querySelector("#langDropdownBtn");
            const langMenu = settingsModal.querySelector("#langDropdownMenu");
            langBtn.onclick = function (e) {
              e.stopPropagation();
              langMenu.innerHTML = "";
              Object.keys(translations).forEach((lang) => {
                const item = document.createElement("div");
                item.className = "dropdown-item";
                item.textContent = lang.toUpperCase();
                if (lang === currentLang) item.style.fontWeight = "bold";
                item.onclick = () => {
                  settingsModal.querySelector("#langDropdownText").textContent =
                    lang.toUpperCase();
                  langMenu.style.display = "none";
                  langBtn.setAttribute("data-selected", lang);
                };
                langMenu.appendChild(item);
              });
              const rect = langBtn.getBoundingClientRect();
              langMenu.style.top = rect.bottom + window.scrollY + "px";
              langMenu.style.left = rect.left + window.scrollX + "px";
              langMenu.style.display = "flex";
              setTimeout(() => {
                function hide(ev) {
                  if (!langMenu.contains(ev.target) && ev.target !== langBtn) {
                    langMenu.style.display = "none";
                    document.removeEventListener("mousedown", hide);
                  }
                }
                document.addEventListener("mousedown", hide);
              }, 0);
            };
            // Notification checkbox
            settingsModal.querySelector("#notifCheckbox").onchange =
              function () {
                if (this.checked) {
                  requestNotifications();
                } else {
                  notificationsEnabled = false;
                  localStorage.setItem("munetiosNotifications", "off");
                }
              };
            // Reset encryption key button
            settingsModal.querySelector("#resetEncryptionKeyBtn").onclick =
              async function () {
                if (
                  confirm(
                    "⚠️ Are you absolutely sure you want to reset your encryption key?\n\n" +
                      "This will make ALL existing encrypted data (events, birthdays, calendars) permanently unreadable.\n\n" +
                      "You will need to re-enter all your data.\n\n" +
                      "This action CANNOT be undone!\n\n" +
                      "Click OK to proceed with resetting the key.",
                  )
                ) {
                  try {
                    await resetEncryptionKey();
                    showToast(
                      "🔑 Encryption key reset successfully! All existing data is now unreadable. Please re-enter your data.",
                      { type: "success" },
                    );
                    // Optionally clear all data
                    if (
                      confirm(
                        "Do you want to also clear all encrypted data from the database?",
                      )
                    ) {
                      await openDB().then((db) => {
                        const tx1 = db.transaction("events", "readwrite");
                        const tx2 = db.transaction("birthdays", "readwrite");
                        tx1.objectStore("events").clear();
                        tx2.objectStore("birthdays").clear();
                        return new Promise((resolve) => {
                          tx2.oncomplete = resolve;
                        });
                      });
                      showToast("Database cleared successfully!", {
                        type: "success",
                      });
                      location.reload();
                    }
                  } catch (error) {
                    showToast("❌ Failed to reset encryption key.", {
                      type: "error",
                    });
                    console.error("Error resetting key:", error);
                  }
                }
              };
            // Save/cancel/close
            settingsModal.querySelector("#saveSettingsBtn").onclick =
              function () {
                // Theme
                let theme =
                  themeBtn.getAttribute("data-selected") || currentTheme;
                applyTheme(theme);
                // Language
                let lang = langBtn.getAttribute("data-selected") || currentLang;
                currentLang = lang;
                localStorage.setItem("munetiosLang", lang);
                translateUI();
                // Notifications already handled
                settingsModal.style.display = "none";
              };
            settingsModal.querySelector("#cancelSettingsBtn").onclick =
              function () {
                settingsModal.style.display = "none";
              };
            settingsModal.querySelector("#closeSettingsModal").onclick =
              function () {
                settingsModal.style.display = "none";
              };
            settingsModal.onclick = function (e) {
              if (e.target === settingsModal)
                settingsModal.style.display = "none";
            };
          }
          // Set dropdowns to current values
          settingsModal.querySelector("#themeDropdownText").textContent =
            translations[currentLang][currentTheme];
          settingsModal.querySelector("#langDropdownText").textContent =
            currentLang.toUpperCase();
          settingsModal.querySelector("#notifCheckbox").checked =
            notificationsEnabled;
          settingsModal
            .querySelector("#themeDropdownBtn")
            .setAttribute("data-selected", currentTheme);
          settingsModal
            .querySelector("#langDropdownBtn")
            .setAttribute("data-selected", currentLang);
          settingsModal.style.display = "block";
          translateUI();
        }
        settingsBtn.onclick = showSettingsModal;
        // Apply theme/lang on load
        applyTheme(currentTheme);
        translateUI();

        // --- Desktop Notifications: schedule notifications for events/birthdays ---

        // IndexedDB setup for events and birthdays (move this up so saveEventToDB is defined)
        const DB_NAME = "munetios_calendar";
        const DB_VERSION = 1;
        let db = null;

        function openDB() {
          return new Promise((resolve, reject) => {
            if (db) return resolve(db);
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = function (e) {
              const db = e.target.result;
              if (!db.objectStoreNames.contains("events")) {
                db.createObjectStore("events", {
                  keyPath: "id",
                  autoIncrement: true,
                });
              }
              if (!db.objectStoreNames.contains("birthdays")) {
                db.createObjectStore("birthdays", {
                  keyPath: "id",
                  autoIncrement: true,
                });
              }
            };
            req.onsuccess = function (e) {
              db = e.target.result;
              resolve(db);
            };
            req.onerror = function (e) {
              reject(e);
            };
          });
        }

        function saveEventToDB(event) {
          return openDB().then((db) => {
            return new Promise((resolve, reject) => {
              const tx = db.transaction("events", "readwrite");
              tx.objectStore("events").add(event);
              tx.oncomplete = resolve;
              tx.onerror = reject;
            });
          });
        }

        function saveBirthdayToDB(birthday) {
          return openDB().then((db) => {
            return new Promise((resolve, reject) => {
              const tx = db.transaction("birthdays", "readwrite");
              tx.objectStore("birthdays").add(birthday);
              tx.oncomplete = resolve;
              tx.onerror = reject;
            });
          });
        }

        // Now the notification scheduling logic can safely use/override saveEventToDB/saveBirthdayToDB
        function scheduleNotifications() {
          if (
            !notificationsEnabled ||
            !("Notification" in window) ||
            Notification.permission !== "granted"
          )
            return;
          // Clear previous timeouts
          if (window._munetiosNotifs)
            window._munetiosNotifs.forEach(clearTimeout);
          window._munetiosNotifs = [];
          // Get events/birthdays for today and future
          const now = new Date();
          openDB().then((db) => {
            // Events
            const tx = db.transaction("events", "readonly");
            const store = tx.objectStore("events");
            const req = store.getAll();
            req.onsuccess = function () {
              req.result.forEach((ev) => {
                if (!ev.date) return;
                let evDate = new Date(
                  ev.date + (ev.time ? "T" + ev.time : "T09:00"),
                );
                if (evDate < now) return;
                let ms = evDate - now;
                if (ms > 0) {
                  let tid = setTimeout(() => {
                    new Notification(ev.title, {
                      body: ev.desc || "",
                      icon: "/android-chrome-512x512.png",
                    });
                  }, ms);
                  window._munetiosNotifs.push(tid);
                }
              });
            };
            // Birthdays
            const tx2 = db.transaction("birthdays", "readonly");
            const store2 = tx2.objectStore("birthdays");
            const req2 = store2.getAll();
            req2.onsuccess = function () {
              req2.result.forEach((bd) => {
                if (!bd.date) return;
                let parts = bd.date.split("-");
                if (parts.length < 3) return;
                let year = now.getFullYear();
                let bdDate = new Date(
                  year,
                  Number(parts[1]) - 1,
                  Number(parts[2]),
                  9,
                  0,
                  0,
                );
                if (bdDate < now) return;
                let ms = bdDate - now;
                if (ms > 0) {
                  let tid = setTimeout(() => {
                    new Notification("🎂 " + bd.name, {
                      body: "Birthday today!",
                      icon: "/android-chrome-512x512.png",
                    });
                  }, ms);
                  window._munetiosNotifs.push(tid);
                }
              });
            };
          });
        }
        if (notificationsEnabled && Notification.permission === "granted") {
          scheduleNotifications();
        } else if (
          notificationsEnabled &&
          Notification.permission !== "granted"
        ) {
          requestNotifications();
        }
        // Re-schedule notifications when events/birthdays change
        const origSaveEventToDB = saveEventToDB;
        saveEventToDB = function (ev) {
          return origSaveEventToDB(ev).then(() => {
            if (notificationsEnabled && Notification.permission === "granted")
              scheduleNotifications();
          });
        };
        const origSaveBirthdayToDB = saveBirthdayToDB;
        saveBirthdayToDB = function (bd) {
          return origSaveBirthdayToDB(bd).then(() => {
            if (notificationsEnabled && Notification.permission === "granted")
              scheduleNotifications();
          });
        };
        // Also re-schedule on settings change
        window.addEventListener("storage", function (e) {
          if (e.key === "munetiosNotifications") {
            notificationsEnabled =
              localStorage.getItem("munetiosNotifications") === "on";
            if (notificationsEnabled && Notification.permission === "granted")
              scheduleNotifications();
          }
        });
      })();

      // Help button logic: show modal with How To, FAQ, and Changelog
      (function () {
        const helpBtn = document.getElementById("helpBtn");
        let helpModal = null;
        helpBtn.onclick = function () {
          if (!helpModal) {
            helpModal = document.createElement("div");
            helpModal.className = "modal";
            helpModal.style.zIndex = 4000;
            helpModal.innerHTML = `
                        <div class="modal__content liquid-glass" style="max-width:800px !important;">
                            <div class="modal__header">
                                <h2>Help & Info</h2>
                                <div class="icon" id="closeHelpModal" title="Close" aria-label="Close">close</div>
                            </div>
                            <div class="modal__body" id="helpModalBody" style="max-height:60vh;overflow-y:auto;">
                                <h3>How To Use</h3>
                                <ul>
                                    <li>Click days to create events or birthdays.</li>
                                    <li>Switch views (Month, Week, Day, etc.) using the View button.</li>
                                    <li>Use the search bar to find events, birthdays, or holidays.</li>
                                    <li>Click the hamburger menu to show/hide the sidebar.</li>
                                    <li>Use the "Select" button to select multiple dates for sharing or printing.</li>
                                </ul>
                                <h3>FAQ</h3>
                                <ul>
                                    <li><b>Q:</b> How do I add a new calendar?<br><b>A:</b> Click "Add Calendar" in the sidebar under My Calendars.</li>
                                    <li><b>Q:</b> How do I print or share dates?<br><b>A:</b> Select dates, then use the Print or Share buttons.</li>
                                    <li><b>Q:</b> Where are my events stored?<br><b>A:</b> Events are saved in your browser (IndexedDB) and are private to your device.</li>
                                </ul>
                                <h3>Changelog</h3>
                                <ul>
                                    <li><b>v1.3</b> - Added End-To-End encryption for events.</li>
                                    <li><b>v1.2</b> - Improvements and added Archive Versions links.</li>
                                    <li><b>v1.0</b> – Initial release with multi-calendar, events, birthdays, holidays, and advanced sharing/printing.</li>
                                    <li>Added week/day/year/agenda/timeline views.</li>
                                    <li>Improved mobile support and accessibility.</li>
                                </ul>
                                <h3>About</h3>
                                <p>Go to <a href="/new/overview.html">Overview</a> for more information.</p>
                                <h3>Archive Versions</h3>
                                <div style="display:flex;flex-direction:column;gap:8px;">
                                <a href="https://calendar.munetios.com/archive/">Munetios Calendar Beta v1</a>
                                <a href="https://calendar.munetios.com/archive/classic.html">Munetios Calendar Classic</a>
                                </div>
                            </div>
                        </div>
                    `;
            document.body.appendChild(helpModal);
            helpModal.querySelector("#closeHelpModal").onclick = () =>
              (helpModal.style.display = "none");
            helpModal.onclick = (e) => {
              if (e.target === helpModal) helpModal.style.display = "none";
            };
          }
          helpModal.style.display = "block";
        };
      })();
      (function () {
        // Tab switching logic for Calendar/Tasks/Meals
        const tabs = {
          calendar: document.getElementById("calendarTab"),
          tasks: document.getElementById("tasksTab"),
          meals: document.getElementById("mealsTab"),
        };
        const contentTitle = document.getElementById("contentTitle");
        const calendarContent = document.getElementById("calendarContent");
        const calendarMainContent = document.getElementById(
          "calendarMainContent",
        );
        let tasksFrame = null;
        let mealsDiv = null;

        // --- Move rerender and renderCalendar above showCalendar ---
        // Minimal stub to avoid error; actual implementation is below
        function rerender() {}

        function showCalendar() {
          contentTitle.textContent = "Calendar";
          calendarMainContent.style.display = "";
          if (tasksFrame) tasksFrame.style.display = "none";
          if (mealsDiv) mealsDiv.style.display = "none";
          rerender();
        }

        function showTasks() {
          contentTitle.textContent = "Tasks";
          calendarMainContent.style.display = "none";
          if (!tasksFrame) {
            tasksFrame = document.createElement("iframe");
            tasksFrame.src = "tasks.html";
            tasksFrame.style.width = "100%";
            tasksFrame.style.height = "calc(100vh - 260px)";
            tasksFrame.style.border = "none";
            tasksFrame.style.background = "transparent";
            tasksFrame.style.borderRadius = "15px";
            tasksFrame.style.display = "block";
            calendarContent.appendChild(tasksFrame);
          }
          tasksFrame.style.display = "block";
          if (mealsDiv) mealsDiv.style.display = "none";
        }

        function showMeals() {
          contentTitle.textContent = "Meals";
          calendarMainContent.style.display = "none";
          if (tasksFrame) tasksFrame.style.display = "none";
          if (!mealsDiv) {
            mealsDiv = document.createElement("iframe");
            mealsDiv.src = "meals.html";
            mealsDiv.style.width = "100%";
            mealsDiv.style.height = "calc(100vh - 260px)";
            mealsDiv.style.border = "none";
            mealsDiv.style.background = "transparent";
            mealsDiv.style.borderRadius = "15px";
            mealsDiv.style.display = "block";
            calendarContent.appendChild(mealsDiv);
          }
          mealsDiv.style.display = "block";
        }

        function setActiveTab(tab) {
          Object.values(tabs).forEach((t) => (t.style.fontWeight = ""));
          tab.style.fontWeight = "bold";
        }

        tabs.calendar.onclick = function () {
          setActiveTab(tabs.calendar);
          showCalendar();
        };
        tabs.tasks.onclick = function () {
          setActiveTab(tabs.tasks);
          showTasks();
        };
        tabs.meals.onclick = function () {
          setActiveTab(tabs.meals);
          showMeals();
        };
        function handleHashChange() {
          const hash = window.location.hash;
          if (hash === "#/meals") {
            setActiveTab(tabs.meals);
            showMeals();
          } else if (hash === "#/tasks") {
            setActiveTab(tabs.tasks);
            showTasks();
          } else {
            setActiveTab(tabs.calendar);
            showCalendar();
          }
        }
        window.addEventListener("hashchange", handleHashChange);

        // Tab clicks update hash
        tabs.calendar.onclick = function () {
          window.location.hash = "#/";
        };
        tabs.tasks.onclick = function () {
          window.location.hash = "#/tasks";
        };
        tabs.meals.onclick = function () {
          window.location.hash = "#/meals";
        };

        // On load, set view by hash
        handleHashChange();
        // Default to Calendar tab
        setActiveTab(tabs.calendar);
      })();
      // Apps button logic: show/hide iframe wrapper under the apps icon
      (function () {
        const appsBtn = document.getElementById("appsBtn");
        let appsWrapper = null;

        appsBtn.onclick = function (e) {
          e.stopPropagation();
          // Remove if already open
          if (appsWrapper && appsWrapper.style.display === "block") {
            appsWrapper.style.display = "none";
            return;
          }
          // Create wrapper if not exists
          if (!appsWrapper) {
            appsWrapper = document.createElement("div");
            appsWrapper.style.position = "fixed";
            appsWrapper.style.top =
              appsBtn.getBoundingClientRect().bottom + window.scrollY + "px";
            appsWrapper.style.left =
              appsBtn.getBoundingClientRect().left +
              window.scrollX -
              440 +
              "px";
            appsWrapper.style.width = "500px";
            appsWrapper.style.height = "740px";
            appsWrapper.style.borderRadius = "18px";
            appsWrapper.style.boxShadow = "0 8px 32px 0 rgba(31,38,135,0.37)";
            appsWrapper.style.border = "1px solid rgba(255,255,255,0.18)";
            appsWrapper.style.zIndex = "999999";
            appsWrapper.style.overflow = "hidden";
            appsWrapper.style.display = "block";
            appsWrapper.innerHTML = `
                            <div class="liquid-glass" style="display:flex;justify-content:space-between;align-items:center;padding:8px 16px;">
                                <span style="font-weight:bold;color:#fff;">Munetios Apps</span>
                                <span class="icon" id="closeAppsWrapper" style="cursor:pointer;">close</span>
                            </div>
                            <iframe src="https://www.munetios.com/apps/" style="width:100%;height:740px;border:none;background:#fff;border-radius:0 0 18px 18px;"></iframe>
                        `;
            document.body.appendChild(appsWrapper);
            // Close logic
            appsWrapper.querySelector("#closeAppsWrapper").onclick =
              function () {
                appsWrapper.style.display = "none";
              };
          } else {
            // Reposition in case of resize/scroll
            appsWrapper.style.top =
              appsBtn.getBoundingClientRect().bottom + window.scrollY + "px";
            appsWrapper.style.left =
              appsBtn.getBoundingClientRect().left +
              window.scrollX -
              440 +
              "px";
            appsWrapper.style.display = "block";
          }
          // Hide on click outside
          setTimeout(() => {
            function hide(ev) {
              if (!appsWrapper.contains(ev.target) && ev.target !== appsBtn) {
                appsWrapper.style.display = "none";
                document.removeEventListener("mousedown", hide);
              }
            }
            document.addEventListener("mousedown", hide);
          }, 0);
        };
      })();
      (function () {
        // US Holidays (fixed and variable dates, accurate, repeats yearly)
        const holidays = [
          // Fixed date holidays
          { name: "New Year's Day", month: 0, day: 1 },
          {
            name: "Martin Luther King Jr. Day",
            month: 0,
            getDay: (year) => {
              // Third Monday in January
              const d = new Date(year, 0, 1);
              let mondayCount = 0;
              for (let i = 1; i <= 31; i++) {
                d.setDate(i);
                if (d.getDay() === 1) mondayCount++;
                if (mondayCount === 3) return i;
              }
            },
          },
          {
            name: "Presidents' Day",
            month: 1,
            getDay: (year) => {
              // Third Monday in February
              const d = new Date(year, 1, 1);
              let mondayCount = 0;
              for (let i = 1; i <= 29; i++) {
                d.setDate(i);
                if (d.getDay() === 1) mondayCount++;
                if (mondayCount === 3) return i;
              }
            },
          },
          {
            name: "Memorial Day",
            month: 4,
            getDay: (year) => {
              // Last Monday in May
              const d = new Date(year, 4, 31);
              for (let i = 0; i < 7; i++) {
                if (d.getDay() === 1) return d.getDate();
                d.setDate(d.getDate() - 1);
              }
            },
          },
          { name: "Juneteenth National Independence Day", month: 5, day: 19 },
          { name: "Independence Day", month: 6, day: 4 },
          {
            name: "Labor Day",
            month: 8,
            getDay: (year) => {
              // First Monday in September
              const d = new Date(year, 8, 1);
              for (let i = 1; i <= 7; i++) {
                d.setDate(i);
                if (d.getDay() === 1) return i;
              }
            },
          },
          {
            name: "Columbus Day",
            month: 9,
            getDay: (year) => {
              // Second Monday in October
              const d = new Date(year, 9, 1);
              let mondayCount = 0;
              for (let i = 1; i <= 14; i++) {
                d.setDate(i);
                if (d.getDay() === 1) mondayCount++;
                if (mondayCount === 2) return i;
              }
            },
          },
          { name: "Veterans Day", month: 10, day: 11 },
          {
            name: "Thanksgiving Day",
            month: 10,
            getDay: (year) => {
              // Fourth Thursday in November
              const d = new Date(year, 10, 1);
              let thursdayCount = 0;
              for (let i = 1; i <= 30; i++) {
                d.setDate(i);
                if (d.getDay() === 4) thursdayCount++;
                if (thursdayCount === 4) return i;
              }
            },
          },
          { name: "Christmas Day", month: 11, day: 25 },
          { name: "Christmas Eve", month: 11, day: 24 },
          { name: "Halloween", month: 9, day: 31 },
          { name: "Groundhog Day", month: 1, day: 2 },
          { name: "Valentine's Day", month: 1, day: 14 },
          { name: "St. Patrick's Day", month: 2, day: 17 },
          {
            name: "Easter",
            month: (() => {
              // Calculate Easter Sunday (Western) for a given year
              // Returns month (0-based)
              return function (year) {
                let f = Math.floor,
                  a = year % 19,
                  b = f(year / 100),
                  c = year % 100,
                  d = f(b / 4),
                  e = b % 4,
                  g = f((b + 8) / 25),
                  h = f((b - g + 1) / 3),
                  i = (c / 4) | 0,
                  k = c % 4,
                  l = (19 * a + b - d - h + 15) % 30,
                  m = (32 + 2 * e + 2 * i - k - l) % 7,
                  n = f((a + 11 * l + 22 * m) / 451),
                  month = f((l + m - 7 * n + 114) / 31) - 1;
                return month;
              };
            })(),
            getDay: (year) => {
              // Calculate Easter Sunday (Western) for a given year
              let f = Math.floor,
                a = year % 19,
                b = f(year / 100),
                c = year % 100,
                d = f(b / 4),
                e = b % 4,
                g = f((b + 8) / 25),
                h = f((b - g + 1) / 3),
                i = (c / 4) | 0,
                k = c % 4,
                l = (19 * a + b - d - h + 15) % 30,
                m = (32 + 2 * e + 2 * i - k - l) % 7,
                n = f((a + 11 * l + 22 * m) / 451),
                month = f((l + m - 7 * n + 114) / 31),
                day = ((l + m - 7 * n + 114) % 31) + 1;
              return day;
            },
          },
          {
            name: "Mother's Day",
            month: 4,
            getDay: (year) => {
              // Second Sunday in May
              const d = new Date(year, 4, 1);
              let sundayCount = 0;
              for (let i = 1; i <= 31; i++) {
                d.setDate(i);
                if (d.getDay() === 0) sundayCount++;
                if (sundayCount === 2) return i;
              }
            },
          },
          {
            name: "Father's Day",
            month: 5,
            getDay: (year) => {
              // Third Sunday in June
              const d = new Date(year, 5, 1);
              let sundayCount = 0;
              for (let i = 1; i <= 30; i++) {
                d.setDate(i);
                if (d.getDay() === 0) sundayCount++;
                if (sundayCount === 3) return i;
              }
            },
          },
          { name: "Flag Day", month: 5, day: 14 },
          { name: "Pearl Harbor Remembrance Day", month: 11, day: 7 },
          {
            name: "Arbor Day",
            month: 3,
            getDay: (year) => {
              // Last Friday in April
              const d = new Date(year, 3, 30);
              for (let i = 0; i < 7; i++) {
                if (d.getDay() === 5) return d.getDate();
                d.setDate(d.getDate() - 1);
              }
            },
          },
          {
            name: "Administrative Professionals Day",
            month: 3,
            getDay: (year) => {
              // Wednesday of last full week in April (4th Wednesday)
              const d = new Date(year, 3, 1);
              let wednesdayCount = 0;
              for (let i = 1; i <= 30; i++) {
                d.setDate(i);
                if (d.getDay() === 3) wednesdayCount++;
                if (wednesdayCount === 4) return i;
              }
            },
          },
          { name: "Patriot Day", month: 8, day: 11 },
          { name: "Constitution Day", month: 8, day: 17 },
          {
            name: "Election Day",
            month: 10,
            getDay: (year) => {
              // First Tuesday after the first Monday in November
              const d = new Date(year, 10, 2);
              while (d.getDay() !== 2) d.setDate(d.getDate() + 1);
              return d.getDate();
            },
          },
          {
            name: "Black Friday",
            month: 10,
            getDay: (year) => {
              // Day after Thanksgiving
              // Thanksgiving: 4th Thursday in November
              const d = new Date(year, 10, 1);
              let thursdayCount = 0;
              for (let i = 1; i <= 30; i++) {
                d.setDate(i);
                if (d.getDay() === 4) thursdayCount++;
                if (thursdayCount === 4) {
                  d.setDate(i + 1);
                  return d.getDate();
                }
              }
            },
          },
          {
            name: "Cyber Monday",
            month: 10,
            getDay: (year) => {
              // Monday after Thanksgiving (4th Thursday)
              const d = new Date(year, 10, 1);
              let thursdayCount = 0;
              for (let i = 1; i <= 30; i++) {
                d.setDate(i);
                if (d.getDay() === 4) thursdayCount++;
                if (thursdayCount === 4) {
                  // Thanksgiving found at i
                  // Find next Monday after i
                  let monday = new Date(year, 10, i + 1);
                  while (monday.getDay() !== 1)
                    monday.setDate(monday.getDate() + 1);
                  return monday.getDate();
                }
              }
            },
          },
          { name: "Groundhog Day", month: 1, day: 2 },
          { name: "April Fools' Day", month: 3, day: 1 },
          { name: "Cinco de Mayo", month: 4, day: 5 },
          { name: "New Year's Eve", month: 11, day: 31 },
          {
            name: "Super Bowl Sunday",
            month: 1,
            getDay: (year) => {
              // First Sunday in February
              const d = new Date(year, 1, 1);
              for (let i = 1; i <= 7; i++) {
                d.setDate(i);
                if (d.getDay() === 0) return i;
              }
            },
          },

          { name: "Kwanzaa", month: 11, day: 26 },
          {
            name: "Mardi Gras",
            month: (() => {
              // Mardi Gras is 47 days before Easter
              return function (year) {
                // Calculate Easter
                let f = Math.floor,
                  a = year % 19,
                  b = f(year / 100),
                  c = year % 100,
                  d = f(b / 4),
                  e = b % 4,
                  g = f((b + 8) / 25),
                  h = f((b - g + 1) / 3),
                  i = (c / 4) | 0,
                  k = c % 4,
                  l = (19 * a + b - d - h + 15) % 30,
                  m = (32 + 2 * e + 2 * i - k - l) % 7,
                  n = f((a + 11 * l + 22 * m) / 451),
                  month = f((l + m - 7 * n + 114) / 31) - 1;
                let day = ((l + m - 7 * n + 114) % 31) + 1;
                let easter = new Date(year, month, day);
                let mardiGras = new Date(easter);
                mardiGras.setDate(easter.getDate() - 47);
                return mardiGras.getMonth();
              };
            })(),
            getDay: (year) => {
              // See above for calculation
              let f = Math.floor,
                a = year % 19,
                b = f(year / 100),
                c = year % 100,
                d = f(b / 4),
                e = b % 4,
                g = f((b + 8) / 25),
                h = f((b - g + 1) / 3),
                i = (c / 4) | 0,
                k = c % 4,
                l = (19 * a + b - d - h + 15) % 30,
                m = (32 + 2 * e + 2 * i - k - l) % 7,
                n = f((a + 11 * l + 22 * m) / 451),
                month = f((l + m - 7 * n + 114) / 31) - 1,
                day = ((l + m - 7 * n + 114) % 31) + 1;
              let easter = new Date(year, month, day);
              let mardiGras = new Date(easter);
              mardiGras.setDate(easter.getDate() - 47);
              return mardiGras.getDate();
            },
          },
          {
            name: "Good Friday",
            month: (() => {
              // Good Friday is 2 days before Easter
              return function (year) {
                let f = Math.floor,
                  a = year % 19,
                  b = f(year / 100),
                  c = year % 100,
                  d = f(b / 4),
                  e = b % 4,
                  g = f((b + 8) / 25),
                  h = f((b - g + 1) / 3),
                  i = (c / 4) | 0,
                  k = c % 4,
                  l = (19 * a + b - d - h + 15) % 30,
                  m = (32 + 2 * e + 2 * i - k - l) % 7,
                  n = f((a + 11 * l + 22 * m) / 451),
                  month = f((l + m - 7 * n + 114) / 31) - 1;
                let day = ((l + m - 7 * n + 114) % 31) + 1;
                let easter = new Date(year, month, day);
                let goodFriday = new Date(easter);
                goodFriday.setDate(easter.getDate() - 2);
                return goodFriday.getMonth();
              };
            })(),
            getDay: (year) => {
              let f = Math.floor,
                a = year % 19,
                b = f(year / 100),
                c = year % 100,
                d = f(b / 4),
                e = b % 4,
                g = f((b + 8) / 25),
                h = f((b - g + 1) / 3),
                i = (c / 4) | 0,
                k = c % 4,
                l = (19 * a + b - d - h + 15) % 30,
                m = (32 + 2 * e + 2 * i - k - l) % 7,
                n = f((a + 11 * l + 22 * m) / 451),
                month = f((l + m - 7 * n + 114) / 31) - 1,
                day = ((l + m - 7 * n + 114) % 31) + 1;
              let easter = new Date(year, month, day);
              let goodFriday = new Date(easter);
              goodFriday.setDate(easter.getDate() - 2);
              return goodFriday.getDate();
            },
          },
          { name: "Earth Day", month: 3, day: 22 },
          { name: "Pearl Harbor Day", month: 11, day: 7 },
        ];

        // Helper: get holidays for a given month/year
        function getHolidaysForMonth(month, year) {
          return holidays
            .map((h) => {
              let day = h.day;
              if (typeof h.getDay === "function") {
                day = h.getDay(year);
              }
              return { name: h.name, month: h.month, day };
            })
            .filter((h) => h.month === month);
        }

        // Calendar rendering logic
        const calendarMainContent = document.getElementById(
          "calendarMainContent",
        );
        const todayDateCalendar = document.getElementById("todayDateCalendar");
        const prevBtn = document.getElementById(
          "calendarContentPreviousMonthBtn",
        );
        const nextBtn = document.getElementById("calendarContentNextMonthBtn");
        const showHolidaysCheckbox = document.getElementById("showHolidays");
        const prevMonthBtn = document.getElementById("previousMonth");
        const nextMonthBtn = document.getElementById("nextMonth");
        const viewBtn = document.getElementById("viewBtn");
        const createEvent = document.getElementById("createBtn");
        const createBirthday = document.getElementById("addBirthdayBtn");

        const dropdownMenu = document.getElementById("dropdownMenu");
        const searchBar = document.getElementById("searchBar");
        const searchResults = document.querySelector(".search__wrapper");

        const viewOptions = [
          { label: "Month", value: "month" },
          { label: "Week", value: "week" },
          { label: "Day", value: "day" },
          { label: "Year", value: "year" },
          { label: "Agenda", value: "agenda" },
          { label: "Timeline", value: "timeline" },
        ];
        let currentView = "month";

        // Week view rendering logic
        function renderWeekView(month, year) {
          // Always use selectedDate as anchor for week view
          let anchorDate = selectedDate
            ? new Date(selectedDate)
            : new Date(year, month, 1);
          // Clamp anchorDate to the correct month/year if needed
          if (
            anchorDate.getMonth() !== month ||
            anchorDate.getFullYear() !== year
          ) {
            anchorDate = new Date(year, month, 1);
            selectedDate = new Date(anchorDate);
          }
          // Find the Sunday of the week containing anchorDate
          let weekStart = new Date(anchorDate);
          weekStart.setDate(anchorDate.getDate() - weekStart.getDay());
          let weekDays = [];
          for (let i = 0; i < 7; i++) {
            let d = new Date(weekStart);
            d.setDate(weekStart.getDate() + i);
            weekDays.push(d);
          }

          // If today is in this month, show week containing today
          let today = new Date();
          if (today.getMonth() === month && today.getFullYear() === year) {
            let dayOfWeek = today.getDay();
            let weekStartToday = new Date(today);
            weekStartToday.setDate(today.getDate() - dayOfWeek);
            weekDays = [];
            for (let i = 0; i < 7; i++) {
              let d = new Date(weekStartToday);
              d.setDate(weekStartToday.getDate() + i);
              weekDays.push(d);
            }
          }

          // Header
          todayDateCalendar.textContent = `${weekDays[0].toLocaleDateString(undefined, { month: "short", day: "numeric" })} - ${weekDays[6].toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" })}`;
          // Build week grid: first column is time, next 7 columns are days
          let html = `<div class="calendar__dates__grid" style="display:grid;grid-template-columns:80px repeat(7,1fr);height:auto;min-height:600px;">`;

          // Header row: blank for time, then days
          html += `<div style="background:transparent"></div>`;
          for (let i = 0; i < 7; i++) {
            html += `<div style="font-weight:bold;color:#fff;text-align:center;padding:8px 0 8px 0;background:rgba(255,255,255,0.04);border-radius:10px;">${weekDays[i].toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric" })}</div>`;
          }

          // 24 hour time slots (12AM to 11PM)
          for (let hour = 0; hour < 24; hour++) {
            let ampm = hour < 12 ? "AM" : "PM";
            let displayHour = hour % 12 === 0 ? 12 : hour % 12;
            html += `<div style="text-align:right;padding:6px 8px 6px 0;color:#ffe066;font-size:13px;opacity:.7">${displayHour}:00 ${ampm}</div>`;
            for (let d = 0; d < 7; d++) {
              // Highlight today in the week view with dark purple
              let isToday =
                weekDays[d].toDateString() === new Date().toDateString();
              let classes = "calendar__dates_button";
              let style = "border-radius:8px;min-height:32px;";
              if (isToday) {
                classes += " calendar__dates__today";
                style += "background:rgba(99,0,238,0.548);";
              } else {
                style += "background:rgba(99,0,238,0.18);";
              }
              html += `<div class="${classes}" style="${style}"></div>`;
            }
          }

          html += `</div>`;
          calendarMainContent
            .querySelector(".calendar__content__header")
            .nextElementSibling?.remove();
          calendarMainContent.insertAdjacentHTML("beforeend", html);
        }
        function renderDayView(month, year) {
          // Show the current day (today if in this month, else 1st of month)
          let day;
          let today = new Date();
          if (today.getMonth() === month && today.getFullYear() === year) {
            day = today.getDate();
          } else {
            day = 1;
          }
          let date = new Date(year, month, day);
          todayDateCalendar.textContent = date.toLocaleDateString(undefined, {
            weekday: "long",
            month: "long",
            day: "numeric",
            year: "numeric",
          });

          let html = `<div class="calendar__dates__grid" style="display:grid;grid-template-columns:80px 1fr;height:auto;min-height:600px;">`;
          html += `<div style="background:transparent"></div>`;
          html += `<div style="font-weight:bold;color:#fff;text-align:center;padding:8px 0 8px 0;background:rgba(255,255,255,0.04);border-radius:10px;">${date.toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric" })}</div>`;
          for (let hour = 0; hour < 24; hour++) {
            let ampm = hour < 12 ? "AM" : "PM";
            let displayHour = hour % 12 === 0 ? 12 : hour % 12;
            html += `<div style="text-align:right;padding:6px 8px 6px 0;color:#ffe066;font-size:13px;opacity:.7">${displayHour}:00 ${ampm}</div>`;
            let isToday = date.toDateString() === new Date().toDateString();
            let classes = "calendar__dates_button";
            let style = "border-radius:8px;min-height:32px;";
            if (isToday) {
              classes += " calendar__dates__today";
              style += "background:rgba(99,0,238,0.548);";
            } else {
              style += "background:rgba(99,0,238,0.18);";
            }
            html += `<div class="${classes}" style="${style}"></div>`;
          }
          html += `</div>`;
          calendarMainContent
            .querySelector(".calendar__content__header")
            .nextElementSibling?.remove();
          calendarMainContent.insertAdjacentHTML("beforeend", html);
        }

        function renderYearView(month, year) {
          // Show all months of the year in a grid
          todayDateCalendar.textContent = year;
          let html = `<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:18px;">`;
          let today = new Date();
          for (let m = 0; m < 12; m++) {
            let daysInMonth = new Date(year, m + 1, 0).getDate();
            let firstDay = new Date(year, m, 1).getDay();
            html += `<div style="background:rgba(255,255,255,0.04);border-radius:12px;padding:10px 6px 12px 6px;box-shadow:0 2px 8px 0 rgba(31,38,135,0.10);">
                            <div style="font-weight:bold;text-align:center;color:#fff;margin-bottom:6px;">${new Date(year, m).toLocaleString("default", { month: "long" })}</div>
                            <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;">`;
            // Weekdays
            const weekdays = ["S", "M", "T", "W", "T", "F", "S"];
            for (let d = 0; d < 7; d++) {
              html += `<div style="font-size:11px;opacity:.7;text-align:center;">${weekdays[d]}</div>`;
            }
            // Blanks
            for (let i = 0; i < firstDay; i++) {
              html += `<div style="opacity:.2;">&nbsp;</div>`;
            }
            // Days
            for (let d = 1; d <= daysInMonth; d++) {
              let isToday =
                d === today.getDate() &&
                m === today.getMonth() &&
                year === today.getFullYear();
              html += `<div style="text-align:center;padding:2px 0;border-radius:7px;${isToday ? "background:rgba(99,0,238,0.548);color:#fff;" : "color:#fff;"}">${d}</div>`;
            }
            // Fill to end of grid
            let totalCells = firstDay + daysInMonth + 7;
            let nextDays = (7 - (totalCells % 7)) % 7;
            for (let i = 1; i <= nextDays; i++) {
              html += `<div style="opacity:.2;">&nbsp;</div>`;
            }
            html += `</div></div>`;
          }
          html += `</div>`;
          calendarMainContent
            .querySelector(".calendar__content__header")
            .nextElementSibling?.remove();
          calendarMainContent.insertAdjacentHTML("beforeend", html);
        }

        function renderAgendaView(month, year) {
          // List all days of the month, with holidays if enabled
          todayDateCalendar.textContent =
            new Date(year, month).toLocaleString("default", {
              month: "long",
              year: "numeric",
            }) + " Agenda";
          let daysInMonth = new Date(year, month + 1, 0).getDate();
          let holidaysThisMonth = showHolidays
            ? getHolidaysForMonth(month, year)
            : [];
          let today = new Date();
          let html = `<div style="display:flex;flex-direction:column;gap:10px;">`;
          for (let d = 1; d <= daysInMonth; d++) {
            let date = new Date(year, month, d);
            let isToday =
              d === today.getDate() &&
              month === today.getMonth() &&
              year === today.getFullYear();
            let holiday = holidaysThisMonth.find((h) => h.day === d);
            html += `<div style="display:flex;align-items:center;gap:16px;padding:10px 18px;border-radius:12px;${isToday ? "background:rgba(99,0,238,0.548);" : "background:rgba(255,255,255,0.04);"}">
                            <div style="font-weight:bold;font-size:18px;width:60px;text-align:right;color:#fff;">${d}</div>
                            <div style="flex:1;">
                                <div style="font-size:15px;color:#fff;">${date.toLocaleDateString(undefined, { weekday: "long", month: "long", day: "numeric" })}</div>
                                ${holiday ? `<div style="font-size:13px;color:#ffe066;margin-top:2px;">${holiday.name}</div>` : ""}
                            </div>
                        </div>`;
          }
          html += `</div>`;
          calendarMainContent
            .querySelector(".calendar__content__header")
            .nextElementSibling?.remove();
          calendarMainContent.insertAdjacentHTML("beforeend", html);
        }
        function renderTimelineView(month, year) {
          // Set title to "Timeline for {year}" regardless of month/year
          todayDateCalendar.textContent = `Timeline for ${year}`;

          // Remove all top dates in the timeline (no bars, no numbers)
          let html = `<div style="overflow-x:auto;padding:20px 0;">
                        <div style="display:flex;align-items:flex-end;gap:8px;"></div>
                    </div>`;

          // Show all holidays in all months of the year
          let allHolidays = [];
          for (let m = 0; m < 12; m++) {
            let holidaysThisMonth = getHolidaysForMonth(m, year);
            holidaysThisMonth.forEach((h) => {
              allHolidays.push({
                name: h.name,
                month: m,
                day: h.day,
              });
            });
          }
          if (allHolidays.length > 0) {
            html += `<div style="margin-top:24px;">
                            <div style="font-weight:bold;color:#fff;font-size:22px;margin-bottom:8px;">All Holidays in ${year}</div>
                            <div style="display:flex;flex-direction:column;gap:12px;">`;
            allHolidays.sort((a, b) => a.month - b.month || a.day - b.day);
            allHolidays.forEach((h) => {
              let dateStr = new Date(year, h.month, h.day).toLocaleDateString(
                undefined,
                { month: "short", day: "numeric" },
              );
              html += `<div style="color:#ffe066;font-size:15px;">
                                <span style="color:#fff;opacity:.7;">${dateStr}:</span> ${h.name}
                            </div>`;
            });
            html += `</div></div>`;
          }

          calendarMainContent
            .querySelector(".calendar__content__header")
            .nextElementSibling?.remove();
          calendarMainContent.insertAdjacentHTML("beforeend", html);
        }

        // Unified rerender for all views
        function rerender() {
          // Remove previous grid if exists
          const oldGrid = calendarMainContent.querySelector(
            ".calendar__dates__grid",
          );
          if (oldGrid) oldGrid.remove();
          // Remove any custom view content
          let next = calendarMainContent.querySelector(
            ".calendar__content__header",
          )?.nextElementSibling;
          if (next && !next.classList.contains("calendar__dates__grid"))
            next.remove();

          // Always sync currentMonth/currentYear with selectedDate
          currentMonth = selectedDate.getMonth();
          currentYear = selectedDate.getFullYear();

          if (currentView === "week") {
            renderWeekView(currentMonth, currentYear, selectedDate);
          } else if (currentView === "day") {
            renderDayView(currentMonth, currentYear, selectedDate);
          } else if (currentView === "year") {
            renderYearView(currentMonth, currentYear);
          } else if (currentView === "agenda") {
            renderAgendaView(currentMonth, currentYear);
          } else if (currentView === "timeline") {
            renderTimelineView(currentMonth, currentYear);
          } else {
            renderCalendar(currentMonth, currentYear);
          }
        }

        // Update calendar view when changed from dropdown
        function updateCalendarView(view) {
          currentView = view;
          const label = viewOptions.find((opt) => opt.value === view).label;
          viewBtn.querySelector(".btn__right__text").textContent = label;
          // Save to localStorage
          localStorage.setItem("calendarView", view);
          localStorage.setItem("calendarViewLabel", label);
          rerender();
        }

        // Load saved view from localStorage on startup
        const savedView = localStorage.getItem("calendarView");
        const savedLabel = localStorage.getItem("calendarViewLabel");
        if (savedView && viewOptions.some((opt) => opt.value === savedView)) {
          currentView = savedView;
          viewBtn.querySelector(".btn__right__text").textContent =
            savedLabel ||
            viewOptions.find((opt) => opt.value === savedView).label;
        }
        const viewBtnRect = () => viewBtn.getBoundingClientRect();

        function showDropdownMenu() {
          dropdownMenu.innerHTML = "";
          viewOptions.forEach((opt) => {
            const div = document.createElement("div");
            div.className = "dropdown-item";
            div.textContent = opt.label;
            if (opt.value === currentView) {
              div.style.fontWeight = "bold";
            }
            div.onclick = () => {
              updateCalendarView(opt.value);
              dropdownMenu.style.display = "none";
            };
            dropdownMenu.appendChild(div);
          });
          // Position dropdown under the button
          const rect = viewBtnRect();
          dropdownMenu.style.top = rect.bottom + window.scrollY + "px";
          dropdownMenu.style.left = rect.left + window.scrollX + "px";
          dropdownMenu.style.display = "flex";
          // Hide on click outside
          setTimeout(() => {
            function hide(e) {
              if (!dropdownMenu.contains(e.target) && e.target !== viewBtn) {
                dropdownMenu.style.display = "none";
                document.removeEventListener("mousedown", hide);
              }
            }
            document.addEventListener("mousedown", hide);
          }, 0);
        }

        viewBtn.onclick = function (e) {
          e.stopPropagation();
          if (dropdownMenu.style.display === "flex") {
            dropdownMenu.style.display = "none";
          } else {
            showDropdownMenu();
          }
        };

        let today = new Date();
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();
        let showHolidays = showHolidaysCheckbox.checked;
        let selectedDate = new Date(today); // Track the selected date for all views

        // Use saved view if available
        if (savedView && viewOptions.some((opt) => opt.value === savedView)) {
          currentView = savedView;
        }

        document.getElementById("todayBtn").onclick = function () {
          const now = new Date();
          currentMonth = now.getMonth();
          currentYear = now.getFullYear();
          selectedDate = new Date(now);
          rerender();
        };
        // Topbar arrows: sync with main calendar
        prevMonthBtn.onclick = function () {
          if (currentView === "month" || currentView === "agenda") {
            selectedDate.setMonth(selectedDate.getMonth() - 1);
            currentMonth = selectedDate.getMonth();
            currentYear = selectedDate.getFullYear();
          } else if (currentView === "week") {
            selectedDate.setDate(selectedDate.getDate() - 7);
            currentMonth = selectedDate.getMonth();
            currentYear = selectedDate.getFullYear();
          } else if (currentView === "day") {
            selectedDate.setDate(selectedDate.getDate() - 1);
            currentMonth = selectedDate.getMonth();
            currentYear = selectedDate.getFullYear();
          } else if (currentView === "year" || currentView === "timeline") {
            selectedDate.setFullYear(selectedDate.getFullYear() - 1);
            currentYear = selectedDate.getFullYear();
          }
          rerender();
        };
        nextMonthBtn.onclick = function () {
          if (currentView === "month" || currentView === "agenda") {
            selectedDate.setMonth(selectedDate.getMonth() + 1);
            currentMonth = selectedDate.getMonth();
            currentYear = selectedDate.getFullYear();
          } else if (currentView === "week") {
            selectedDate.setDate(selectedDate.getDate() + 7);
            currentMonth = selectedDate.getMonth();
            currentYear = selectedDate.getFullYear();
          } else if (currentView === "day") {
            selectedDate.setDate(selectedDate.getDate() + 1);
            currentMonth = selectedDate.getMonth();
            currentYear = selectedDate.getFullYear();
          } else if (currentView === "year" || currentView === "timeline") {
            selectedDate.setFullYear(selectedDate.getFullYear() + 1);
            currentYear = selectedDate.getFullYear();
          }
          rerender();
        };
        document.getElementById("eventsBtn").onclick = function () {
          // Modal for all events and birthdays
          let eventsModal = document.getElementById("allEventsModal");
          if (!eventsModal) {
            eventsModal = document.createElement("div");
            eventsModal.className = "modal";
            eventsModal.id = "allEventsModal";
            eventsModal.style.zIndex = 4000;
            eventsModal.innerHTML = `
                            <div class="modal__content liquid-glass" style="max-width:520px;">
                                <div class="modal__header">
                                    <h2>All Events & Birthdays</h2>
                                    <div class="icon" id="closeAllEventsModal" title="Close" aria-label="Close">close</div>
                                </div>
                                <div class="modal__body" id="allEventsModalBody" style="max-height:60vh;overflow-y:auto;"></div>
                            </div>
                        `;
            document.body.appendChild(eventsModal);
            eventsModal.querySelector("#closeAllEventsModal").onclick = () =>
              (eventsModal.style.display = "none");
            eventsModal.onclick = (e) => {
              if (e.target === eventsModal) eventsModal.style.display = "none";
            };
          }
          // Load all events and birthdays for current calendar
          Promise.all([
            openDB().then(
              (db) =>
                new Promise((res) => {
                  const tx = db.transaction("events", "readonly");
                  const store = tx.objectStore("events");
                  const req = store.getAll();
                  req.onsuccess = () =>
                    res(
                      req.result.filter(
                        (ev) =>
                          (ev.calendar || "My Calendar") === currentCalendar,
                      ),
                    );
                  req.onerror = () => res([]);
                }),
            ),
            openDB().then(
              (db) =>
                new Promise((res) => {
                  const tx = db.transaction("birthdays", "readonly");
                  const store = tx.objectStore("birthdays");
                  const req = store.getAll();
                  req.onsuccess = () =>
                    res(
                      req.result.filter(
                        (bd) =>
                          (bd.calendar || "My Calendar") === currentCalendar,
                      ),
                    );
                  req.onerror = () => res([]);
                }),
            ),
          ]).then(([events, birthdays]) => {
            let html = "";
            if (!events.length && !birthdays.length) {
              html = `<div style="color:#fff;opacity:.7;">No events or birthdays found.</div>`;
            } else {
              if (events.length) {
                html += `<div style="font-weight:bold;color:#fff;font-size:17px;margin-bottom:6px;">Events</div>`;
                events.sort((a, b) => (a.date > b.date ? 1 : -1));
                events.forEach((ev) => {
                  let dateStr = ev.date
                    ? new Date(ev.date).toLocaleDateString(undefined, {
                        month: "short",
                        day: "numeric",
                        year: "numeric",
                      })
                    : "";
                  html += `<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;align-items:flex-start;gap:8px;">
                                        <span class="icon" style="color:${ev.color || "#6300ee"};font-size:20px;vertical-align:middle;">event</span>
                                        <div style="flex:1;">
                                            <span style="color:${ev.color || "#6300ee"};font-weight:500;">${ev.title}</span>
                                            <span style="color:#fff;opacity:.7;font-size:13px;margin-left:8px;">${dateStr}${ev.time ? " " + ev.time : ""}</span>
                                            ${ev.desc ? `<div style="color:#fff;opacity:.8;font-size:13px;margin-left:0;">${ev.desc}</div>` : ""}
                                        </div>
                                        <span class="icon edit-event-btn" title="Edit" style="font-size:20px;cursor:pointer;" data-id="${ev.id}">edit</span>
                                        <span class="icon delete-event-btn" title="Delete" style="font-size:20px;cursor:pointer;" data-id="${ev.id}">delete</span>
                                    </div>`;
                });
              }
              if (birthdays.length) {
                html += `<div style="font-weight:bold;color:#fff;font-size:17px;margin:12px 0 6px 0;">Birthdays</div>`;
                birthdays.sort((a, b) => (a.date > b.date ? 1 : -1));
                birthdays.forEach((bd) => {
                  let dateStr = bd.date
                    ? new Date(bd.date).toLocaleDateString(undefined, {
                        month: "short",
                        day: "numeric",
                      })
                    : "";
                  html += `<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;align-items:flex-start;gap:8px;">
                                        <span class="icon" style="color:${bd.color || "#ff69b4"};font-size:20px;vertical-align:middle;">cake</span>
                                        <div style="flex:1;">
                                            <span style="color:${bd.color || "#ff69b4"};font-weight:500;">${bd.name}</span>
                                            <span style="color:#fff;opacity:.7;font-size:13px;margin-left:8px;">${dateStr}</span>
                                        </div>
                                    </div>`;
                });
              }
            }
            eventsModal.querySelector("#allEventsModalBody").innerHTML = html;
            eventsModal.style.display = "block";

            // Edit event logic
            eventsModal.querySelectorAll(".edit-event-btn").forEach((btn) => {
              btn.onclick = function () {
                const id = Number(this.getAttribute("data-id"));
                openDB().then((db) => {
                  const tx = db.transaction("events", "readonly");
                  const store = tx.objectStore("events");
                  const req = store.get(id);
                  req.onsuccess = function () {
                    const ev = req.result;
                    if (!ev) return;
                    // Show modal and fill fields
                    showModal(createEventModal);
                    document.getElementById("eventTitle").value =
                      ev.title || "";
                    document.getElementById("eventDate").value = ev.date || "";
                    document.getElementById("eventTime").value = ev.time || "";
                    document.getElementById("eventDescription").value =
                      ev.desc || "";
                    document.getElementById("eventColor").value =
                      ev.color || "#6300ee";
                    // Set calendar dropdown
                    let calBtn =
                      createEventModal.querySelector("#eventCalendarBtn");
                    if (calBtn) {
                      calBtn.setAttribute(
                        "data-selected",
                        ev.calendar || "My Calendar",
                      );
                      calBtn.querySelector(".calendar-btn-text").textContent =
                        ev.calendar || "My Calendar";
                    }
                    // Save changes
                    saveEventBtn.onclick = function () {
                      const title = document
                        .getElementById("eventTitle")
                        .value.trim();
                      const date = document.getElementById("eventDate").value;
                      const time = document.getElementById("eventTime").value;
                      const desc = document
                        .getElementById("eventDescription")
                        .value.trim();
                      const color = document.getElementById("eventColor").value;
                      const calendar = calBtn
                        ? calBtn.getAttribute("data-selected")
                        : ev.calendar || "My Calendar";
                      if (!title || !date) return;
                      openDB().then((db2) => {
                        const tx2 = db2.transaction("events", "readwrite");
                        const store2 = tx2.objectStore("events");
                        store2.put({
                          ...ev,
                          title,
                          date,
                          time,
                          desc,
                          color,
                          calendar,
                        });
                        tx2.oncomplete = () => {
                          hideModal(createEventModal);
                          rerender();
                          eventsModal.style.display = "none";
                          showToast("Event updated!", { type: "success" });
                        };
                      });
                    };
                  };
                });
              };
            });

            // Delete event logic (modal, not confirm)
            eventsModal.querySelectorAll(".delete-event-btn").forEach((btn) => {
              btn.onclick = function () {
                const id = Number(this.getAttribute("data-id"));
                // Show a custom modal for delete confirmation
                let delModal = document.getElementById("deleteEventModal");
                if (!delModal) {
                  delModal = document.createElement("div");
                  delModal.className = "modal";
                  delModal.id = "deleteEventModal";
                  delModal.style.zIndex = 4100;
                  delModal.innerHTML = `
                                        <div class="modal__content liquid-glass" style="max-width:340px;">
                                            <div class="modal__header">
                                                <h2>Delete Event</h2>
                                                <div class="icon" id="closeDeleteEventModal" title="Close" aria-label="Close">close</div>
                                            </div>
                                            <div class="modal__body" id="deleteEventModalBody" style="padding-bottom:10px;">
                                                Are you sure you want to delete this event?
                                            </div>
                                            <div class="modal__footer">
                                                <munetios-button class="btn-primary" id="confirmDeleteEventBtn">Delete</munetios-button>
                                                <munetios-button id="cancelDeleteEventBtn">Cancel</munetios-button>
                                            </div>
                                        </div>
                                    `;
                  document.body.appendChild(delModal);
                  delModal.querySelector("#closeDeleteEventModal").onclick =
                    () => (delModal.style.display = "none");
                  delModal.onclick = (e) => {
                    if (e.target === delModal) delModal.style.display = "none";
                  };
                  delModal.querySelector("#cancelDeleteEventBtn").onclick =
                    () => (delModal.style.display = "none");
                }
                delModal.style.display = "block";
                delModal.querySelector("#confirmDeleteEventBtn").onclick =
                  function () {
                    openDB().then((db) => {
                      const tx = db.transaction("events", "readwrite");
                      const store = tx.objectStore("events");
                      store.delete(id);
                      tx.oncomplete = () => {
                        rerender();
                        eventsModal.style.display = "none";
                        delModal.style.display = "none";
                        showToast("Event deleted!", { type: "success" });
                      };
                    });
                  };
              };
            });
          });
        };
        // --- Select Dates Functionality ---
        let selectingDates = false;
        let selectedDates = new Set();

        const selectBtn = document.getElementById("selectBtn");
        const shareBtn = document.getElementById("shareBtn");
        const printBtn = document.getElementById("printBtn");
        const newEventBtn = document.getElementById("newEventBtn");

        function updateSelectButtons() {
          const hasSelection = selectedDates.size > 0;
          shareBtn.disabled = !hasSelection;
          printBtn.disabled = !hasSelection;
          newEventBtn.disabled = !hasSelection;
          if (hasSelection) {
            shareBtn.classList.remove("disabled");
            printBtn.classList.remove("disabled");
            newEventBtn.classList.remove("disabled");
          } else {
            shareBtn.classList.add("disabled");
            printBtn.classList.add("disabled");
            newEventBtn.classList.add("disabled");
          }
        }

        function clearSelectedDates() {
          selectedDates.clear();
          document
            .querySelectorAll(
              ".calendar__dates_button, .calendar__dates__today",
            )
            .forEach((el) => {
              el.classList.remove("selected-date");
              el.style.outline = "";
              el.style.boxShadow = "";
            });
          updateSelectButtons();
        }

        // Add select mode toggle
        selectBtn.onclick = function () {
          selectingDates = !selectingDates;
          if (selectingDates) {
            selectBtn.classList.add("btn-primary");
            selectBtn.querySelector(".btn__right__text").textContent =
              "Selecting...";
            clearSelectedDates();
            // Add visual cue
            document.body.style.cursor = "crosshair";
          } else {
            selectBtn.classList.remove("btn-primary");
            selectBtn.querySelector(".btn__right__text").textContent = "Select";
            clearSelectedDates();
            document.body.style.cursor = "";
          }
        };

        // Style for selected dates
        const style = document.createElement("style");
        style.textContent = `
                    .selected-date {
                        outline: 2px solid #ffe066 !important;
                        box-shadow: 0 0 0 3px #ffe06655 !important;
                        position: relative;
                    }
                `;
        document.head.appendChild(style);

        // Click to select dates in month view
        calendarMainContent.addEventListener(
          "click",
          function (e) {
            if (!selectingDates) return;
            let target = e.target;
            while (
              target &&
              !target.classList.contains("calendar__dates_button") &&
              !target.classList.contains("calendar__dates__today")
            ) {
              target = target.parentElement;
            }
            if (
              !target ||
              (!target.classList.contains("calendar__dates_button") &&
                !target.classList.contains("calendar__dates__today"))
            )
              return;
            let day = parseInt(target.textContent, 10);
            if (!day || isNaN(day)) return;
            let key = `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
            if (selectedDates.has(key)) {
              selectedDates.delete(key);
              target.classList.remove("selected-date");
              target.style.outline = "";
              target.style.boxShadow = "";
            } else {
              selectedDates.add(key);
              target.classList.add("selected-date");
              target.style.outline = "2px solid #ffe066";
              target.style.boxShadow = "0 0 0 3px #ffe06655";
            }
            updateSelectButtons();
          },
          true,
        );

        // When rerendering, restore selected dates highlight
        const origRerender = rerender;
        rerender = function () {
          origRerender();
          // Restore highlights after DOM update
          setTimeout(() => {
            if (selectingDates) {
              selectedDates.forEach((key) => {
                let [year, month, day] = key.split("-").map(Number);
                if (year === currentYear && month === currentMonth + 1) {
                  document
                    .querySelectorAll(
                      ".calendar__dates_button, .calendar__dates__today",
                    )
                    .forEach((el) => {
                      let elDay = parseInt(el.textContent, 10);
                      if (elDay === day) {
                        el.classList.add("selected-date");
                        el.style.outline = "2px solid #ffe066";
                        el.style.boxShadow = "0 0 0 3px #ffe06655";
                      }
                    });
                }
              });
            }
            updateSelectButtons();
          }, 0);
        };

        // Share/Print/New Event for selected dates
        shareBtn.onclick = function () {
          if (shareBtn.disabled || selectedDates.size === 0) return;
          // If one date, show share modal for that date
          // If multiple, show modal with all dates
          const keys = Array.from(selectedDates);
          if (keys.length === 1) {
            let [year, month, day] = keys[0].split("-").map(Number);
            showShareModal(year, month - 1, day);
          } else {
            // Show modal with all selected dates
            let modal = document.createElement("div");
            modal.className = "modal";
            modal.style.zIndex = 4000;
            modal.innerHTML = `
                            <div class="modal__content liquid-glass" style="max-width:420px;">
                                <div class="modal__header">
                                    <h2>Share Selected Dates</h2>
                                    <div class="icon" id="closeMultiShareModal" title="Close" aria-label="Close">close</div>
                                </div>
                                <div class="modal__body" id="multiShareModalBody"></div>
                            </div>
                        `;
            document.body.appendChild(modal);
            modal.querySelector("#closeMultiShareModal").onclick = () =>
              (modal.style.display = "none");
            modal.onclick = (e) => {
              if (e.target === modal) modal.style.display = "none";
            };
            let html =
              '<div style="margin-bottom:10px;font-size:16px;color:#fff;">Selected Dates:</div>';
            keys.forEach((key) => {
              let [year, month, day] = key.split("-").map(Number);
              let dateObj = new Date(year, month - 1, day);
              html += `<div style="color:#ffe066;">${dateObj.toLocaleDateString(undefined, { weekday: "long", month: "long", day: "numeric", year: "numeric" })}</div>`;
            });
            let url =
              window.location.origin +
              window.location.pathname +
              `?dates=${keys.join(",")}`;
            let text =
              `Check out these dates:\n` +
              keys
                .map((key) => {
                  let [year, month, day] = key.split("-").map(Number);
                  let dateObj = new Date(year, month - 1, day);
                  return dateObj.toLocaleDateString(undefined, {
                    weekday: "long",
                    month: "long",
                    day: "numeric",
                    year: "numeric",
                  });
                })
                .join("\n");
            html += `<div style="margin-top:10px;">
                            <munetios-button id="copyMultiShareBtn"><div class="icon">content_copy</div>Copy</munetios-button>
                        </div>`;
            modal.querySelector("#multiShareModalBody").innerHTML = html;
            modal.querySelector("#copyMultiShareBtn").onclick = function () {
              navigator.clipboard.writeText(`${text}\n${url}`);
              showToast("Copied!");
            };
            modal.style.display = "block";
          }
        };

        printBtn.onclick = function () {
          if (printBtn.disabled || selectedDates.size === 0) return;
          const keys = Array.from(selectedDates);
          if (keys.length === 1) {
            let [year, month, day] = keys[0].split("-").map(Number);
            showPrintModal(year, month - 1, day);
          } else {
            // Print all selected dates
            let html =
              '<div style="margin-bottom:10px;font-size:16px;color:#222;">Selected Dates:</div>';
            keys.forEach((key) => {
              let [year, month, day] = key.split("-").map(Number);
              let dateObj = new Date(year, month - 1, day);
              html += `<div style="color:#6300ee;">${dateObj.toLocaleDateString(undefined, { weekday: "long", month: "long", day: "numeric", year: "numeric" })}</div>`;
            });
            let win = window.open("", "", "width=600,height=700");
            win.document.write(
              `<html><head><title>Print</title></head><body style="font-family:sans-serif;color:#222;background:#fff;padding:24px;">${html}</body></html>`,
            );
            win.document.close();
            win.focus();
            win.print();
          }
        };

        newEventBtn.onclick = function () {
          if (newEventBtn.disabled || selectedDates.size === 0) return;
          // If one date, open modal with that date
          // If multiple, open modal for first date and show a note
          const keys = Array.from(selectedDates);
          let [year, month, day] = keys[0].split("-").map(Number);
          showModal(createEventModal);
          document.getElementById("eventDate").value =
            `${year}-${String(month).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
          if (keys.length > 1) {
            showToast("Event will be created for the first selected date.", {
              type: "info",
            });
          }
        };
        calendarMainContent.addEventListener("click", function (e) {
          // Only in month view, only .calendar__dates_button (not .calendar__dates__today)
          if (currentView !== "month") return;
          let target = e.target;
          while (
            target &&
            !target.classList.contains("calendar__dates_button") &&
            !target.classList.contains("calendar__dates__today")
          ) {
            target = target.parentElement;
          }
          if (
            !target ||
            (!target.classList.contains("calendar__dates_button") &&
              !target.classList.contains("calendar__dates__today"))
          )
            return;
          // Find day number
          let day = parseInt(target.textContent, 10);
          if (!day || isNaN(day)) return;
          // Remove any existing dropdown
          document
            .querySelectorAll(".calendar-dropdown-menu")
            .forEach((m) => m.remove());
          // Build dropdown
          const dropdown = document.createElement("munetios-dropdown-menu");
          dropdown.className = "calendar-dropdown-menu";
          dropdown.style.position = "fixed";
          dropdown.style.display = "flex";
          dropdown.style.flexDirection = "column";
          dropdown.style.zIndex = 9999999;
          dropdown.style.minWidth = "180px";
          dropdown.innerHTML = `
                        <div class="dropdown-item" data-action="new">New Event</div>
                        <div class="dropdown-item" data-action="share">Share</div>
                        <div class="dropdown-item" data-action="print">Print</div>
                        <div class="dropdown-item" data-action="favorite">Favorite</div>
                    `;
          // Position dropdown near click
          let rect = target.getBoundingClientRect();
          dropdown.style.top = rect.bottom + window.scrollY + "px";
          dropdown.style.left = rect.left + window.scrollX + "px";
          document.body.appendChild(dropdown);

          // Hide on click outside
          setTimeout(() => {
            function hide(ev) {
              if (!dropdown.contains(ev.target)) {
                dropdown.remove();
                document.removeEventListener("mousedown", hide);
              }
            }
            document.addEventListener("mousedown", hide);
          }, 0);

          // Dropdown actions
          dropdown.querySelectorAll(".dropdown-item").forEach((item) => {
            item.onclick = function () {
              dropdown.remove();
              if (this.dataset.action === "new") {
                // Open create event modal, autofill date
                showModal(createEventModal);
                document.getElementById("eventDate").value =
                  `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
              } else if (this.dataset.action === "share") {
                showShareModal(currentYear, currentMonth, day);
              } else if (this.dataset.action === "print") {
                showPrintModal(currentYear, currentMonth, day);
              } else if (this.dataset.action === "favorite") {
                addFavoriteDate(currentYear, currentMonth, day);
              }
            };
          });
        });

        // --- Share Modal ---
        let shareModal = null;
        function showShareModal(year, month, day) {
          if (!shareModal) {
            shareModal = document.createElement("div");
            shareModal.className = "modal";
            shareModal.style.zIndex = 4000;
            shareModal.innerHTML = `
                            <div class="modal__content liquid-glass" style="width: auto;">
                                <div class="modal__header">
                                    <h2>Share This Date</h2>
                                    <div class="icon" id="closeShareModal" title="Close" aria-label="Close">close</div>
                                </div>
                                <div class="modal__body" id="shareModalBody"></div>
                            </div>
                        `;
            document.body.appendChild(shareModal);
            shareModal.querySelector("#closeShareModal").onclick = () =>
              (shareModal.style.display = "none");
            shareModal.onclick = (e) => {
              if (e.target === shareModal) shareModal.style.display = "none";
            };
          }
          // Fill modal body
          let dateObj = new Date(year, month, day);
          let dateStr = dateObj.toLocaleDateString(undefined, {
            weekday: "long",
            month: "long",
            day: "numeric",
            year: "numeric",
          });
          let url =
            window.location.origin +
            window.location.pathname +
            `?date=${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
          let text = `Check out this date: ${dateStr}`;
          let shareRows = [
            [
              {
                label: "Copy",
                icon: "content_copy",
                action: () => {
                  navigator.clipboard.writeText(`${text}\n${url}`);
                  showToast("Copied!");
                },
              },
              {
                label: "Email",
                icon: "mail",
                href: `mailto:?subject=${encodeURIComponent(text)}&body=${encodeURIComponent(url)}`,
              },
              {
                label: "Gmail",
                icon: "mail",
                href: `https://mail.google.com/mail/?view=cm&fs=1&su=${encodeURIComponent(text)}&body=${encodeURIComponent(url)}`,
              },
              ,
              {
                label: "Google Docs",
                icon: "description",
                action: () => {
                  // Create a new Google Docs document with the date as the title
                  let docTitle = encodeURIComponent(dateStr);
                  let docsUrl = `https://docs.google.com/document/create?title=${docTitle}`;
                  window.open(docsUrl, "_self");
                },
              },

              {
                label: "Facebook",
                icon: "public",
                href: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
              },
              {
                label: "X",
                icon: "public",
                href: `https://x.com/intent/tweet?text=${encodeURIComponent(text)}%20${encodeURIComponent(url)}`,
              },
              {
                label: "WhatsApp",
                icon: "chat",
                href: `https://wa.me/?text=${encodeURIComponent(text)}%20${encodeURIComponent(url)}`,
              },
              {
                label: "KakaoTalk",
                icon: "chat",
                href: `https://sharer.kakao.com/talk/friends/picker/link?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`,
              },

              {
                label: "Reddit",
                icon: "public",
                href: `https://reddit.com/submit?url=${encodeURIComponent(url)}&title=${encodeURIComponent(text)}`,
              },
              {
                label: "VK",
                icon: "public",
                href: `https://vk.com/share.php?url=${encodeURIComponent(url)}&title=${encodeURIComponent(text)}`,
              },
              {
                label: "OK",
                icon: "public",
                href: `https://connect.ok.ru/offer?url=${encodeURIComponent(url)}&title=${encodeURIComponent(text)}`,
              },
              {
                label: "Pinterest",
                icon: "public",
                href: `https://pinterest.com/pin/create/button/?url=${encodeURIComponent(url)}&description=${encodeURIComponent(text)}`,
              },
              {
                label: "Tumblr",
                icon: "public",
                href: `https://www.tumblr.com/widgets/share/tool?canonicalUrl=${encodeURIComponent(url)}&title=${encodeURIComponent(text)}`,
              },
              {
                label: "LinkedIN",
                icon: "public",
                href: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`,
              },
              {
                label: "ChatGPT",
                icon: "smart_toy",
                href: `https://chatgpt.com/?q=${encodeURIComponent(text + " " + url)}`,
              },
            ],
          ];
          let html = `<div style="margin-bottom:10px;font-size:16px;color:#fff;">${dateStr}</div>`;
          shareRows.forEach((row) => {
            html += `<div style="display:flex;gap:10px;margin-bottom:8px; flex-wrap: nowrap; overflow-x: auto;">`;
            row.forEach((btn) => {
              if (btn.action) {
                html += `<munetios-button style="flex:1;justify-content:center;" title="${btn.label}" aria-label="${btn.label}"><div class="icon">${btn.icon}</div><span>${btn.label}</span></munetios-button>`;
              } else {
                html += `<a href="${btn.href}" style="flex:1;text-decoration:none;" title="${btn.label}" aria-label="${btn.label}"><munetios-button style="width:100%;justify-content:center;"><div class="icon">${btn.icon}</div><span>${btn.label}</span></munetios-button></a>`;
              }
            });
            html += `</div>`;
          });
          shareModal.querySelector("#shareModalBody").innerHTML = html;
          // Attach actions
          let idx = 0;
          shareRows.forEach((row) => {
            row.forEach((btn, i) => {
              if (btn.action) {
                let el = shareModal.querySelectorAll("munetios-button")[idx];
                el.onclick = btn.action;
              }
              idx++;
            });
          });
          // All links open in same tab
          shareModal.querySelectorAll("a").forEach((a) => (a.target = ""));
          shareModal.style.display = "block";
        }

        // --- Print Modal ---
        let printModal = null;
        function showPrintModal(year, month, day) {
          if (!printModal) {
            printModal = document.createElement("div");
            printModal.className = "modal";
            printModal.style.zIndex = 4000;
            printModal.innerHTML = `
                            <div class="modal__content liquid-glass" style="max-width:420px;">
                                <div class="modal__header">
                                    <h2>Print This Date</h2>
                                    <div class="icon" id="closePrintModal" title="Close" aria-label="Close">close</div>
                                </div>
                                <div class="modal__body" id="printModalBody"></div>
                                <div class="modal__footer">
                                    <munetios-button class="btn-primary" id="printNowBtn">Print</munetios-button>
                                </div>
                            </div>
                        `;
            document.body.appendChild(printModal);
            printModal.querySelector("#closePrintModal").onclick = () =>
              (printModal.style.display = "none");
            printModal.onclick = (e) => {
              if (e.target === printModal) printModal.style.display = "none";
            };
          }
          let dateObj = new Date(year, month, day);
          let dateStr = dateObj.toLocaleDateString(undefined, {
            weekday: "long",
            month: "long",
            day: "numeric",
            year: "numeric",
          });
          // Gather holidays, birthdays, events for this day
          let holidaysToday = getHolidaysForMonth(month, year).filter(
            (h) => h.day === day,
          );
          Promise.all([
            getEventsForMonth(month, year),
            getBirthdaysForMonth(month, year),
          ]).then(([events, birthdays]) => {
            let eventsToday = events.filter((ev) => {
              let parts = ev.date.split("-");
              let d = new Date(
                Number(parts[0]),
                Number(parts[1]) - 1,
                Number(parts[2]),
              );
              return (
                d.getDate() === day &&
                d.getMonth() === month &&
                d.getFullYear() === year
              );
            });
            let birthdaysToday = birthdays.filter((bd) => {
              if (!bd.date) return false;
              let parts = bd.date.split("-");
              if (parts.length < 3) return false;
              let d = new Date(
                Number(parts[0]),
                Number(parts[1]) - 1,
                Number(parts[2]),
              );
              return d.getDate() === day && d.getMonth() === month;
            });
            let html = `<div style="margin-bottom:10px;font-size:16px;color:#fff;">${dateStr}</div>`;
            html += `<div><b>Holidays:</b><br>${holidaysToday.length ? holidaysToday.map((h) => `<span style="color:#ffe066;">${h.name}</span>`).join("<br>") : '<span style="opacity:.7;">None</span>'}</div>`;
            html += `<div style="margin-top:8px;"><b>Birthdays:</b><br>${birthdaysToday.length ? birthdaysToday.map((bd) => `<span style="color:${bd.color};">🎂 ${bd.name}</span>`).join("<br>") : '<span style="opacity:.7;">None</span>'}</div>`;
            html += `<div style="margin-top:8px;"><b>Events:</b><br>${eventsToday.length ? eventsToday.map((ev) => `<span style="color:${ev.color};">${ev.title}</span>`).join("<br>") : '<span style="opacity:.7;">None</span>'}</div>`;
            printModal.querySelector("#printModalBody").innerHTML = html;
            printModal.style.display = "block";
            printModal.querySelector("#printNowBtn").onclick = function () {
              let win = window.open("", "", "width=600,height=700");
              win.document.write(
                `<html><head><title>Print</title></head><body style="font-family:sans-serif;color:#222;background:#fff;padding:24px;">${html.replace(/color:/g, "color:")}</body></html>`,
              );
              win.document.close();
              win.focus();
              win.print();
            };
          });
        }

        // --- Favorite logic ---
        function getFavoriteDates() {
          return JSON.parse(localStorage.getItem("favoriteDates") || "[]");
        }
        function setFavoriteDates(arr) {
          localStorage.setItem("favoriteDates", JSON.stringify(arr));
        }
        function addFavoriteDate(year, month, day) {
          let arr = getFavoriteDates();
          let key = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
          if (!arr.includes(key)) arr.push(key);
          setFavoriteDates(arr);
          showToast("Added to Favorites!", { type: "success" });
          updateFavoritesModal();
        }
        function removeFavoriteDate(key) {
          let arr = getFavoriteDates().filter((k) => k !== key);
          setFavoriteDates(arr);
          updateFavoritesModal();
        }

        // --- Favorites Modal ---
        let favoritesModal = null;
        function showFavoritesModal() {
          if (!favoritesModal) {
            favoritesModal = document.createElement("div");
            favoritesModal.className = "modal";
            favoritesModal.style.zIndex = 4000;
            favoritesModal.innerHTML = `
                            <div class="modal__content liquid-glass" style="max-width:420px;">
                                <div class="modal__header">
                                    <h2>Favorites</h2>
                                    <div class="icon" id="closeFavoritesModal" title="Close" aria-label="Close">close</div>
                                </div>
                                <div class="modal__body" id="favoritesModalBody"></div>
                            </div>
                        `;
            document.body.appendChild(favoritesModal);
            favoritesModal.querySelector("#closeFavoritesModal").onclick = () =>
              (favoritesModal.style.display = "none");
            favoritesModal.onclick = (e) => {
              if (e.target === favoritesModal)
                favoritesModal.style.display = "none";
            };
          }
          updateFavoritesModal();
          favoritesModal.style.display = "block";
        }
        function updateFavoritesModal() {
          if (!favoritesModal) return;
          let arr = getFavoriteDates();
          if (!arr.length) {
            favoritesModal.querySelector("#favoritesModalBody").innerHTML =
              `<div style="color:#fff;opacity:.7;">No favorites yet.</div>`;
            return;
          }
          let html = "";
          arr.forEach((key) => {
            let [year, month, day] = key.split("-").map(Number);
            let dateObj = new Date(year, month - 1, day);
            let dateStr = dateObj.toLocaleDateString(undefined, {
              weekday: "long",
              month: "long",
              day: "numeric",
              year: "numeric",
            });
            // Gather holidays, birthdays, events for this day
            let holidaysToday = getHolidaysForMonth(month - 1, year).filter(
              (h) => h.day === day,
            );
            html += `<div style="margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.08);">
                            <div style="font-weight:bold;color:#fff;">${dateStr}</div>
                            <div style="font-size:13px;color:#ffe066;">${holidaysToday.map((h) => h.name).join(", ")}</div>
                            <munetios-button style="margin-top:4px;" data-key="${key}" class="remove-fav-btn"><div class="icon">delete</div>Remove</munetios-button>
                        </div>`;
          });
          favoritesModal.querySelector("#favoritesModalBody").innerHTML = html;
          favoritesModal.querySelectorAll(".remove-fav-btn").forEach((btn) => {
            btn.onclick = function () {
              removeFavoriteDate(this.getAttribute("data-key"));
            };
          });
        }

        // Topbar favorites icon
        document.getElementById("favoritesBtn").onclick = showFavoritesModal;
        // IndexedDB setup for events and birthdays with End-to-End Encryption
        const DB_NAME = "munetios_calendar";
        const DB_VERSION = 2;
        let db = null;
        let encryptionKey = null;

        // Encryption functions using Web Crypto API
        async function getOrCreateEncryptionKey() {
          if (encryptionKey) return encryptionKey;

          return openDB().then((database) => {
            const tx = database.transaction(["encryption"], "readwrite");
            const store = tx.objectStore("encryption");

            return new Promise((resolve, reject) => {
              const request = store.get("masterKey");

              request.onsuccess = async function () {
                if (request.result && request.result.key) {
                  // Key exists, use it (stored as ArrayBuffer)
                  encryptionKey = await crypto.subtle.importKey(
                    "raw",
                    request.result.key,
                    { name: "AES-GCM" },
                    false,
                    ["encrypt", "decrypt"],
                  );
                  resolve(encryptionKey);
                } else {
                  // Generate new key
                  const newKey = await crypto.subtle.generateKey(
                    { name: "AES-GCM", length: 256 },
                    true,
                    ["encrypt", "decrypt"],
                  );

                  // Export and store as ArrayBuffer (shows as ArrayBuffer(32) in devtools)
                  const exportedKey = await crypto.subtle.exportKey(
                    "raw",
                    newKey,
                  );
                  const saveRequest = store.put({
                    id: "masterKey",
                    key: exportedKey,
                  });

                  saveRequest.onsuccess = function () {
                    encryptionKey = newKey;
                    resolve(newKey);
                  };
                  saveRequest.onerror = () => reject(saveRequest.error);
                }
              };
              request.onerror = () => reject(request.error);
            });
          });
        }

        async function encryptData(data) {
          const key = await getOrCreateEncryptionKey();
          const iv = crypto.getRandomValues(new Uint8Array(12));
          const encodedData = new TextEncoder().encode(JSON.stringify(data));

          const encryptedData = await crypto.subtle.encrypt(
            { name: "AES-GCM", iv: iv },
            key,
            encodedData,
          );

          // Return IV + encrypted data as base64
          const combined = new Uint8Array(iv.length + encryptedData.byteLength);
          combined.set(iv, 0);
          combined.set(new Uint8Array(encryptedData), iv.length);

          return btoa(String.fromCharCode(...combined));
        }

        async function decryptData(encryptedString) {
          try {
            const key = await getOrCreateEncryptionKey();
            const combined = Uint8Array.from(atob(encryptedString), (c) =>
              c.charCodeAt(0),
            );

            const iv = combined.slice(0, 12);
            const data = combined.slice(12);

            const decryptedData = await crypto.subtle.decrypt(
              { name: "AES-GCM", iv: iv },
              key,
              data,
            );

            const decodedData = new TextDecoder().decode(decryptedData);
            return JSON.parse(decodedData);
          } catch (e) {
            console.error("Decryption failed:", e);
            return null;
          }
        }

        async function resetEncryptionKey() {
          return openDB().then(async (database) => {
            // Generate new key
            const newKey = await crypto.subtle.generateKey(
              { name: "AES-GCM", length: 256 },
              true,
              ["encrypt", "decrypt"],
            );

            // Export and store as ArrayBuffer (shows as ArrayBuffer(32) in devtools)
            const exportedKey = await crypto.subtle.exportKey("raw", newKey);

            const tx = database.transaction(["encryption"], "readwrite");
            const store = tx.objectStore("encryption");

            return new Promise((resolve, reject) => {
              const request = store.put({ id: "masterKey", key: exportedKey });
              request.onsuccess = function () {
                encryptionKey = newKey;
                resolve();
              };
              request.onerror = () => reject(request.error);
            });
          });
        }

        function openDB() {
          return new Promise((resolve, reject) => {
            if (db) return resolve(db);
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = function (e) {
              const database = e.target.result;
              if (!database.objectStoreNames.contains("events")) {
                database.createObjectStore("events", {
                  keyPath: "id",
                  autoIncrement: true,
                });
              }
              if (!database.objectStoreNames.contains("birthdays")) {
                database.createObjectStore("birthdays", {
                  keyPath: "id",
                  autoIncrement: true,
                });
              }
              // Create encryption store for storing the key as ArrayBuffer
              if (!database.objectStoreNames.contains("encryption")) {
                database.createObjectStore("encryption", { keyPath: "id" });
              }
            };
            req.onsuccess = function (e) {
              db = e.target.result;
              resolve(db);
            };
            req.onerror = function (e) {
              reject(e);
            };
          });
        }

        async function saveEventToDB(event) {
          const encrypted = await encryptData(event);
          return openDB().then((db) => {
            return new Promise((resolve, reject) => {
              const tx = db.transaction("events", "readwrite");
              tx.objectStore("events").add({
                date: event.date,
                calendar: event.calendar,
                encrypted: encrypted,
              });
              tx.oncomplete = resolve;
              tx.onerror = reject;
            });
          });
        }

        async function saveBirthdayToDB(birthday) {
          const encrypted = await encryptData(birthday);
          return openDB().then((db) => {
            return new Promise((resolve, reject) => {
              const tx = db.transaction("birthdays", "readwrite");
              tx.objectStore("birthdays").add({
                date: birthday.date,
                calendar: birthday.calendar,
                encrypted: encrypted,
              });
              tx.oncomplete = resolve;
              tx.onerror = reject;
            });
          });
        }

        async function getEventsForMonth(month, year) {
          return openDB().then((db) => {
            return new Promise(async (resolve) => {
              const tx = db.transaction("events", "readonly");
              const store = tx.objectStore("events");
              const req = store.getAll();
              req.onsuccess = async function () {
                const allEvents = req.result || [];
                const decrypted = [];

                for (let item of allEvents) {
                  if (item.encrypted) {
                    const event = await decryptData(item.encrypted);
                    if (event && event.date) {
                      const d = new Date(event.date);
                      if (d.getMonth() === month && d.getFullYear() === year) {
                        decrypted.push(event);
                      }
                    }
                  } else {
                    // Fallback for old unencrypted data
                    const d = new Date(item.date);
                    if (d.getMonth() === month && d.getFullYear() === year) {
                      decrypted.push(item);
                    }
                  }
                }
                resolve(decrypted);
              };
              req.onerror = () => resolve([]);
            });
          });
        }

        async function getBirthdaysForMonth(month, year) {
          return openDB().then((db) => {
            return new Promise(async (resolve) => {
              const tx = db.transaction("birthdays", "readonly");
              const store = tx.objectStore("birthdays");
              const req = store.getAll();
              req.onsuccess = async function () {
                const allBirthdays = req.result || [];
                const decrypted = [];

                for (let item of allBirthdays) {
                  if (item.encrypted) {
                    const birthday = await decryptData(item.encrypted);
                    if (birthday && birthday.date) {
                      const parts = birthday.date.split("-");
                      if (parts.length >= 3) {
                        const d = new Date(
                          Number(parts[0]),
                          Number(parts[1]) - 1,
                          Number(parts[2]),
                        );
                        if (d.getMonth() === month) {
                          decrypted.push(birthday);
                        }
                      }
                    }
                  } else {
                    // Fallback for old unencrypted data
                    if (!item.date) continue;
                    const parts = item.date.split("-");
                    if (parts.length < 3) continue;
                    const d = new Date(
                      Number(parts[0]),
                      Number(parts[1]) - 1,
                      Number(parts[2]),
                    );
                    if (d.getMonth() === month) {
                      decrypted.push(item);
                    }
                  }
                }
                resolve(decrypted);
              };
              req.onerror = () => resolve([]);
            });
          });
        }
        // Filter modal logic moved outside searchAll so filter icon always works
        const filterIcon = document.getElementById("filterBtn");
        let filterModal = null;
        let filterState = {
          types: { event: true, birthday: true, holiday: true },
          has: "",
          notHas: "",
          date: "",
        };
        function createFilterModal() {
          if (filterModal) return filterModal;
          filterModal = document.createElement("div");
          filterModal.className = "modal";
          filterModal.style.zIndex = 4000;
          filterModal.innerHTML = `
                        <div class="modal__content liquid-glass" style="width:340px;">
                            <div class="modal__header">
                                <h2>Filter Search</h2>
                                <div class="icon" id="closeFilterModal" title="Close" aria-label="Close">close</div>
                            </div>
                            <div class="modal__body">
                                <label>Type:</label>
                                <div style="display:flex;gap:10px;margin-bottom:8px;">
                                    <label><input type="checkbox" id="filterTypeEvent" checked> Events</label>
                                    <label><input type="checkbox" id="filterTypeBirthday" checked> Birthdays</label>
                                    <label><input type="checkbox" id="filterTypeHoliday" checked> Holidays</label>
                                </div>
                                <label for="filterHas">Has (text):</label>
                                <input type="text" id="filterHas" placeholder="Must contain..." />
                                <label for="filterNotHas">Doesn't have (text):</label>
                                <input type="text" id="filterNotHas" placeholder="Must not contain..." />
                                <label for="filterDate">Date:</label>
                                <input type="date" id="filterDate" />
                            </div>
                            <div class="modal__footer">
                                <munetios-button class="btn-primary" id="applyFilterBtn">Apply</munetios-button>
                                <munetios-button id="clearFilterBtn">Clear</munetios-button>
                            </div>
                        </div>
                    `;
          document.body.appendChild(filterModal);

          // Close logic
          filterModal.querySelector("#closeFilterModal").onclick = () =>
            (filterModal.style.display = "none");
          filterModal.onclick = (e) => {
            if (e.target === filterModal) filterModal.style.display = "none";
          };

          // Apply filter
          filterModal.querySelector("#applyFilterBtn").onclick = function () {
            filterState.types.event =
              filterModal.querySelector("#filterTypeEvent").checked;
            filterState.types.birthday = filterModal.querySelector(
              "#filterTypeBirthday",
            ).checked;
            filterState.types.holiday =
              filterModal.querySelector("#filterTypeHoliday").checked;
            filterState.has = filterModal
              .querySelector("#filterHas")
              .value.trim()
              .toLowerCase();
            filterState.notHas = filterModal
              .querySelector("#filterNotHas")
              .value.trim()
              .toLowerCase();
            filterState.date = filterModal.querySelector("#filterDate").value;
            filterModal.style.display = "none";
            // Show search results wrapper and trigger search again with filters
            if (searchInput.value.trim()) {
              searchResults.style.display = "block";
              searchAll(searchInput.value).then(showSearchResults);
            }
          };
          // Clear filter
          filterModal.querySelector("#clearFilterBtn").onclick = function () {
            filterModal.querySelector("#filterTypeEvent").checked = true;
            filterModal.querySelector("#filterTypeBirthday").checked = true;
            filterModal.querySelector("#filterTypeHoliday").checked = true;
            filterModal.querySelector("#filterHas").value = "";
            filterModal.querySelector("#filterNotHas").value = "";
            filterModal.querySelector("#filterDate").value = "";
            filterState = {
              types: { event: true, birthday: true, holiday: true },
              has: "",
              notHas: "",
              date: "",
            };
            filterModal.style.display = "none";
            if (searchInput.value.trim()) {
              searchResults.style.display = "block";
              searchAll(searchInput.value).then(showSearchResults);
            }
          };
          return filterModal;
        }
        filterIcon.onclick = function () {
          const modal = createFilterModal();
          // Set current filter state in modal
          modal.querySelector("#filterTypeEvent").checked =
            filterState.types.event;
          modal.querySelector("#filterTypeBirthday").checked =
            filterState.types.birthday;
          modal.querySelector("#filterTypeHoliday").checked =
            filterState.types.holiday;
          modal.querySelector("#filterHas").value = filterState.has;
          modal.querySelector("#filterNotHas").value = filterState.notHas;
          modal.querySelector("#filterDate").value = filterState.date;
          modal.style.display = "block";
        };

        function searchAll(query) {
          // Enhance searchAll to apply filters
          query = query.trim().toLowerCase();
          if (!query) return Promise.resolve([]);
          // Get holidays for current year (all months)
          let year = selectedDate.getFullYear();
          let allHolidays = [];
          for (let m = 0; m < 12; m++) {
            getHolidaysForMonth(m, year).forEach((h) => {
              if (h.name.toLowerCase().includes(query)) {
                allHolidays.push({
                  type: "holiday",
                  name: h.name,
                  date: new Date(year, m, h.day),
                  color: "#ffe066",
                });
              }
            });
          }
          // Get events and birthdays from DB
          return Promise.all([
            openDB().then(
              (db) =>
                new Promise((res) => {
                  const tx = db.transaction("events", "readonly");
                  const store = tx.objectStore("events");
                  const req = store.getAll();
                  req.onsuccess = () => {
                    res(
                      req.result
                        .filter(
                          (ev) =>
                            (ev.title &&
                              ev.title.toLowerCase().includes(query)) ||
                            (ev.desc && ev.desc.toLowerCase().includes(query)),
                        )
                        .map((ev) => ({
                          type: "event",
                          name: ev.title,
                          desc: ev.desc,
                          date: new Date(ev.date),
                          color: ev.color || "#6300ee",
                        })),
                    );
                  };
                  req.onerror = () => res([]);
                }),
            ),
            openDB().then(
              (db) =>
                new Promise((res) => {
                  const tx = db.transaction("birthdays", "readonly");
                  const store = tx.objectStore("birthdays");
                  const req = store.getAll();
                  req.onsuccess = () => {
                    res(
                      req.result
                        .filter(
                          (bd) =>
                            bd.name && bd.name.toLowerCase().includes(query),
                        )
                        .map((bd) => ({
                          type: "birthday",
                          name: bd.name,
                          date: new Date(bd.date),
                          color: bd.color || "#ff69b4",
                        })),
                    );
                  };
                  req.onerror = () => res([]);
                }),
            ),
          ]).then(([events, birthdays]) => {
            // Apply filters
            let results = [...allHolidays, ...events, ...birthdays];
            // Type filter
            results = results.filter((item) => filterState.types[item.type]);
            // Has filter
            if (filterState.has) {
              results = results.filter(
                (item) =>
                  (item.name &&
                    item.name.toLowerCase().includes(filterState.has)) ||
                  (item.desc &&
                    item.desc.toLowerCase().includes(filterState.has)),
              );
            }
            // Not has filter
            if (filterState.notHas) {
              results = results.filter(
                (item) =>
                  (!item.name ||
                    !item.name.toLowerCase().includes(filterState.notHas)) &&
                  (!item.desc ||
                    !item.desc.toLowerCase().includes(filterState.notHas)),
              );
            }
            // Date filter
            if (filterState.date) {
              results = results.filter((item) => {
                if (!item.date) return false;
                // Compare only yyyy-mm-dd
                let d = item.date;
                let y = d.getFullYear();
                let m = (d.getMonth() + 1).toString().padStart(2, "0");
                let day = d.getDate().toString().padStart(2, "0");
                let itemDateStr = `${y}-${m}-${day}`;
                return itemDateStr === filterState.date;
              });
            }
            return results;
          });
        }

        // Show/hide search results
        function showSearchResults(results) {
          if (!results.length) {
            searchResults.innerHTML = `<div style="color:#fff;padding:18px 0;">No results found.</div>`;
            searchResults.style.display = "block";
            return;
          }
          let html = `<div style="max-height:400px;overflow-y:auto;">`;
          const currentYear = new Date().getFullYear();
          results.forEach((item) => {
            let icon =
              item.type === "holiday"
                ? "event"
                : item.type === "birthday"
                  ? "cake"
                  : "event_note";
            let color = item.color || "#fff";
            let dateObj;
            // For holidays, construct date from year/month/day if available
            if (
              item.type === "holiday" &&
              item.date &&
              !(item.date instanceof Date)
            ) {
              if (
                typeof item.date === "object" &&
                item.date.year !== undefined &&
                item.date.month !== undefined &&
                item.date.day !== undefined
              ) {
                dateObj = new Date(
                  item.date.year,
                  item.date.month,
                  item.date.day,
                );
              } else if (
                item.year !== undefined &&
                item.month !== undefined &&
                item.day !== undefined
              ) {
                dateObj = new Date(item.year, item.month, item.day);
              } else if (
                typeof item.date === "string" ||
                typeof item.date === "number"
              ) {
                dateObj = new Date(item.date);
              } else {
                dateObj = new Date();
              }
            } else if (item.date instanceof Date) {
              dateObj = new Date(item.date);
              // For birthdays and events, add 1 day
              if (item.type === "birthday" || item.type === "event") {
                dateObj.setDate(dateObj.getDate() + 1);
              }
            } else if (
              typeof item.date === "string" ||
              typeof item.date === "number"
            ) {
              dateObj = new Date(item.date);
              // For birthdays and events, add 1 day
              if (item.type === "birthday" || item.type === "event") {
                dateObj.setDate(dateObj.getDate() + 1);
              }
            } else {
              dateObj = new Date();
            }
            let dateStr = dateObj.toLocaleDateString(undefined, {
              month: "short",
              day: "numeric",
              year: "numeric",
            });
            html += `<div class="search-result-item" tabindex="0" style="display:flex;align-items:center;gap:12px;padding:10px 0;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.07);" data-date="${dateObj.toISOString()}">
                            <span class="icon" style="color:${color};font-size:22px;">${icon}</span>
                            <div style="flex:1;">
                                <div style="font-weight:500;color:${color};">${item.name}</div>
                                <div style="font-size:13px;color:#fff;opacity:.7;">${dateStr}${item.desc ? " - " + item.desc : ""}</div>
                            </div>
                        </div>`;
          });
          html += `</div>`;
          searchResults.innerHTML = html;
          searchResults.style.display = "block";

          // Click handler for results
          searchResults
            .querySelectorAll(".search-result-item")
            .forEach((el) => {
              el.onclick = function () {
                let date = new Date(this.getAttribute("data-date"));
                selectedDate = new Date(date);
                currentMonth = selectedDate.getMonth();
                currentYear = selectedDate.getFullYear();
                rerender();
                searchResults.style.display = "none";
              };
              el.onkeydown = function (e) {
                if (e.key === "Enter" || e.key === " ") {
                  this.click();
                }
              };
            });
        }

        // Hide search results on click outside
        document.addEventListener("mousedown", function (e) {
          if (
            !searchBar.contains(e.target) &&
            !searchResults.contains(e.target)
          ) {
            searchResults.style.display = "none";
          }
        });

        // Search input logic
        const searchInput = document.getElementById("searchInput");
        searchInput.addEventListener("input", function () {
          let q = this.value;
          if (!q.trim()) {
            searchResults.style.display = "none";
            return;
          }
          searchAll(q).then(showSearchResults);
        });

        // Show search results on focus if input has value
        searchInput.addEventListener("focus", function () {
          if (this.value.trim()) {
            searchAll(this.value).then(showSearchResults);
          }
        });
        // Mobile search icon logic
        const mobileSearchIcon = document.getElementById("mobileSearchIcon");
        let mobileSearchActive = false;

        function showMobileSearchBar() {
          // Create mobile search bar if not exists
          let mobileBar = document.getElementById("mobileSearchBar");
          if (!mobileBar) {
            mobileBar = document.createElement("div");
            mobileBar.id = "mobileSearchBar";
            mobileBar.className = "liquid-glass";
            mobileBar.style.display = "flex";
            mobileBar.style.alignItems = "center";
            mobileBar.style.gap = "10px";
            mobileBar.style.width = "100%";
            mobileBar.style.height = "50px";
            mobileBar.style.position = "fixed";
            mobileBar.style.top = "60px";
            mobileBar.style.left = "0";
            mobileBar.style.zIndex = "2501";
            mobileBar.style.background =
              "linear-gradient(to bottom, rgba(255,255,255,0.05), rgba(255,255,255,0.1))";
            mobileBar.style.padding = "0 10px";
            mobileBar.innerHTML = `
                            <div class="icon" id="mobileBackIcon" style="font-size:28px;">arrow_back</div>
                            <input type="text" id="mobileSearchInput" placeholder="Search" style="flex:1;height:30px;border:none;outline:none;background:transparent;color:#fff;font-size:16px;" />
                            <div class="icon" id="mobileFilterBtn" style="font-size:28px;">tune</div>
                        `;
            document.body.appendChild(mobileBar);
          } else {
            mobileBar.style.display = "flex";
          }
          // Focus input
          setTimeout(() => {
            document.getElementById("mobileSearchInput").focus();
          }, 100);

          // Show search results wrapper below mobile bar
          searchResults.style.top = "110px";
          searchResults.style.left = "0";
          searchResults.style.right = "0";
          searchResults.style.width = "100vw";
          searchResults.style.position = "fixed";
          searchResults.style.zIndex = "2502";

          // Sync input value with desktop search
          document.getElementById("mobileSearchInput").value =
            searchInput.value;

          // Handlers
          document.getElementById("mobileBackIcon").onclick =
            hideMobileSearchBar;
          document.getElementById("mobileFilterBtn").onclick =
            filterIcon.onclick;

          // Input logic
          document.getElementById("mobileSearchInput").oninput = function () {
            searchInput.value = this.value;
            if (!this.value.trim()) {
              searchResults.style.display = "none";
              return;
            }
            searchAll(this.value).then(showSearchResults);
          };
          document.getElementById("mobileSearchInput").onfocus = function () {
            if (this.value.trim()) {
              searchAll(this.value).then(showSearchResults);
            }
          };

          mobileSearchActive = true;
        }

        function hideMobileSearchBar() {
          // Restore topbar
          document.querySelector(".topbar__left").style.display = "";
          document.querySelector(".topbar__right").style.display = "";
          document.querySelector(".topbar__centered").style.display = "";
          let mobileBar = document.getElementById("mobileSearchBar");
          if (mobileBar) mobileBar.style.display = "none";
          searchResults.style.display = "none";
          mobileSearchActive = false;
        }

        mobileSearchIcon.onclick = function () {
          showMobileSearchBar();
        };

        // Hide mobile search bar on window resize if desktop
        window.addEventListener("resize", function () {
          if (window.innerWidth > 1074 && mobileSearchActive) {
            hideMobileSearchBar();
          }
        });
        // Modal logic
        const createEventModal = document.getElementById("createEventModal");
        const addBirthdayModal = document.getElementById("addBirthdayModal");
        const closeCreateEventModal = document.getElementById(
          "closeCreateEventModal",
        );
        const closeAddBirthdayModal = document.getElementById(
          "closeAddBirthdayModal",
        );
        const saveEventBtn = document.getElementById("saveEventBtn");
        const saveBirthdayBtn = document.getElementById("saveBirthdayBtn");
        const cancelEventBtn = document.getElementById("cancelEventBtn");
        const cancelBirthdayBtn = document.getElementById("cancelBirthdayBtn");
        // Add Calendar modal
        let addCalendarModal = null;
        // Calendar state
        let currentCalendar =
          localStorage.getItem("currentCalendar") || "My Calendar";
        let calendars = JSON.parse(
          localStorage.getItem("calendars") || '["My Calendar"]',
        );
        // Helper: Save calendars to localStorage
        function saveCalendars() {
          localStorage.setItem("calendars", JSON.stringify(calendars));
        }
        function setCurrentCalendar(name) {
          currentCalendar = name;
          localStorage.setItem("currentCalendar", name);
          updateCalendarPicker();
          rerender();
        }
        // Update My Calendars list and highlight current
        function updateCalendarPicker() {
          const picker = document.querySelector(
            ".calendar__picker__my__calendar",
          );
          if (!picker) return;
          picker.innerHTML = "";
          calendars.forEach((cal) => {
            const div = document.createElement("div");
            div.className = "calendar__button__my__calendar";
            div.title = cal;
            div.setAttribute("aria-label", cal);
            div.innerHTML = `<div class="icon">calendar_month</div><span>${cal}</span>`;
            if (cal === currentCalendar) {
              div.style.background = "rgba(99,0,238,0.18)";
              div.style.fontWeight = "bold";
            }
            div.onclick = () => setCurrentCalendar(cal);
            picker.appendChild(div);
          });
          // Add Calendar button
          const addDiv = document.createElement("div");
          addDiv.className = "calendar__button__my__calendar";
          addDiv.innerHTML = `<div class="icon">add</div><span>Add Calendar</span>`;
          addDiv.onclick = showAddCalendarModal;
          picker.appendChild(document.createElement("br"));
          picker.appendChild(addDiv);
        }
        updateCalendarPicker();
        // Add Calendar Modal
        function showAddCalendarModal() {
          if (!addCalendarModal) {
            addCalendarModal = document.createElement("div");
            addCalendarModal.className = "modal";
            addCalendarModal.style.zIndex = 3100;
            addCalendarModal.innerHTML = `
                            <div class="modal__content liquid-glass">
                                <div class="modal__header">
                                    <h2>Add Calendar</h2>
                                    <div class="icon" id="closeAddCalendarModal" title="Close" aria-label="Close">close</div>
                                </div>
                                <div class="modal__body">
                                    <label for="calendarName">Calendar Name:</label>
                                    <input type="text" id="calendarName" required />
                                    <label for="calendarColor">Calendar Color:</label>
                                    <input type="color" id="calendarColor" value="#6300ee" />
                                </div>
                                <div class="modal__footer">
                                    <munetios-button class="btn-primary" id="saveCalendarBtn">Save</munetios-button>
                                    <munetios-button id="cancelCalendarBtn">Cancel</munetios-button>
                                </div>
                            </div>
                        `;
            document.body.appendChild(addCalendarModal);
            addCalendarModal.querySelector("#closeAddCalendarModal").onclick =
              () => (addCalendarModal.style.display = "none");
            addCalendarModal.onclick = (e) => {
              if (e.target === addCalendarModal)
                addCalendarModal.style.display = "none";
            };
            addCalendarModal.querySelector("#cancelCalendarBtn").onclick = () =>
              (addCalendarModal.style.display = "none");
            addCalendarModal.querySelector("#saveCalendarBtn").onclick =
              function () {
                const name = addCalendarModal
                  .querySelector("#calendarName")
                  .value.trim();
                if (!name || calendars.includes(name)) return;
                calendars.push(name);
                saveCalendars();
                setCurrentCalendar(name);
                addCalendarModal.style.display = "none";
              };
          }
          addCalendarModal.querySelector("#calendarName").value = "";
          addCalendarModal.querySelector("#calendarColor").value = "#6300ee";
          addCalendarModal.style.display = "block";
        }
        // Replace Add Birthday button logic to show modal
        document.getElementById("addBirthdayBtn").onclick = () =>
          showModal(addBirthdayModal);

        // --- MODAL CALENDAR DROPDOWN LOGIC ---
        // Helper to show dropdown menu for calendar select
        function showCalendarDropdownMenu(btn, dropdown, onSelect) {
          dropdown.innerHTML = "";
          calendars.forEach((cal) => {
            const item = document.createElement("div");
            item.className = "dropdown-item";
            item.textContent = cal;
            if (cal === btn.getAttribute("data-selected"))
              item.style.fontWeight = "bold";
            item.onclick = () => {
              btn.setAttribute("data-selected", cal);
              btn.querySelector(".calendar-btn-text").textContent = cal;
              dropdown.style.display = "none";
              if (onSelect) onSelect(cal);
            };
            dropdown.appendChild(item);
          });
          // Position dropdown under the button
          const rect = btn.getBoundingClientRect();
          dropdown.style.position = "fixed";
          dropdown.style.top = rect.bottom + window.scrollY + "px";
          dropdown.style.left = rect.left + window.scrollX + "px";
          dropdown.style.display = "flex";
          // Hide on click outside
          setTimeout(() => {
            function hide(e) {
              if (!dropdown.contains(e.target) && e.target !== btn) {
                dropdown.style.display = "none";
                document.removeEventListener("mousedown", hide);
              }
            }
            document.addEventListener("mousedown", hide);
          }, 0);
        }

        // Update modals to include munetios-button for calendar select
        function updateModalCalendars() {
          // For event modal
          let eventBtn = createEventModal.querySelector("#eventCalendarBtn");
          let eventDropdown = createEventModal.querySelector(
            "#eventCalendarDropdown",
          );
          if (!eventBtn) {
            const label = document.createElement("label");
            label.textContent = "Calendar:";
            label.setAttribute("for", "eventCalendarBtn");
            eventBtn = document.createElement("munetios-button");
            eventBtn.id = "eventCalendarBtn";
            eventBtn.type = "button";
            eventBtn.style.marginBottom = "10px";
            eventBtn.innerHTML = `<div class="icon">calendar_month</div><span class="calendar-btn-text">${currentCalendar}</span>`;
            eventBtn.setAttribute("data-selected", currentCalendar);

            eventDropdown = document.createElement("munetios-dropdown-menu");
            eventDropdown.id = "eventCalendarDropdown";
            eventDropdown.style.marginBottom = "10px";
            eventDropdown.style.display = "none";

            const body = createEventModal.querySelector(".modal__body");
            body.insertBefore(label, body.firstChild);
            body.insertBefore(eventBtn, label.nextSibling);
            body.insertBefore(eventDropdown, eventBtn.nextSibling);

            eventBtn.onclick = function (e) {
              e.stopPropagation();
              showCalendarDropdownMenu(eventBtn, eventDropdown);
            };
          } else {
            eventBtn.querySelector(".calendar-btn-text").textContent =
              currentCalendar;
            eventBtn.setAttribute("data-selected", currentCalendar);
          }
          eventDropdown = createEventModal.querySelector(
            "#eventCalendarDropdown",
          );
          eventDropdown.style.display = "none";

          // For birthday modal
          let bdayBtn = addBirthdayModal.querySelector("#birthdayCalendarBtn");
          let bdayDropdown = addBirthdayModal.querySelector(
            "#birthdayCalendarDropdown",
          );
          if (!bdayBtn) {
            const label = document.createElement("label");
            label.textContent = "Calendar:";
            label.setAttribute("for", "birthdayCalendarBtn");
            bdayBtn = document.createElement("munetios-button");
            bdayBtn.id = "birthdayCalendarBtn";
            bdayBtn.type = "button";
            bdayBtn.style.marginBottom = "10px";
            bdayBtn.innerHTML = `<div class="icon">calendar_month</div><span class="calendar-btn-text">${currentCalendar}</span>`;
            bdayBtn.setAttribute("data-selected", currentCalendar);

            bdayDropdown = document.createElement("munetios-dropdown-menu");
            bdayDropdown.id = "birthdayCalendarDropdown";
            bdayDropdown.style.marginBottom = "10px";
            bdayDropdown.style.display = "none";

            const body = addBirthdayModal.querySelector(".modal__body");
            body.insertBefore(label, body.firstChild);
            body.insertBefore(bdayBtn, label.nextSibling);
            body.insertBefore(bdayDropdown, bdayBtn.nextSibling);

            bdayBtn.onclick = function (e) {
              e.stopPropagation();
              showCalendarDropdownMenu(bdayBtn, bdayDropdown);
            };
          } else {
            bdayBtn.querySelector(".calendar-btn-text").textContent =
              currentCalendar;
            bdayBtn.setAttribute("data-selected", currentCalendar);
          }
          bdayDropdown = addBirthdayModal.querySelector(
            "#birthdayCalendarDropdown",
          );
          bdayDropdown.style.display = "none";
        }

        // Show modals with updated calendar dropdowns
        function showModal(modal) {
          updateModalCalendars();
          modal.style.display = "block";
        }
        function hideModal(modal) {
          modal.style.display = "none";
        }
        createEvent.onclick = () => showModal(createEventModal);
        closeCreateEventModal.onclick = () => hideModal(createEventModal);
        cancelEventBtn.onclick = () => hideModal(createEventModal);
        closeAddBirthdayModal.onclick = () => hideModal(addBirthdayModal);
        cancelBirthdayBtn.onclick = () => hideModal(addBirthdayModal);

        // Save event
        saveEventBtn.onclick = function () {
          const title = document.getElementById("eventTitle").value.trim();
          const date = document.getElementById("eventDate").value;
          const time = document.getElementById("eventTime").value;
          const desc = document.getElementById("eventDescription").value.trim();
          const color = document.getElementById("eventColor").value;
          const calendar =
            createEventModal
              .querySelector("#eventCalendarBtn")
              .getAttribute("data-selected") || currentCalendar;
          if (!title || !date) return;
          saveEventToDB({
            title,
            date,
            time,
            desc,
            color,
            calendar,
          }).then(() => {
            hideModal(createEventModal);
            rerender();
            document.getElementById("eventTitle").value = "";
            document.getElementById("eventDate").value = "";
            document.getElementById("eventTime").value = "";
            document.getElementById("eventDescription").value = "";
            document.getElementById("eventColor").value = "#6300ee";
          });
        };
        // Save birthday
        saveBirthdayBtn.onclick = function () {
          const name = document.getElementById("birthdayName").value.trim();
          const date = document.getElementById("birthdayDate").value;
          const color = document.getElementById("birthdayColor").value;
          const calendar =
            addBirthdayModal
              .querySelector("#birthdayCalendarBtn")
              .getAttribute("data-selected") || currentCalendar;
          if (!name || !date) return;
          saveBirthdayToDB({
            name,
            date,
            color,
            calendar,
          }).then(() => {
            hideModal(addBirthdayModal);
            rerender();
            document.getElementById("birthdayName").value = "";
            document.getElementById("birthdayDate").value = "";
            document.getElementById("birthdayColor").value = "#ff69b4";
          });
        };
        // Enhance renderCalendar to show events and birthdays under holidays, filtered by calendar
        const origRenderCalendar = renderCalendar;
        renderCalendar = function (month, year) {
          Promise.all([
            getEventsForMonth(month, year),
            getBirthdaysForMonth(month, year),
          ]).then(([events, birthdays]) => {
            todayDateCalendar.textContent = new Date(
              year,
              month,
            ).toLocaleString("default", { month: "long", year: "numeric" });
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const holidaysThisMonth = showHolidays
              ? getHolidaysForMonth(month, year)
              : [];
            let html = `<div class="calendar__dates__grid">`;
            for (let i = 0; i < firstDay; i++) {
              html += `<div class="calendar__dates_button" style="opacity:.3;cursor:default"></div>`;
            }
            for (let d = 1; d <= daysInMonth; d++) {
              let isToday =
                d === today.getDate() &&
                month === today.getMonth() &&
                year === today.getFullYear();
              let holiday = holidaysThisMonth.find((h) => h.day === d);
              let dayEvents = events.filter((ev) => {
                let parts = ev.date.split("-");
                let evDate = new Date(
                  Number(parts[0]),
                  Number(parts[1]) - 1,
                  Number(parts[2]),
                );
                return (
                  evDate.getDate() === d &&
                  evDate.getMonth() === month &&
                  evDate.getFullYear() === year &&
                  (ev.calendar || "My Calendar") === currentCalendar
                );
              });
              let dayBirthdays = birthdays.filter((bd) => {
                if (!bd.date) return false;
                let parts = bd.date.split("-");
                if (parts.length < 3) return false;
                let bdDate = new Date(
                  Number(parts[0]),
                  Number(parts[1]) - 1,
                  Number(parts[2]),
                );
                return (
                  bdDate.getDate() === d &&
                  bdDate.getMonth() === month &&
                  (bd.calendar || "My Calendar") === currentCalendar
                );
              });
              let classes = isToday
                ? "calendar__dates__today"
                : "calendar__dates_button";
              let content = `${d}`;
              if (holiday) {
                classes += " liquid-glass";
                content += `<div style="font-size:12px;color:#ffe066;margin-top:2px;">${holiday.name}</div>`;
              }
              dayEvents.forEach((ev) => {
                content += `<div style="font-size:12px;margin-top:2px;color:${ev.color};"><span style="display:inline-block;width:10px;height:10px;background:${ev.color};border-radius:50%;margin-right:4px;vertical-align:middle;"></span>${ev.title}</div>`;
              });
              dayBirthdays.forEach((bd) => {
                content += `<div style="font-size:12px;margin-top:2px;color:${bd.color};"><span style="display:inline-block;width:10px;height:10px;background:${bd.color};border-radius:50%;margin-right:4px;vertical-align:middle;"></span>🎂 ${bd.name}</div>`;
              });
              html += `<div class="${classes}">${content}</div>`;
            }
            let totalCells = firstDay + daysInMonth;
            let nextDays = (7 - (totalCells % 7)) % 7;
            for (let i = 1; i <= nextDays; i++) {
              html += `<div class="calendar__dates_button" style="opacity:.3;cursor:default"></div>`;
            }
            html += `</div>`;
            calendarMainContent
              .querySelector(".calendar__content__header")
              .nextElementSibling?.remove();
            calendarMainContent.insertAdjacentHTML("beforeend", html);
          });
        };

        // Enhance week and day view to show events and birthdays
        const origRenderWeekView = renderWeekView;
        renderWeekView = function (month, year, selDate) {
          Promise.all([
            getEventsForMonth(month, year),
            getBirthdaysForMonth(month, year),
          ]).then(([events, birthdays]) => {
            // Use selectedDate as anchor for week view
            let anchorDate = selDate
              ? new Date(selDate)
              : new Date(year, month, 1);
            // Clamp anchorDate to the correct month/year if needed
            if (
              anchorDate.getMonth() !== month ||
              anchorDate.getFullYear() !== year
            ) {
              anchorDate = new Date(year, month, 1);
              selectedDate = new Date(anchorDate);
            }
            // Find the Sunday of the week containing anchorDate
            let weekStart = new Date(anchorDate);
            weekStart.setDate(anchorDate.getDate() - weekStart.getDay());
            let weekDays = [];
            for (let i = 0; i < 7; i++) {
              let d = new Date(weekStart);
              d.setDate(weekStart.getDate() + i);
              weekDays.push(d);
            }

            // Header
            todayDateCalendar.textContent = `${weekDays[0].toLocaleDateString(undefined, { month: "short", day: "numeric" })} - ${weekDays[6].toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" })}`;
            // Build week grid: first column is time, next 7 columns are days
            let html = `<div class="calendar__dates__grid" style="display:grid;grid-template-columns:80px repeat(7,1fr);height:auto;min-height:600px;">`;

            // Header row: blank for time, then days
            html += `<div style="background:transparent"></div>`;
            for (let i = 0; i < 7; i++) {
              html += `<div style="font-weight:bold;color:#fff;text-align:center;padding:8px 0 8px 0;background:rgba(255,255,255,0.04);border-radius:10px;">${weekDays[i].toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric" })}</div>`;
            }

            // 24 hour time slots (12AM to 11PM)
            for (let hour = 0; hour < 24; hour++) {
              let ampm = hour < 12 ? "AM" : "PM";
              let displayHour = hour % 12 === 0 ? 12 : hour % 12;
              html += `<div style="text-align:right;padding:6px 8px 6px 0;color:#ffe066;font-size:13px;opacity:.7">${displayHour}:00 ${ampm}</div>`;
              for (let d = 0; d < 7; d++) {
                // Highlight today in the week view with dark purple
                let isToday =
                  weekDays[d].toDateString() === new Date().toDateString();
                let classes = "calendar__dates_button";
                let style = "border-radius:8px;min-height:32px;";
                if (isToday) {
                  classes += " calendar__dates__today";
                  style += "background:rgba(99,0,238,0.548);";
                } else {
                  style += "background:rgba(99,0,238,0.18);";
                }

                // Show events and birthdays for this day/hour
                let cellDate = new Date(weekDays[d]);
                cellDate.setHours(hour, 0, 0, 0);
                let dayEvents = events.filter((ev) => {
                  let evDate = new Date(
                    ev.date + (ev.time ? "T" + ev.time : ""),
                  );
                  return (
                    evDate.getFullYear() === cellDate.getFullYear() &&
                    evDate.getMonth() === cellDate.getMonth() &&
                    evDate.getDate() === cellDate.getDate() &&
                    (ev.time ? evDate.getHours() === hour : true)
                  );
                });
                let dayBirthdays = birthdays.filter((bd) => {
                  if (!bd.date) return false;
                  let parts = bd.date.split("-");
                  if (parts.length < 3) return false;
                  let bdDate = new Date(
                    Number(parts[0]),
                    Number(parts[1]) - 1,
                    Number(parts[2]),
                  );
                  return (
                    bdDate.getMonth() === cellDate.getMonth() &&
                    bdDate.getDate() === cellDate.getDate()
                  );
                });

                let content = "";
                dayEvents.forEach((ev) => {
                  content += `<div style="font-size:12px;margin-top:2px;color:${ev.color};"><span style="display:inline-block;width:10px;height:10px;background:${ev.color};border-radius:50%;margin-right:4px;vertical-align:middle;"></span>${ev.title}</div>`;
                });
                dayBirthdays.forEach((bd) => {
                  content += `<div style="font-size:12px;margin-top:2px;color:${bd.color};"><span style="display:inline-block;width:10px;height:10px;background:${bd.color};border-radius:50%;margin-right:4px;vertical-align:middle;"></span>🎂 ${bd.name}</div>`;
                });

                html += `<div class="${classes}" style="${style}">${content}</div>`;
              }
            }

            html += `</div>`;
            calendarMainContent
              .querySelector(".calendar__content__header")
              .nextElementSibling?.remove();
            calendarMainContent.insertAdjacentHTML("beforeend", html);
          });
        };

        const origRenderDayView = renderDayView;
        renderDayView = function (month, year, selDate) {
          Promise.all([
            getEventsForMonth(month, year),
            getBirthdaysForMonth(month, year),
          ]).then(([events, birthdays]) => {
            // Use selectedDate as anchor for day view
            let date = selDate ? new Date(selDate) : new Date(year, month, 1);
            // Clamp date to the correct month/year if needed
            if (date.getMonth() !== month || date.getFullYear() !== year) {
              date = new Date(year, month, 1);
              selectedDate = new Date(date);
            }
            todayDateCalendar.textContent = date.toLocaleDateString(undefined, {
              weekday: "long",
              month: "long",
              day: "numeric",
              year: "numeric",
            });

            let html = `<div class="calendar__dates__grid" style="display:grid;grid-template-columns:80px 1fr;height:auto;min-height:600px;">`;
            html += `<div style="background:transparent"></div>`;
            html += `<div style="font-weight:bold;color:#fff;text-align:center;padding:8px 0 8px 0;background:rgba(255,255,255,0.04);border-radius:10px;">${date.toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric" })}</div>`;
            for (let hour = 0; hour < 24; hour++) {
              let ampm = hour < 12 ? "AM" : "PM";
              let displayHour = hour % 12 === 0 ? 12 : hour % 12;
              html += `<div style="text-align:right;padding:6px 8px 6px 0;color:#ffe066;font-size:13px;opacity:.7">${displayHour}:00 ${ampm}</div>`;
              let isToday = date.toDateString() === new Date().toDateString();
              let classes = "calendar__dates_button";
              let style = "border-radius:8px;min-height:32px;";
              if (isToday) {
                classes += " calendar__dates__today";
                style += "background:rgba(99,0,238,0.548);";
              } else {
                style += "background:rgba(99,0,238,0.18);";
              }

              // Show events and birthdays for this hour
              let cellDate = new Date(date);
              cellDate.setHours(hour, 0, 0, 0);
              let dayEvents = events.filter((ev) => {
                let evDate = new Date(ev.date + (ev.time ? "T" + ev.time : ""));
                return (
                  evDate.getFullYear() === cellDate.getFullYear() &&
                  evDate.getMonth() === cellDate.getMonth() &&
                  evDate.getDate() === cellDate.getDate() &&
                  (ev.time ? evDate.getHours() === hour : true)
                );
              });
              let dayBirthdays = birthdays.filter((bd) => {
                let bdDate = new Date(bd.date);
                return (
                  bdDate.getMonth() === cellDate.getMonth() &&
                  bdDate.getDate() === cellDate.getDate()
                );
              });

              let content = "";
              dayEvents.forEach((ev) => {
                content += `<div style="font-size:12px;margin-top:2px;color:${ev.color};"><span style="display:inline-block;width:10px;height:10px;background:${ev.color};border-radius:50%;margin-right:4px;vertical-align:middle;"></span>${ev.title}</div>`;
              });
              dayBirthdays.forEach((bd) => {
                content += `<div style="font-size:12px;margin-top:2px;color:${bd.color};"><span style="display:inline-block;width:10px;height:10px;background:${bd.color};border-radius:50%;margin-right:4px;vertical-align:middle;"></span>🎂 ${bd.name}</div>`;
              });

              html += `<div class="${classes}" style="${style}">${content}</div>`;
            }
            html += `</div>`;
            calendarMainContent
              .querySelector(".calendar__content__header")
              .nextElementSibling?.remove();
            calendarMainContent.insertAdjacentHTML("beforeend", html);
          });
        };
        function renderCalendar(month, year) {
          // Header
          todayDateCalendar.textContent = new Date(year, month).toLocaleString(
            "default",
            { month: "long", year: "numeric" },
          );

          // Days grid
          const firstDay = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const holidaysThisMonth = showHolidays
            ? getHolidaysForMonth(month, year)
            : [];

          let html = `<div class="calendar__dates__grid">`;

          // Fill blanks for days before first day
          for (let i = 0; i < firstDay; i++) {
            html += `<div class="calendar__dates_button" style="opacity:.3;cursor:default"></div>`;
          }

          // Days of current month
          for (let d = 1; d <= daysInMonth; d++) {
            let isToday =
              d === today.getDate() &&
              month === today.getMonth() &&
              year === today.getFullYear();
            let holiday = holidaysThisMonth.find((h) => h.day === d);
            let classes = isToday
              ? "calendar__dates__today"
              : "calendar__dates_button";
            let holidayHtml = "";
            if (holiday) {
              classes += " liquid-glass";
              holidayHtml = `<div style="font-size:12px;color:#ffe066;margin-top:2px;">${holiday.name}</div>`;
            }
            html += `<div class="${classes}">${d}${holidayHtml}</div>`;
          }

          // Fill blanks for next month
          let totalCells = firstDay + daysInMonth;
          let nextDays = (7 - (totalCells % 7)) % 7;
          for (let i = 1; i <= nextDays; i++) {
            html += `<div class="calendar__dates_button" style="opacity:.3;cursor:default"></div>`;
          }

          html += `</div>`;
          calendarMainContent
            .querySelector(".calendar__content__header")
            .nextElementSibling?.remove();
          calendarMainContent.insertAdjacentHTML("beforeend", html);
        }

        // (Removed duplicate rerender function to avoid overwriting the week view logic)

        prevBtn.onclick = function () {
          if (currentView === "month" || currentView === "agenda") {
            // Go to previous month
            selectedDate.setMonth(selectedDate.getMonth() - 1);
            currentMonth = selectedDate.getMonth();
            currentYear = selectedDate.getFullYear();
          } else if (currentView === "week") {
            // Go to previous week
            selectedDate.setDate(selectedDate.getDate() - 7);
            currentMonth = selectedDate.getMonth();
            currentYear = selectedDate.getFullYear();
          } else if (currentView === "day") {
            // Go to previous day
            selectedDate.setDate(selectedDate.getDate() - 1);
            currentMonth = selectedDate.getMonth();
            currentYear = selectedDate.getFullYear();
          } else if (currentView === "year" || currentView === "timeline") {
            selectedDate.setFullYear(selectedDate.getFullYear() - 1);
            currentYear = selectedDate.getFullYear();
          }
          rerender();
        };
        nextBtn.onclick = function () {
          if (currentView === "month" || currentView === "agenda") {
            // Go to next month
            selectedDate.setMonth(selectedDate.getMonth() + 1);
            currentMonth = selectedDate.getMonth();
            currentYear = selectedDate.getFullYear();
          } else if (currentView === "week") {
            // Go to next week
            selectedDate.setDate(selectedDate.getDate() + 7);
            currentMonth = selectedDate.getMonth();
            currentYear = selectedDate.getFullYear();
          } else if (currentView === "day") {
            // Go to next day
            selectedDate.setDate(selectedDate.getDate() + 1);
            currentMonth = selectedDate.getMonth();
            currentYear = selectedDate.getFullYear();
          } else if (currentView === "year" || currentView === "timeline") {
            selectedDate.setFullYear(selectedDate.getFullYear() + 1);
            currentYear = selectedDate.getFullYear();
          }
          rerender();
        };
        showHolidaysCheckbox.onchange = function () {
          showHolidays = this.checked;
          rerender();
        };

        rerender();
      })();
      // Sidebar toggle logic for menu icon, with content shifting
      (function () {
        const menuBtn = document.getElementById("menu___btn");
        const sidebar = document.querySelector(".sidebar");
        const content = document.querySelector(".content");
        let sidebarVisible = true;
        let overlayDiv = null;

        function showSidebar() {
          sidebar.style.left = "0";
          sidebar.style.zIndex = "1000";
          sidebarVisible = true;
          if (window.innerWidth > 1025) {
            content.style.marginLeft = "280px";
            content.style.width = "calc(100% - 280px)";
          } else {
            content.style.marginLeft = "0";
            content.style.width = "100%";
            // Overlay for mobile/tablet
            if (!overlayDiv) {
              overlayDiv = document.createElement("div");
              overlayDiv.style.position = "fixed";
              overlayDiv.style.top = "60px";
              overlayDiv.style.left = "0";
              overlayDiv.style.width = "100vw";
              overlayDiv.style.height = "calc(100vh - 60px)";
              overlayDiv.style.background = "rgba(0,0,0,0.25)";
              overlayDiv.style.zIndex = "999";
              overlayDiv.onclick = hideSidebar;
              document.body.appendChild(overlayDiv);
            }
          }
        }

        function hideSidebar() {
          sidebar.style.left = "-300px";
          content.style.marginLeft = "0";
          content.style.width = "100%";
          if (overlayDiv) {
            overlayDiv.remove();
            overlayDiv = null;
          }
          sidebarVisible = false;
        }

        function toggleSidebar() {
          if (sidebarVisible) {
            hideSidebar();
          } else {
            showSidebar();
          }
        }

        // Responsive: reset sidebar on resize
        function handleResize() {
          if (window.innerWidth > 1025) {
            sidebar.style.left = "0";
            content.style.marginLeft = "280px";
            content.style.width = "calc(100% - 280px)";
            if (overlayDiv) {
              overlayDiv.remove();
              overlayDiv = null;
            }
            sidebarVisible = true;
          } else {
            sidebar.style.left = "-300px";
            content.style.marginLeft = "0";
            content.style.width = "100%";
            sidebarVisible = false;
          }
        }

        menuBtn.addEventListener("click", toggleSidebar);
        window.addEventListener("resize", handleResize);
        handleResize();
      })();

      // Mini Calendar Logic
      (function () {
        const miniCalendar = document.getElementById("miniCalendar");
        let today = new Date();
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();

        function getMonthName(month) {
          return today.toLocaleString("default", { month: "long" });
        }

        function renderMiniCalendar(month, year) {
          // Get first day of month
          const firstDay = new Date(year, month, 1).getDay();
          // Days in month
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          // Days in prev month
          const daysInPrevMonth = new Date(year, month, 0).getDate();

          // Header: Month/Year left, arrows right
          let html = `
            <div class="mini__calendar__arrows">
            <span class="mini__calendar__month-year">${new Date(year, month).toLocaleString("default", { month: "long" })} ${year}</span>
            <span>
                <span class="icon" id="miniPrevMonth">chevron_left</span>
                <span class="icon" id="miniNextMonth">chevron_right</span>
            </span>
            </div>
            <div class="mini__calendar__days">
        `;

          // Weekdays
          const weekdays = ["S", "M", "T", "W", "T", "F", "S"];
          for (let d = 0; d < 7; d++) {
            html += `<div class="mini__calendar__day" style="font-weight:bold;opacity:.7;cursor:default">${weekdays[d]}</div>`;
          }

          // Fill blanks for days before first day
          for (let i = 0; i < firstDay; i++) {
            html += `<div class="mini__calendar__day" style="opacity:.3;cursor:default">${daysInPrevMonth - firstDay + i + 1}</div>`;
          }

          // Days of current month
          for (let d = 1; d <= daysInMonth; d++) {
            let isToday =
              d === today.getDate() &&
              month === today.getMonth() &&
              year === today.getFullYear();
            html += `<div class="${isToday ? "mini__calendar__today" : "mini__calendar__day"}">${d}</div>`;
          }

          // Fill blanks for next month
          let totalCells = firstDay + daysInMonth + 7; // +7 for weekday row
          let nextDays = (7 - (totalCells % 7)) % 7;
          for (let i = 1; i <= nextDays; i++) {
            html += `<div class="mini__calendar__day" style="opacity:.3;cursor:default">${i}</div>`;
          }

          html += `</div>`;
          miniCalendar.innerHTML = html;

          // Attach arrow events
          document.getElementById("miniPrevMonth").onclick = () => {
            if (currentMonth === 0) {
              currentMonth = 11;
              currentYear--;
            } else {
              currentMonth--;
            }
            renderMiniCalendar(currentMonth, currentYear);
          };
          document.getElementById("miniNextMonth").onclick = () => {
            if (currentMonth === 11) {
              currentMonth = 0;
              currentYear++;
            } else {
              currentMonth++;
            }
            renderMiniCalendar(currentMonth, currentYear);
          };
        }

        renderMiniCalendar(currentMonth, currentYear);
      })();
      // Set today's date in the top left and update when month switches
      (function () {
        const todayDateSpan = document.getElementById("todayDate");
        function updateTodayDate() {
          const now = new Date();
          const options = {
            weekday: "long",
            month: "long",
            day: "numeric",
            year: "numeric",
          };
          todayDateSpan.textContent = now.toLocaleDateString(
            undefined,
            options,
          );
        }
        updateTodayDate();
      })();
      (function () {
        // Helper to generate a random string
        function randomStr(len = 20) {
          const chars =
            "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
          let str = "";
          for (let i = 0; i < len; i++) {
            str += chars.charAt(Math.floor(Math.random() * chars.length));
          }
          return str;
        }

        // Find all attributes starting with _ng-
        function shuffleNgAttributes() {
          const all = document.querySelectorAll("*");
          all.forEach((el) => {
            [...el.attributes].forEach((attr) => {
              if (attr.name.startsWith("_ng-")) {
                const newName = "_ng-" + randomStr(8);
                el.setAttribute(newName, "");
                el.removeAttribute(attr.name);
              }
            });
          });
        }

        shuffleNgAttributes();
      })();
      /**
       * Show a toast notification at the bottom center of the screen with a liquid glass effect.
       * @param {string} message - The message to display.
       * @param {object} [options] - Optional settings: { duration: ms, type: 'success'|'error'|'info' }
       */
      function showToast(message, options = {}) {
        // Remove any existing toast
        document.querySelectorAll(".munetios-toast").forEach((t) => t.remove());

        const toast = document.createElement("div");
        toast.className = "munetios-toast liquid-glass";
        toast.textContent = message;

        // Style
        toast.style.position = "fixed";
        toast.style.left = "50%";
        toast.style.bottom = "40px";
        toast.style.transform = "translateX(-50%)";
        toast.style.background =
          "linear-gradient(90deg, rgba(99,0,238,0.85) 60%, rgba(54,0,179,0.85) 100%)";
        toast.style.color = "#fff";
        toast.style.padding = "14px 32px";
        toast.style.borderRadius = "32px";
        toast.style.boxShadow = "0 4px 24px 0 rgba(31,38,135,0.18)";
        toast.style.fontSize = "16px";
        toast.style.fontWeight = "500";
        toast.style.zIndex = "999999";
        toast.style.opacity = "0";
        toast.style.transition = "opacity 0.25s";
        toast.style.backdropFilter =
          "blur(2px) saturate(180%) brightness(110%) contrast(105%)";
        toast.style.webkitBackdropFilter =
          "blur(2px) saturate(180%) brightness(110%) contrast(105%)";
        toast.style.border = "1px solid rgba(255,255,255,0.18)";

        // Type color
        if (options.type === "success") {
          toast.style.background =
            "linear-gradient(90deg, rgba(0,200,83,0.85) 60%, rgba(0,150,36,0.85) 100%)";
        } else if (options.type === "error") {
          toast.style.background =
            "linear-gradient(90deg, rgba(213,0,0,0.85) 60%, rgba(183,28,28,0.85) 100%)";
        } else if (options.type === "info") {
          toast.style.background =
            "linear-gradient(90deg, rgba(33,150,243,0.85) 60%, rgba(21,101,192,0.85) 100%)";
        }

        document.body.appendChild(toast);

        // Animate in
        setTimeout(() => {
          toast.style.opacity = "1";
        }, 10);

        // Remove after duration
        const duration = options.duration || 3000;
        setTimeout(() => {
          toast.style.opacity = "0";
          setTimeout(() => toast.remove(), 300);
        }, duration);

        // Click to dismiss
        toast.onclick = () => {
          toast.style.opacity = "0";
          setTimeout(() => toast.remove(), 300);
        };
      }
    </script>
  </body>
</html>
