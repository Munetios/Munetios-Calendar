<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meals - Munetios Calendar</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex:opsz,wght,ROND@6..144,1..1000,90&family=Google+Sans:ital,opsz,wght@0,17..18,400..700;1,17..18,400..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://api.munetios.com/beautiful-css/beautiful.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded">
    <style>
        body, button, textarea, input, select {
               font-family: 'Google Sans Flex', sans-serif;
            font-variation-settings:
  'wght' 480,
  'GRAD' 30,
  'ROND' 80,
  'opsz' 18;
        }
        body {
            margin: 0;
            background-color: #2d0266;
            color: white;
        }
        .topbar {
            height: 56px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 0 16px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
        }
        .top-right {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 24px;
            cursor: pointer;
        }
        .top-right .material-symbols-rounded {
            font-size: 24px;
        }
        .btn-text {
            font-size: 16px;
            font-weight: 500;
        }
        .top-right:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .content {
            margin-top: 56px;
            padding: 16px;
        }
        .asignments {
            margin-top: 16px;
        }
        .meals-content {
            margin-top: 16px;
        }
        .top-left {
            position: absolute;
            left: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 24px;
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="top-left liquid-glass">
            <span class="material-symbols-rounded">menu</span>
        </div>
        <div class="top-right liquid-glass">
            <span class="material-symbols-rounded">add</span>
            <div class="btn-text">Create</div>
        </div>
    </div>
    <div class="content" id="meals">

    </div>
    <script>
        function createSettingsModal() {
            if (document.getElementById("settings-modal-bg")) return;
            const modalBg = document.createElement("div");
            modalBg.id = "settings-modal-bg";
            modalBg.style.cssText = `
                position:fixed;top:0;left:0;right:0;bottom:0;
                background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:1000;
            `;
            // Get current theme from localStorage or system
            const currentTheme = localStorage.getItem("theme") || "system";
            modalBg.innerHTML = `
                <div class="liquid-glass" style="color:#fff;padding:24px 20px;border-radius:16px;min-width:260px;box-shadow:0 4px 32px #0002;display:flex;flex-direction:column;gap:18px;">
                    <div style="font-size:20px;font-weight:600;margin-bottom:8px;">Settings</div>
                    <div>
                        <div style="font-weight:500;margin-bottom:6px;">Theme</div>
                        <label style="display:block;margin-bottom:4px;">
                            <input type="radio" name="theme" value="system" ${currentTheme === "system" ? "checked" : ""}> System
                        </label>
                        <label style="display:block;margin-bottom:4px;">
                            <input type="radio" name="theme" value="dark" ${currentTheme === "dark" ? "checked" : ""}> Dark
                        </label>
                        <label style="display:block;">
                            <input type="radio" name="theme" value="light" ${currentTheme === "light" ? "checked" : ""}> Light
                        </label>
                    </div>
                    <button id="delete-all-meals" class="liquid-glass" style="margin-top:12px;padding:10px 15px;color:#fff;background:#d32f2f;border:none;cursor:pointer;font-weight:500;">Delete all meals</button>
                    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
                        <button id="settings-close" class="liquid-glass" style="padding: 10px 15px; cursor:pointer; color: white;">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modalBg);

            // Theme change logic
            modalBg.querySelectorAll('input[name="theme"]').forEach(radio => {
                radio.onchange = function() {
                    setTheme(this.value);
                };
            });

            // Close button
            document.getElementById("settings-close").onclick = () => modalBg.remove();

            // Delete all meals button
            document.getElementById("delete-all-meals").onclick = () => {
                showDeleteAllModal(modalBg);
            };
        }

        // Theme logic
        function setTheme(theme) {
            localStorage.setItem("theme", theme);
            applyTheme();
        }
        function applyTheme() {
            const theme = localStorage.getItem("theme") || "system";
            if (theme === "dark") {
                document.documentElement.style.backgroundColor = "#2d0266";
                document.body.style.backgroundColor = "#2d0266";
                document.body.style.color = "#fff";
            } else if (theme === "light") {
                document.documentElement.style.backgroundColor = "#fff";
                document.body.style.backgroundColor = "#fff";
                document.body.style.color = "#222";
            } else {
                // System
                if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
                    document.documentElement.style.backgroundColor = "#2d0266";
                    document.body.style.backgroundColor = "#2d0266";
                    document.body.style.color = "#fff";
                } else {
                    document.documentElement.style.backgroundColor = "#fff";
                    document.body.style.backgroundColor = "#fff";
                    document.body.style.color = "#222";
                }
            }
        }
        window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", () => {
            if ((localStorage.getItem("theme") || "system") === "system") applyTheme();
        });
        applyTheme();

        // Delete all meals modal
        function showDeleteAllModal(parentModalBg) {
            if (document.getElementById("delete-modal-bg")) return;
            const modalBg = document.createElement("div");
            modalBg.id = "delete-modal-bg";
            modalBg.style.cssText = `
                position:fixed;top:0;left:0;right:0;bottom:0;
                background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:1100;
            `;
            modalBg.innerHTML = `
                <div class="liquid-glass" style="color:#fff;padding:24px 20px;border-radius:16px;min-width:260px;box-shadow:0 4px 32px #0002;display:flex;flex-direction:column;gap:16px;">
                    <div style="font-size:18px;font-weight:600;margin-bottom:8px;">Delete all meals?</div>
                    <div style="color:#ffbdbd;">This will permanently remove all meals. This action cannot be undone.</div>
                    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
                        <button id="delete-cancel" class="liquid-glass" style="padding: 10px 15px; cursor:pointer; color: white;">Cancel</button>
                        <button id="delete-confirm" class="liquid-glass" style="padding: 10px 15px; cursor:pointer; color: white; background:#d32f2f;">Delete</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modalBg);

            document.getElementById("delete-cancel").onclick = () => modalBg.remove();
            document.getElementById("delete-confirm").onclick = async () => {
                await deleteAllMeals();
                modalBg.remove();
                if (parentModalBg) parentModalBg.remove();
                renderMeals();
                showToast("All meals deleted.", { type: "success" });
            };
        }

        // Delete all meals from IndexedDB
        function deleteAllMeals() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, "readwrite");
                const store = tx.objectStore(storeName);
                const req = store.clear();
                req.onsuccess = resolve;
                req.onerror = reject;
            });
        }

        // Menu icon click
        document.querySelector(".top-left").onclick = createSettingsModal;
        const mealTypes = ["Breakfast", "Lunch", "Dinner", "Snack"];
        const dbName = "mealsDB";
        const storeName = "meals";
        let db;

        // IndexedDB setup
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                request.onupgradeneeded = function(e) {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(storeName)) {
                        db.createObjectStore(storeName, { keyPath: "id", autoIncrement: true });
                    }
                };
                request.onsuccess = function(e) {
                    db = e.target.result;
                    resolve();
                };
                request.onerror = reject;
            });
        }

        function saveMeal(meal) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, "readwrite");
                const store = tx.objectStore(storeName);
                store.add(meal).onsuccess = resolve;
                tx.onerror = reject;
            });
        }

        function getMeals() {
            return new Promise((resolve, reject) => {
                const tx = db.transaction(storeName, "readonly");
                const store = tx.objectStore(storeName);
                const req = store.getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = reject;
            });
        }
        // Date helpers
        function getDaysOfMonth(year, month) {
            const days = [];
            const date = new Date(year, month, 1);
            while (date.getMonth() === month) {
            days.push(new Date(date));
            date.setDate(date.getDate() + 1);
            }
            // Move today to the top if it's in this month
            const today = new Date();
            if (today.getFullYear() === year && today.getMonth() === month) {
            const todayIndex = days.findIndex(d =>
                d.getFullYear() === today.getFullYear() &&
                d.getMonth() === today.getMonth() &&
                d.getDate() === today.getDate()
            );
            if (todayIndex > 0) {
                const [todayObj] = days.splice(todayIndex, 1);
                days.unshift(todayObj);
            }
            }
            return days;
        }

        // Modal
        function createModal() {
            if (document.getElementById("modal-bg")) return;
            const modalBg = document.createElement("div");
            modalBg.id = "modal-bg";
            modalBg.style.cssText = `
                position:fixed;top:0;left:0;right:0;bottom:0;
                background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:1000;
            `;
            modalBg.innerHTML = `
                <div class="liquid-glass" style="color:#fff;padding:24px 20px;border-radius:16px;min-width:260px;box-shadow:0 4px 32px #0002;display:flex;flex-direction:column;gap:16px;">
                    <div style="font-size:20px;font-weight:600;margin-bottom:8px;">Add Meal</div>
                    <label>
                        Date:
                        <input type="date" id="modal-date" style="margin-top:4px;">
                    </label>
                    <label>
                        Type:
                        <select id="modal-type" style="margin-top:4px;">
                            ${mealTypes.map(t => `<option>${t}</option>`).join("")}
                        </select>
                    </label>
                    <label>
                        Name:
                        <input type="text" id="modal-name" placeholder="Meal name" style="margin-top:4px;">
                    </label>
                    <div style="display:flex;gap:8px;justify-content:flex-end;">
                        <button id="modal-cancel" class="liquid-glass" style="padding: 10px 15px; cursor:pointer; color: white;">Cancel</button>
                        <button id="modal-save" class="liquid-glass" style="padding: 10px 15px; cursor:pointer; color: white;">Save</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modalBg);

            document.getElementById("modal-cancel").onclick = () => modalBg.remove();
            document.getElementById("modal-save").onclick = async () => {
                const date = document.getElementById("modal-date").value;
                const type = document.getElementById("modal-type").value;
                const name = document.getElementById("modal-name").value.trim();
                if (!date || !name) {
                    showToast("Please fill all fields.");
                    return;
                }
                await saveMeal({ date, type, name });
                modalBg.remove();
                renderMeals();
            };
        }

        // Render
        async function renderMeals() {
            const container = document.getElementById("meals");
            container.innerHTML = "";
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const days = getDaysOfMonth(year, month);
            const meals = await getMeals();

            const mealsByDay = {};
            meals.forEach(m => {
                if (!mealsByDay[m.date]) mealsByDay[m.date] = {};
                if (!mealsByDay[m.date][m.type]) mealsByDay[m.date][m.type] = [];
                mealsByDay[m.date][m.type].push(m.name);
            });

            const list = document.createElement("div");
            list.style.maxHeight = "calc(100vh - 72px)";
            days.forEach(day => {
                const dateStr = day.toISOString().slice(0,10);
                const dayDiv = document.createElement("div");
                dayDiv.style.marginBottom = "20px";
                dayDiv.innerHTML = `<div style="font-weight:600;font-size:18px;margin-bottom:6px;">${day.toLocaleDateString(undefined, { weekday: "long", month: "short", day: "numeric" })}</div>`;
                mealTypes.forEach(type => {
                    const mealList = (mealsByDay[dateStr] && mealsByDay[dateStr][type]) || [];
                    const mealItems = mealList.length ? mealList.map(n => `<li>${n}</li>`).join("") : `<li style="color:#bbb;">No ${type}</li>`;
                    dayDiv.innerHTML += `
                        <div style="margin-left:12px;margin-bottom:4px;">
                            <span style="font-weight:500;">${type}</span>
                            <ul style="margin:4px 0 0 16px;padding:0;list-style:disc;">
                                ${mealItems}
                            </ul>
                        </div>
                    `;
                });
                list.appendChild(dayDiv);
            });
            container.appendChild(list);
        }

        // Button
        document.querySelector(".top-right").onclick = createModal;

        // Init
        openDB().then(renderMeals);
            /**
         * Show a toast notification at the bottom center of the screen with a liquid glass effect.
         * @param {string} message - The message to display.
         * @param {object} [options] - Optional settings: { duration: ms, type: 'success'|'error'|'info' }
         */
        function showToast(message, options = {}) {
            // Remove any existing toast
            document.querySelectorAll('.munetios-toast').forEach(t => t.remove());

            const toast = document.createElement('div');
            toast.className = 'munetios-toast liquid-glass';
            toast.textContent = message;

            // Style
            toast.style.position = 'fixed';
            toast.style.left = '50%';
            toast.style.bottom = '40px';
            toast.style.transform = 'translateX(-50%)';
            toast.style.background = 'linear-gradient(90deg, rgba(99,0,238,0.85) 60%, rgba(54,0,179,0.85) 100%)';
            toast.style.color = '#fff';
            toast.style.padding = '14px 32px';
            toast.style.borderRadius = '32px';
            toast.style.boxShadow = '0 4px 24px 0 rgba(31,38,135,0.18)';
            toast.style.fontSize = '16px';
            toast.style.fontWeight = '500';
            toast.style.zIndex = '999999';
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.25s';
            toast.style.backdropFilter = 'blur(2px) saturate(180%) brightness(110%) contrast(105%)';
            toast.style.webkitBackdropFilter = 'blur(2px) saturate(180%) brightness(110%) contrast(105%)';
            toast.style.border = '1px solid rgba(255,255,255,0.18)';

            // Type color
            if (options.type === 'success') {
                toast.style.background = 'linear-gradient(90deg, rgba(0,200,83,0.85) 60%, rgba(0,150,36,0.85) 100%)';
            } else if (options.type === 'error') {
                toast.style.background = 'linear-gradient(90deg, rgba(213,0,0,0.85) 60%, rgba(183,28,28,0.85) 100%)';
            } else if (options.type === 'info') {
                toast.style.background = 'linear-gradient(90deg, rgba(33,150,243,0.85) 60%, rgba(21,101,192,0.85) 100%)';
            }

            document.body.appendChild(toast);

            // Animate in
            setTimeout(() => { toast.style.opacity = '1'; }, 10);

            // Remove after duration
            const duration = options.duration || 3000;
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, duration);

            // Click to dismiss
            toast.onclick = () => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            };
        }
        
    </script>
</body>
</html>